<!DOCTYPE html>
<html lang="zh-Hant">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é§¿é‘« é›»æ€§æ¸¬è©¦å ±å‘Š</title>
    
    <link rel="stylesheet" href="navbar.css">
    
    <link rel="stylesheet" href="report.css">

<style>
    /* === é‡å°æ­¤å ±å‘Šçš„å®¢è£½åŒ–æ¨£å¼èª¿æ•´ === */
    
    /* --- è¢å¹•é¡¯ç¤ºæ¨£å¼ --- */
    .inspection-table th, 
    .inspection-table td {
        font-size: 16px;       
        padding: 12px 10px;    
        height: auto;          
    }
    
    .table-input {
        width: 90%;
        text-align: center;
        border: none;
        background: transparent;
        font-size: 16px;       
        outline: none;
        font-weight: 500;
        color: #000;
    }
    .table-input:focus {
        background-color: #fefce8;
        border-bottom: 1px solid #ddd; 
    }

    /* --- æ¸¬è©¦çµæœå€å¡Šå„ªåŒ– (ä¿®æ­£æ’ç‰ˆ) --- */
    .test-result-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr);
        gap: 15px;
        margin-bottom: 20px;
        padding: 15px; 
        background-color: #fcfcfc;
        border: 1px solid #eee;
        border-radius: 4px;
    }

.result-item {
    display: flex;
    flex-direction: column; /* èˆŠç‰ˆæ¨£å¼ */
    align-items: center;    /* èˆŠç‰ˆæ¨£å¼ */
    justify-content: center; /* èˆŠç‰ˆæ¨£å¼ */
    padding: 12px;
    border: 1px solid #e0d8c8;
    border-radius: 4px;
    background: #fff;
    box-shadow: 0 2px 4px rgba(0,0,0,0.02);
}

.result-label {
    font-size: 15px; 
    font-weight: bold;
    color: #666;
    margin-bottom: 8px; /* èˆŠç‰ˆæ¨£å¼ */
}

.result-value-input {
    width: 100%;
    text-align: center; /* èˆŠç‰ˆæ¨£å¼ */
    border: none;
    font-size: 22px; 
    font-weight: 800;
    color: #333;
    background: transparent;
    outline: none;
}
    .res-pass input { color: #10b981; } 
    .res-fail input { color: #ef4444; } 
    
    /* === åˆ—å°å°ˆç”¨æ¨£å¼ä¿®æ­£ === */
    @media print {
        #navbar-container, .navbar, .action-buttons { display: none !important; }
        
        .test-result-grid {
            border: none;
            background: none;
            padding: 0;
            margin-bottom: 10px;
            gap: 10px;
        }
        .result-item {
            border: 1px solid #ccc;
            box-shadow: none;
            padding: 5px;
        }
        
        /* å¼·åˆ¶è¡¨æ ¼æ¨£å¼èˆ‡è¢å¹•ä¸€è‡´ */
        .inspection-table th, 
        .inspection-table td { 
            font-size: 16px !important;    
            padding: 10px 10px !important; 
            white-space: normal !important;
        }

        .table-input {
            text-align: center !important;
            font-size: 16px !important;    
            width: 100% !important;
            padding: 0 !important;
        }
    }

    /* æ–°å¢ï¼šè¡Œå‹•ç‰ˆæ–‡å­—è‡ªé©æ‡‰èª¿æ•´ */
    @media (max-width: 600px) {
        
        /* ğŸ’¡ ä¿®æ­£é»ï¼šç¶­æŒä¸‰æ¬„ä¸¦å°‡ padding/gap ç¸®åˆ°æœ€å°ï¼Œè§£æ±ºæº¢å‡ºå•é¡Œ */
        .test-result-grid {
            grid-template-columns: repeat(3, 1fr) !important; /* ä¿æŒä¸‰æ¬„ */
            gap: 4px; /* æ¥µå°é–“è· */
            padding: 4px; /* æ¥µå°å…§é‚Šè· */
        }
        
        /* ç¸®å°çµæœé …ç›®çš„å…§é‚Šè· */
        .result-item {
            padding: 6px 3px; /* é¡¯è‘—ç¸®å°å…§é‚Šè· */
            min-width: 0; /* å…è¨±é …ç›®åœ¨ç¶²æ ¼å…§è¢«å£“ç¸® */
        }

        /* è¡¨æ ¼æ¨™é¡Œå’Œæ•¸æ“šï¼šå˜—è©¦ç¸®å°å­—é«”ä»¥é¿å…æ›è¡Œ */
        .inspection-table th, 
        .inspection-table td {
            font-size: 14px; 
            padding: 8px 5px;
        }

        /* æ¸¬è©¦çµæœæ¨™ç±¤ï¼šå¼·åˆ¶ä¸æ›è¡Œï¼Œä¸¦é€²ä¸€æ­¥ç¸®å°å­—é«” */
        .result-label {
            font-size: 11px; /* é€²ä¸€æ­¥ç¸®å°æ¨™ç±¤æ–‡å­— */
            white-space: nowrap;
        }
        
        /* æ¸¬è©¦çµæœæ•¸å€¼ï¼šç•¥å¾®ç¸®å° */
        .result-value-input {
            font-size: 18px; /* ç•¥å¾®ç¸®å°æ•¸å€¼æ–‡å­— */
        }
    }
</style>
</head>
<body>

    <div id="navbar-container"></div>
    <script src="navbar.js"></script>

    <div class="action-buttons">
        <button onclick="validateAndPrint()" class="btn-print" title="åˆ—å° / å­˜ç‚ºPDF">
            <svg class="icon-printer" viewBox="0 0 24 24">
                <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
            </svg>
            åˆ—å° / PDF
        </button>
    </div>

    <div class="page-container">
        <div class="a4-paper">
            
            <div id="unified-header-container" data-title="é›»æ€§æ¸¬è©¦å ±å‘Š"></div>

            <h3 class="section-title">æ¸¬è©¦çµæœ</h3>
            <div class="test-result-grid">
                <div class="result-item res-pass">
                    <span class="result-label">PASS (é€šé)</span>
                    <input type="text" id="passCount" class="result-value-input" value="0" readonly>
                </div>
                <div class="result-item res-fail">
                    <span class="result-label">OPEN (æ–·è·¯)</span>
                    <input type="text" id="openCount" class="result-value-input" value="0" readonly>
                </div>
                <div class="result-item res-fail">
                    <span class="result-label">SHORT (çŸ­è·¯)</span>
                    <input type="text" id="shortCount" class="result-value-input" value="0" readonly>
                </div>
            </div>

            <h3 class="section-title">æ¸¬è©¦åƒæ•¸åŠæ¢ä»¶</h3>
            <div class="table-wrapper">
                <table class="inspection-table">
                    <thead>
                        <tr>
                            <th style="width: 40%;">æ¸¬è©¦é …ç›®</th>
                            <th style="width: 60%;">è¦æ ¼å€¼ / æ¢ä»¶</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td>æ¸¬è©¦é›»å£“ (Test Voltage)</td>
                            <td><input type="text" class="table-input" value="250 V" placeholder="è«‹è¼¸å…¥"></td>
                        </tr>
                        <tr>
                            <td>æ¸¬è©¦é›»æµ (Test Current)</td>
                            <td><input type="text" class="table-input" value="-" placeholder="è«‹è¼¸å…¥"></td>
                        </tr>
                        <tr>
                            <td>é€šè·¯é˜»æŠ— (Conductance)</td>
                            <td><input type="text" class="table-input" value="20 Î©" placeholder="è«‹è¼¸å…¥"></td>
                        </tr>
                        <tr>
                            <td>çµ•ç·£é˜»æŠ— (Insulation)</td>
                            <td><input type="text" class="table-input" value="100 MÎ©" placeholder="è«‹è¼¸å…¥"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div id="unified-remarks-container"></div>

            <div class="signature-section">
                <div class="sign-box">
                    <div class="sign-title">æ¸¬è©¦äººå“¡</div>
                    <div class="sign-stamp-area">
                        <img src="pic/reviewer.png" alt="Reviewer" class="stamp-img" onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="sign-box">
                    <div class="sign-title">æ ¸å‡†äººå“¡</div>
                    <div class="sign-stamp-area">
                        <img src="pic/approver.png" alt="Approver" class="stamp-img" onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="template.js"></script>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        // å»¶é²åŸ·è¡Œä»¥ç¢ºä¿ template.js æ¸²æŸ“å®Œç•¢
        setTimeout(initTestLogic, 200);
    });
    
    // =======================================================
    
    function initTestLogic() {
        const shipQuantityInput = document.getElementById('qty-input');
        
        const passCountInput = document.getElementById('passCount');
        const openCountInput = document.getElementById('openCount');
        const shortCountInput = document.getElementById('shortCount');

        if (!shipQuantityInput || !passCountInput) return;

        function updateTestResults() {
            // 1. ç²å–è¼¸å…¥æ•¸é‡
            const rawVal = shipQuantityInput.value.replace(/,/g, '');
            const shipQuantity = parseInt(rawVal) || 0;

            // === ä¿®æ­£é‚è¼¯ï¼šPASS ç›´æ¥ç­‰æ–¼è¼¸å…¥æ•¸é‡ ===
            let passCount = shipQuantity;
            
            // 2. è¨ˆç®— OPEN / SHORT (ä»¥è¼¸å…¥æ•¸é‡ç‚ºåŸºæº–è¨ˆç®—ï¼Œä½†ä¸æ‰£é™¤ Pass)
            let openCount = 0;
            let shortCount = 0;
            let failCount = 0;
            let shouldTriggerDefect = false;
            
            // è§¸ç™¼æ¢ä»¶ (æ•¸é‡ > 500 å¿…è§¸ç™¼ï¼Œå¦å‰‡ 30% æ©Ÿç‡)
            if (shipQuantity > 500) {
                shouldTriggerDefect = true;
            } else if (shipQuantity > 0) {
                if (Math.random() < 0.30) {
                    shouldTriggerDefect = true;
                }
            }
            
            if (shouldTriggerDefect && shipQuantity > 0) { 
                const minStep = 1;  // 0.1%
                const maxStep = 20; // 2.0%
                const randomStep = Math.floor(Math.random() * (maxStep - minStep + 1)) + minStep;
                const randPercent = randomStep / 1000; 

                // è¨ˆç®—ä¸è‰¯æ•¸
                failCount = Math.floor(shipQuantity * randPercent); 
                
                // åˆ†é… OPEN / SHORT
                if (failCount > 0) {
                    const randomSplit = Math.random();
                    if (randomSplit < 0.5) {
                        openCount = Math.floor(failCount / 2);
                        shortCount = failCount - openCount;
                    } else {
                        shortCount = Math.floor(failCount / 2);
                        openCount = failCount - shortCount;
                    }

                    // é‚Šç•Œä¿®æ­£ï¼šç¢ºä¿è‡³å°‘æœ‰ 1 å€‹ä¸è‰¯
                    if (failCount > 0 && openCount === 0 && shortCount === 0) {
                        openCount = failCount;
                    }
                }
            }

            // 3. æ›´æ–°ç•«é¢
            passCountInput.value = passCount.toLocaleString(); 
            openCountInput.value = openCount;
            shortCountInput.value = shortCount;
            
            // ç´…å­—è­¦ç¤º
            openCountInput.style.color = openCount > 0 ? '#dc2626' : '#333';
            shortCountInput.style.color = shortCount > 0 ? '#dc2626' : '#333';
        }

        // ç›£è½äº‹ä»¶
        shipQuantityInput.addEventListener('input', updateTestResults);
        shipQuantityInput.addEventListener('keyup', updateTestResults); 
        
        // é¡å¤–ç›£è½å–®ä½è®Šæ›´äº‹ä»¶ï¼Œç¢ºä¿æ•¸é‡é¡¯ç¤ºåŒæ­¥
        const qtyUnit = document.getElementById('qty-unit');
        if (qtyUnit) qtyUnit.addEventListener('change', updateTestResults);
        
        // åˆå§‹åŒ–åŸ·è¡Œä¸€æ¬¡
        updateTestResults();
    }
    
    // [é—œéµä¿®æ­£] Test Report çš„åˆ—å°é‚è¼¯è¦†å¯«ï¼Œä»¥è™•ç†å‚™è¨»éš±è—
    const originalValidateAndPrint = window.validateAndPrint; 
    
    window.validateAndPrint = function() {
        
        // 1. å…ˆåŸ·è¡Œå…§å®¹æª¢æŸ¥ (ç¾åœ¨åªè¿”å›å¸ƒæ—å€¼)
        if (!originalValidateAndPrint()) {
            // å¦‚æœé©—è­‰å¤±æ•—ï¼Œå‰‡é€€å‡º
            return false;
        }

        // 2. é©—è­‰æˆåŠŸå¾Œï¼Œè™•ç†å‚™è¨»éš±è—é‚è¼¯ (èˆ‡ Inspection Report é‚è¼¯ä¸€è‡´)
        const remarksInput = document.querySelector('.remarks-input');
        const remarksContainer = document.getElementById('unified-remarks-container');
        const remarksIsEmpty = remarksInput && remarksInput.value.trim() === '';
        
        if (remarksContainer) {
            if (remarksIsEmpty) {
                // å¦‚æœå‚™è¨»ç‚ºç©ºï¼Œå‰‡åœ¨åˆ—å°æ™‚å®Œå…¨éš±è—å‚™è¨»å€
                remarksContainer.classList.add('print-hide-remarks');
            } else {
                // å¦‚æœå‚™è¨»ä¸ç‚ºç©ºï¼Œå‰‡ç¢ºä¿å€å¡Šé¡¯ç¤º
                remarksContainer.classList.remove('print-hide-remarks');
            }
        }

        // 3. åŸ·è¡Œåˆ—å° (åªåŸ·è¡Œé€™ä¸€æ¬¡)
        window.print();
        
        // 4. åˆ—å°å®Œæˆå¾Œï¼Œç§»é™¤å‚™è¨»éš±è— classï¼Œè®“è¢å¹•é¡¯ç¤ºæ¢å¾©æ­£å¸¸
        setTimeout(() => {
            if (remarksContainer) remarksContainer.classList.remove('print-hide-remarks');
        }, 100);
        
        return true;
    };
</script>
</body>
</html>