<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é§¿é‘« å‡ºè²¨æª¢é©—å ±å‘Š</title>
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="report.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        .section-header-wrapper { display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; padding-right: 5px; flex-wrap: wrap; gap: 5px; }
        .section-header-wrapper .section-title { margin-bottom: 0; }
        .standard-badge { font-size: 13px; color: #333; background-color: var(--label-bg); padding: 5px 12px; border-radius: 20px; font-weight: 600; border: 1px solid var(--border-color); letter-spacing: 0.5px; }
        .final-decision-box { margin-top: 15px; margin-bottom: 20px; padding: 15px; border: 1px solid #e5e7eb; border-radius: 8px; background-color: #fff; display: flex; align-items: center; justify-content: space-between; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .decision-label { font-size: 16px; font-weight: 700; color: #374151; }
        .result-badge { font-size: 18px; font-weight: 800; padding: 8px 30px; border-radius: 4px; letter-spacing: 2px; text-transform: uppercase; transition: all 0.3s ease; text-align: center; min-width: 150px; box-sizing: border-box; }
        .status-pending { background-color: #f3f4f6; color: #9ca3af; border: 1px dashed #d1d5db; }
        .status-pass { background-color: #ecfdf5; color: #059669; border: 2px solid #059669; box-shadow: 0 0 5px rgba(5, 150, 105, 0.2); }
        .status-fail { background-color: #fef2f2; color: #dc2626; border: 2px solid #dc2626; box-shadow: 0 0 5px rgba(220, 38, 38, 0.2); }
        .wrapper-toggle { display: flex; align-items: center; width: 100%; position: relative; }
        .toggle-input-box { width: 100%; display: flex; align-items: center; flex: 1; }
        .reset-btn { cursor: pointer; font-size: 18px; color: #999; padding: 0 8px; line-height: 1; font-weight: bold; user-select: none; }
        .reset-btn:hover { color: red; }
        .editable-cell { min-width: 50px; display: inline-block; padding: 2px 5px; outline: none; border-bottom: 1px dashed #ccc; text-align: center; background: transparent; }
        .editable-cell:focus { border-bottom: 1px solid #b38728; background-color: #fffdf5; }
        .tolerance-display { font-size: 0.85em; color: #666; margin-left: 4px; white-space: nowrap; }
        @media print {
            .reset-btn { display: none !important; } input { border: none !important; background: transparent !important; } .editable-cell { border-bottom: 1px dashed #000 !important; } body { padding-top: 0; } .page-container { margin-top: 0; } .standard-badge { border: 1px solid #999; color: #000; } .print-hidden-row { display: none !important; } .result-badge { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; } .status-pass { background-color: #ecfdf5 !important; color: #059669 !important; border: 2px solid #059669 !important; } .status-fail { background-color: #fef2f2 !important; color: #dc2626 !important; border: 2px solid #dc2626 !important; } .status-pending { display: none; } .final-decision-box { border: 1px solid #e5e7eb; }
        }
        @media (max-width: 768px) { .final-decision-box { flex-direction: row; gap: 10px; } .decision-label { white-space: nowrap; } .result-badge { min-width: auto; padding: 8px 15px; } }
    </style>
</head>
<body>
    <div id="navbar-container"></div>
    <div class="page-container">
        <div class="action-buttons">
            <button class="btn-print" onclick="validateAndPrint()">
                <svg class="icon-printer" viewBox="0 0 24 24"><path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/></svg>
                åˆ—å°
            </button>
            <button class="btn-pdf" onclick="downloadPDF()">
                <svg class="icon-printer" viewBox="0 0 24 24" fill="currentColor"><path d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z"/></svg>
                ç”Ÿæˆ PDF
            </button>
        </div>

        <div class="a4-paper">
            <div id="unified-header-container" data-title="å‡ºè²¨æª¢é©—å ±å‘Š"></div>
            <h3 class="section-title">PCB è¦æ ¼</h3>
            <section class="info-grid grid-pcb" id="pcb-spec-section">
                <div class="info-item span-standard"><span class="label">æ¿æ</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="material-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="FR-4">FR-4</option><option value="FR-1">FR-1</option><option value="é‹åŸºæ¿">é‹åŸºæ¿</option><option value="éŠ…åŸºæ¿">éŠ…åŸºæ¿</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="material-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥æ¿æ" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                <div class="info-item span-standard"><span class="label">å±¤åˆ¥</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="layer-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="å–®é¢æ¿">å–®é¢æ¿</option><option value="é›™é¢æ¿">é›™é¢æ¿</option><option value="å››å±¤æ¿">å››å±¤æ¿</option><option value="å…­å±¤æ¿">å…­å±¤æ¿</option><option value="å…«å±¤æ¿">å…«å±¤æ¿</option><option value="åå±¤æ¿">åå±¤æ¿</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="layer-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥å±¤åˆ¥" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                <div class="info-item span-standard"><span class="label">æ¿åš</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="thickness-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="0.4 mm">0.4 mm</option><option value="0.6 mm">0.6 mm</option><option value="0.8 mm">0.8 mm</option><option value="1.0 mm">1.0 mm</option><option value="1.2 mm">1.2 mm</option><option value="1.6 mm">1.6 mm</option><option value="2.0 mm">2.0 mm</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="thickness-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥æ¿åš" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                <div class="info-item span-standard"><span class="label">éŠ…åš</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="copper-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="1 oz">1 oz</option><option value="2 oz">2 oz</option><option value="3 oz">3 oz</option><option value="4 oz">4 oz</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="copper-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥éŠ…åš" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                <div class="info-item span-standard"><span class="label">é˜²ç„Š</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="mask-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="ç¶ è‰²">ğŸŸ¢ ç¶ è‰²</option><option value="ç™½è‰²">âšª ç™½è‰²</option><option value="ç´…è‰²">ğŸ”´ ç´…è‰²</option><option value="é»‘è‰²">âš« é»‘è‰²</option><option value="è—è‰²">ğŸ”µ è—è‰²</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="mask-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥é¡è‰²" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                <div class="info-item span-standard"><span class="label">æ–‡å­—</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="legend-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="ç™½è‰²">âšª ç™½è‰²</option><option value="é»‘è‰²">âš« é»‘è‰²</option><option value="ç„¡æ–‡å­—">ç„¡æ–‡å­—</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="legend-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥é¡è‰²" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                <div class="info-item span-standard"><span class="label">ç„Šç›¤</span><div class="input-group wrapper-toggle"><select class="unit-select toggle-select" data-target="surface-input-group" onchange="checkCompletion()"><option value="" disabled selected hidden>è«‹é¸æ“‡</option><option value="æœ‰é‰›å™´éŒ«">æœ‰é‰›å™´éŒ«</option><option value="ç„¡é‰›å™´éŒ«">ç„¡é‰›å™´éŒ«</option><option value="åŒ–é‡‘ 1u">åŒ–é‡‘ 1u"</option><option value="åŒ–é‡‘ 2u">åŒ–é‡‘ 2u"</option><option value="åŒ–é‡‘ 3u">åŒ–é‡‘ 3u"</option><option value="ç¡¬é‡‘ 3u">ç¡¬é‡‘ 3u"</option><option value="ç¡¬é‡‘ 5u">ç¡¬é‡‘ 5u"</option><option value="OSP">OSP</option><option value="è£¸éŠ…">è£¸éŠ…</option><option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option></select><div class="input-group toggle-input-box" id="surface-input-group" style="display: none;"><input type="text" class="input-line" placeholder="è¼¸å…¥è™•ç†" oninput="checkCompletion()"><span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div></div></div>
                
                <div class="info-item desktop-spacer"></div>

                <div class="info-item span-half">
                    <span class="label">å°ºå¯¸</span>
                    <div class="input-group" style="gap: 5px;">
                        <input type="text" id="dim-length-input" class="input-line split-input" placeholder="é•·" oninput="updateSpecs(); checkCompletion();">
                        <span>x</span>
                        <input type="text" id="dim-width-input" class="input-line split-input" placeholder="å¯¬" oninput="updateSpecs(); checkCompletion();">
                        <span class="unit-display-text" style="font-size: 12px; color: #666; white-space: nowrap;">mm</span>
                    </div>
                </div>

                <div class="info-item span-half">
                    <span class="label">æ’ç‰ˆ</span>
                    <div class="input-group" style="gap: 5px;">
                        <input type="text" id="pnl-x" class="input-line split-input" placeholder="X" oninput="checkCompletion()">
                        <span>x</span>
                        <input type="text" id="pnl-y" class="input-line split-input" placeholder="Y" oninput="checkCompletion()">
                        <span class="unit-display-text" style="flex-shrink: 0; width: 65px; font-size: 12px; font-weight: 600; text-align: center;">PCS / PNL</span>
                    </div>
                </div>
            </section>

            <table class="print-only-table" id="print-pcb-specs"><tr><th>æ¿ã€€ã€€æ</th><td id="print-material"></td><th>å±¤ã€€ã€€åˆ¥</th><td id="print-layer"></td><th>æ¿ã€€ã€€åš</th><td id="print-thickness"></td></tr><tr><th>éŠ…ã€€ã€€åš</th><td id="print-copper"></td><th>é˜²ã€€ã€€ç„Š</th><td id="print-mask"></td><th>æ–‡ã€€ã€€å­—</th><td id="print-legend"></td></tr><tr><th>ç„Šã€€ã€€ç›¤</th><td id="print-surface"></td><th>å‡ºè²¨å°ºå¯¸</th><td id="print-dim"></td><th>æ’ç‰ˆè¦æ ¼</th><td id="print-array"></td></tr></table>
            <div class="section-header-wrapper"><h3 class="section-title">æª¢é©—æ•¸æ“š</h3><span class="standard-badge">æŠ½æ¨£æ¨™æº–: MIL-STD-105D</span></div>
            <div class="table-wrapper">
                <table class="inspection-table" id="inspection-data-table">
                    <thead><tr><th style="min-width: 80px;">é …ç›®</th><th style="min-width: 100px;">è¦æ ¼ (mm)</th><th>æ¨£æœ¬ A</th><th>æ¨£æœ¬ B</th><th>æ¨£æœ¬ C</th><th>æ¨£æœ¬ D</th><th>æ¨£æœ¬ E</th><th style="min-width: 60px;">åˆ¤å®š</th></tr></thead>
                    <tbody>
                        <tr data-item="length"><td>é•·åº¦</td><td><span contenteditable="true" class="editable-cell" id="spec-length-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.2">0.2</span></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td class="judgment-field" style="font-weight:bold;"></td> </tr>
                        <tr data-item="width"><td>å¯¬åº¦</td><td><span contenteditable="true" class="editable-cell" id="spec-width-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.2">0.2</span></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> <td class="judgment-field" style="font-weight:bold;"></td> </tr>
                        <tr id="row-hole-1"><td>å­”å¾‘ A</td><td><span contenteditable="true" class="editable-cell placeholder-text" id="spec-hole1-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td class="judgment-field" style="font-weight:bold;"></td></tr>
                        <tr id="row-hole-2"><td>å­”å¾‘ B</td><td><span contenteditable="true" class="editable-cell placeholder-text" id="spec-hole2-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td class="judgment-field" style="font-weight:bold;"></td></tr>
                        <tr id="row-hole-3"><td>å­”å¾‘ C</td><td><span contenteditable="true" class="editable-cell placeholder-text" id="spec-hole3-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td><td class="judgment-field" style="font-weight:bold;"></td></tr>
                    </tbody>
                </table>
            </div>

            <div class="final-decision-box"><span class="decision-label">åˆ¤å®šçµæœ:</span><div id="final-decision-badge" class="result-badge status-pending">ç­‰å¾…æ•¸æ“š...</div></div>
            <div id="unified-remarks-container"></div>
            <div class="signature-section">
                <div class="sign-box"><div class="sign-title">æª¢é©—äººå“¡</div><div class="sign-stamp-area"><img src="pic/reviewer.png" alt="æª¢é©—äººå“¡" class="stamp-img"></div></div>
                <div class="sign-box"><div class="sign-title">æ ¸å‡†äººå“¡</div><div class="sign-stamp-area"><img src="pic/approver.png" alt="æ ¸å‡†äººå“¡" class="stamp-img"></div></div>
            </div>
        </div> 
    </div> 

    <script src="navbar.js"></script>
    <script src="template.js"></script>

    <script>
        let hasUserInteracted = false;

        window.validateAndPrint = function(onlyValidate = false) {
            let isComplete = true;
            const basicIds = ['ui-client', 'ui-partno', 'qty-input'];
            basicIds.forEach(id => { const el = document.getElementById(id); if (el && el.value.trim() === '') { el.classList.add('input-error'); isComplete = false; } else if (el) { el.classList.remove('input-error'); } });
            const cycleSelect = document.getElementById('cycle-select');
            const cycleInput = document.getElementById('cycle-input');
            if (cycleSelect) {
                 if (cycleSelect.value === '' || cycleSelect.value === 'è«‹é¸æ“‡') { cycleSelect.classList.add('input-error'); isComplete = false; } 
                 else if (cycleSelect.value === 'has' && cycleInput && cycleInput.value.trim() === '') { cycleInput.classList.add('input-error'); isComplete = false; } 
                 else { cycleSelect.classList.remove('input-error'); if(cycleInput) cycleInput.classList.remove('input-error'); }
            }
            const pcbSection = document.getElementById('pcb-spec-section');
            if (pcbSection) {
                const selects = pcbSection.querySelectorAll('select');
                selects.forEach(sel => {
                    const wrapper = sel.closest('.wrapper-toggle');
                    const inputGroup = wrapper ? wrapper.querySelector('.toggle-input-box') : null;
                    const input = inputGroup ? inputGroup.querySelector('input') : null;
                    if (inputGroup && inputGroup.style.display !== 'none') { if (input && input.value.trim() === '') { input.classList.add('input-error'); isComplete = false; } else if (input) { input.classList.remove('input-error'); } } else { if (sel.value === '' || sel.value === 'è«‹é¸æ“‡') { sel.classList.add('input-error'); isComplete = false; } else { sel.classList.remove('input-error'); } }
                });
                const numericInputs = pcbSection.querySelectorAll('#dim-length-input, #dim-width-input, #pnl-x, #pnl-y');
                numericInputs.forEach(inp => { if (inp.value.trim() === '') { inp.classList.add('input-error'); isComplete = false; } else { inp.classList.remove('input-error'); } });
            }
            const nominalSpecA = document.getElementById('spec-hole1-nominal');
            if (nominalSpecA && nominalSpecA.textContent.trim() === '') { nominalSpecA.classList.add('input-error'); isComplete = false; } else if (nominalSpecA) { nominalSpecA.classList.remove('input-error'); }

            if (!isComplete) { alert("è«‹å¡«å¯«æ‰€æœ‰æ¨™ç¤ºç´…æ¡†çš„å¿…å¡«æ¬„ä½ï¼"); return false; }

            syncPcbSpecs();
            prepareRowsForPrint();

            const remarksInput = document.querySelector('.remarks-input');
            const remarksContainer = document.getElementById('unified-remarks-container');
            if (remarksContainer) { if (remarksInput && remarksInput.value.trim() === '') { remarksContainer.classList.add('print-hide-remarks'); } else { remarksContainer.classList.remove('print-hide-remarks'); } }

            if (onlyValidate) return true;

            window.print();
            setTimeout(() => { document.querySelectorAll('.print-hidden-row').forEach(row => row.classList.remove('print-hidden-row')); if (remarksContainer) remarksContainer.classList.remove('print-hide-remarks'); if (nominalSpecA) nominalSpecA.classList.remove('input-error'); }, 100);
            return true;
        };

        window.downloadPDF = function() {
            if (typeof html2pdf === 'undefined') { alert("PDF ç”Ÿæˆå…ƒä»¶å°šæœªè¼‰å…¥å®Œæˆ"); return; }
            if (!window.validateAndPrint(true)) return;

            const client = document.getElementById('ui-client').value || 'å®¢æˆ¶';
            const partNo = document.getElementById('ui-partno').value || 'æ–™è™Ÿ';
            const reportTitle = document.getElementById('unified-header-container').getAttribute('data-title') || 'å‡ºè²¨æª¢é©—å ±å‘Š';
            const safePartNo = partNo.replace(/[\/\\:*?"<>|]/g, '_');
            const fileName = `${client} ${safePartNo} ${reportTitle}.pdf`;
            const element = document.querySelector('.a4-paper');

            // [é—œéµä¿®æ­£] æš«æ™‚ç§»é™¤åœ–ç‰‡ srcï¼Œé¿å… Tainted Canvas éŒ¯èª¤
            const images = document.querySelectorAll('img');
            const savedSrcs = [];
            images.forEach((img, i) => {
                savedSrcs[i] = img.src;
                img.removeAttribute('src'); // ç§»é™¤ src
            });

            const opt = { margin: 0, filename: fileName, image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2, useCORS: true, scrollY: 0 }, jsPDF: { unit: 'mm', format: 'a4', orientation: 'portrait' } };

            document.body.classList.add('printing-pdf');
            
            html2pdf().set(opt).from(element).save().then(function(){
                document.body.classList.remove('printing-pdf');
                document.querySelectorAll('.print-hidden-row').forEach(row => row.classList.remove('print-hidden-row'));
                const remarksContainer = document.getElementById('unified-remarks-container');
                if (remarksContainer) remarksContainer.classList.remove('print-hide-remarks');
                
                // é‚„åŸåœ–ç‰‡
                images.forEach((img, i) => { img.src = savedSrcs[i]; });
            }).catch(function(err) {
                console.error(err);
                alert("PDF ç”Ÿæˆå¤±æ•—: " + err.message);
                document.body.classList.remove('printing-pdf');
                // é‚„åŸåœ–ç‰‡
                images.forEach((img, i) => { img.src = savedSrcs[i]; });
            });
        }

        // ... å…¶é¤˜å‡½æ•¸ ...
        function syncPcbSpecs() {
            const mappings = [ { id: 'material', target: 'print-material' }, { id: 'layer', target: 'print-layer' }, { id: 'thickness', target: 'print-thickness' }, { id: 'copper', target: 'print-copper' },  { id: 'mask', target: 'print-mask' }, { id: 'legend', target: 'print-legend' }, { id: 'surface', target: 'print-surface' } ];
            mappings.forEach(m => {
                const select = document.querySelector(`.unit-select[data-target="${m.id}-input-group"]`);
                const inputGroup = document.getElementById(`${m.id}-input-group`);
                const input = inputGroup ? inputGroup.querySelector('input') : null;
                const target = document.getElementById(m.target);
                if (select && target) {
                    let val = select.value;
                    if (val === 'å…¶ä»–' || (inputGroup && inputGroup.style.display !== 'none')) { val = input ? input.value : ''; }
                    val = val.replace(/ğŸŸ¢|âšª|ğŸ”´|âš«|ğŸ”µ/g, '').trim();
                    if (m.id === 'thickness') { val = val.replace(/(\d)(mm)$/i, '$1 $2'); }
                    target.textContent = val;
                }
            });
            const len = document.getElementById('dim-length-input')?.value || '';
            const wid = document.getElementById('dim-width-input')?.value || '';
            const dimTarget = document.getElementById('print-dim');
            if(dimTarget) dimTarget.textContent = (len && wid) ? `${len} x ${wid} mm` : '';
            const px = document.getElementById('pnl-x')?.value || '';
            const py = document.getElementById('pnl-y')?.value || '';
            const arrTarget = document.getElementById('print-array');
            if(arrTarget) arrTarget.textContent = (px && py) ? `${px} x ${py} PCS/PNL` : '';
        }

        function initToggleLogic() {
            document.querySelectorAll('.toggle-select').forEach(select => {
                select.addEventListener('change', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetBox = document.getElementById(targetId);
                    if (this.value === 'å…¶ä»–' && targetBox) { this.style.display = 'none'; targetBox.style.display = 'flex'; targetBox.querySelector('input')?.focus(); }
                    hasUserInteracted = true; checkCompletion(); syncPcbSpecs();
                });
            });
            document.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputBox = this.closest('.toggle-input-box');
                    const wrapper = this.closest('.wrapper-toggle');
                    const select = wrapper.querySelector('select');
                    if (inputBox && select) { inputBox.querySelector('input').value = ''; inputBox.style.display = 'none'; select.style.display = 'block'; select.value = ""; }
                    hasUserInteracted = true; checkCompletion(); syncPcbSpecs();
                });
            });
        }

        function prepareRowsForPrint() {
            const holeRows = [ document.getElementById('row-hole-1'), document.getElementById('row-hole-2'), document.getElementById('row-hole-3') ];
            holeRows.forEach(row => {
                if (row) {
                    const nominalSpec = row.querySelector('.editable-cell:not(.data-field)');
                    let isSpecEmpty = nominalSpec?.textContent.trim() === '';
                    if (nominalSpec && !isSpecEmpty) { let content = nominalSpec.textContent.replace(/[^0-9.]/g, '').trim(); if (content === '') isSpecEmpty = true; }
                    if (isSpecEmpty) row.classList.add('print-hidden-row'); else row.classList.remove('print-hidden-row');
                }
            });
        }

        function updateSpecs() {
            const lengthInput = document.getElementById('dim-length-input');
            const widthInput = document.getElementById('dim-width-input');
            const lengthNominal = document.getElementById('spec-length-nominal');
            const widthNominal = document.getElementById('spec-width-nominal');
            if (lengthInput && lengthNominal) lengthNominal.textContent = lengthInput.value || '';
            if (widthInput && widthNominal) widthNominal.textContent = widthInput.value || '';
            populateAllInspectionData();
        }

        function parseSpec(nominalId) {
            const nominalEl = document.getElementById(nominalId);
            if (!nominalEl) return null;
            const row = nominalEl.closest('tr');
            const toleranceEl = row.querySelector('.spec-tolerance');
            const nominal = parseFloat(nominalEl.textContent.trim());
            const tolerance = toleranceEl ? parseFloat(toleranceEl.getAttribute('data-tolerance')) : 0;
            if (isNaN(nominal)) return null;
            return { nominal, tolerance };
        }

        function generateRandomData(nominal, tolerance, rowIndex) {
            let val = nominal;
            if (rowIndex === 0 || rowIndex === 1) {
                if (Math.random() < 0.90) val = nominal + (Math.random() * 0.10); else val = nominal - (Math.random() * 0.05);
            } else {
                if (Math.random() < 0.20) val = nominal + 0.04; else val = nominal + 0.01 + (Math.random() * 0.03);
            }
            return val.toFixed(2);
        }

        function populateRowData(rowIndex, nominalId) {
            const parsed = parseSpec(nominalId);
            const tbody = document.getElementById('inspection-data-table').querySelector('tbody');
            const row = tbody.rows[rowIndex];
            if (!row) return;
            const judgementCell = row.querySelector('.judgment-field');
            const dataCells = row.querySelectorAll('.data-field');
            if (!parsed) { dataCells.forEach(cell => cell.textContent = ''); judgementCell.textContent = ''; return; }
            dataCells.forEach(cell => { cell.textContent = generateRandomData(parsed.nominal, parsed.tolerance, rowIndex); });
            judgementCell.textContent = 'OK'; judgementCell.style.color = 'green';
        }

        function populateAllInspectionData() {
            populateRowData(0, 'spec-length-nominal');
            populateRowData(1, 'spec-width-nominal');
            populateRowData(2, 'spec-hole1-nominal');
            populateRowData(3, 'spec-hole2-nominal');
            populateRowData(4, 'spec-hole3-nominal');
            checkCompletion(); 
        }

        function checkJudgement(dataEl) {
            const row = dataEl.closest('tr');
            const judgementCell = row.querySelector('.judgment-field');
            const allEmpty = Array.from(row.querySelectorAll('.data-field')).every(el => el.textContent.trim() === '');
            if (allEmpty) { judgementCell.textContent = ''; } else { judgementCell.textContent = 'OK'; judgementCell.style.color = 'green'; }
            hasUserInteracted = true; checkCompletion();
        }

        function checkCompletion() {
            let isComplete = true;
            const infoInputs = document.querySelectorAll('#unified-header-container .input-line');
            if (infoInputs[0] && infoInputs[0].value.trim() === "") isComplete = false;
            const basicInfoSection = document.querySelector('.info-grid'); 
            if (basicInfoSection) {
                const inputs = basicInfoSection.querySelectorAll('input[type="text"]');
                inputs.forEach(input => { if (input.id !== 'cycle-input' && input.offsetParent !== null && input.value.trim() === "") { isComplete = false; } });
            }
            const pcbSection = document.getElementById('pcb-spec-section');
            if (pcbSection) {
                const visibleSelects = pcbSection.querySelectorAll('select');
                visibleSelects.forEach(select => { if (select.offsetParent !== null && (select.value === "" || select.value === "è«‹é¸æ“‡")) { isComplete = false; } });
                const visibleInputs = pcbSection.querySelectorAll('input[type="text"]');
                visibleInputs.forEach(input => { if (input.offsetParent !== null && input.value.trim() === "") { isComplete = false; } });
            }
            const nominalSpecA = document.getElementById('spec-hole1-nominal');
            const holeADataFields = document.getElementById('row-hole-1')?.querySelectorAll('.data-field');
            let isHoleASpecEmpty = nominalSpecA?.textContent.trim() === '';
            if (isHoleASpecEmpty) { isComplete = false; nominalSpecA?.classList.remove('input-error'); } else { nominalSpecA?.classList.remove('input-error'); }
            if (isComplete && holeADataFields) {
                const isHoleADataEmpty = Array.from(holeADataFields).every(field => field.textContent.trim() === '');
                if (isHoleADataEmpty) isComplete = false;
            }
            const badgeEl = document.getElementById('final-decision-badge');
            if (isComplete) { badgeEl.textContent = "PASSED / åˆæ ¼"; badgeEl.className = "result-badge status-pass"; } else {
                document.querySelectorAll('#inspection-data-table .editable-cell:not(.data-field)').forEach(el => { if (el.id !== 'spec-hole1-nominal') el.classList.remove('input-error'); });
                badgeEl.textContent = "ç­‰å¾…æ•¸æ“š..."; badgeEl.className = "result-badge status-pending";
            }
        }

        function initNumericInputLogic() {
            const numericInputs = document.querySelectorAll('#dim-length-input, #dim-width-input, #pnl-x, #pnl-y');
            numericInputs.forEach(input => { input.addEventListener('input', function() { this.value = this.value.replace(/[^0-9.]/g, ''); hasUserInteracted = true; }); });
            const editableCells = document.querySelectorAll('.editable-cell, .data-field');
            editableCells.forEach(cell => {
                cell.addEventListener('input', function(e) { if (e.isComposing) return; const text = this.innerText; const clean = text.replace(/[^0-9.]/g, ''); if (text !== clean) { this.innerText = clean; try { const range = document.createRange(); const sel = window.getSelection(); range.selectNodeContents(this); range.collapse(false); sel.removeAllRanges(); sel.addRange(range); } catch(e) {} } hasUserInteracted = true; });
                cell.addEventListener('keydown', function(e) { const allowedKeys = ["Backspace", "Delete", "Tab", "Escape", "Enter", "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Home", "End", "."]; if (!isNaN(parseInt(e.key)) || allowedKeys.includes(e.key)) { if (e.key === '.' && this.innerText.includes('.')) e.preventDefault(); return; } e.preventDefault(); });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initToggleLogic(); initNumericInputLogic(); 
            document.querySelectorAll('#inspection-data-table').forEach(table => { table.addEventListener('input', () => { hasUserInteracted = true; checkCompletion(); }); });
            document.getElementById('spec-length-nominal')?.addEventListener('input', populateAllInspectionData);
            document.getElementById('spec-width-nominal')?.addEventListener('input', populateAllInspectionData);
            document.querySelectorAll('[id^="spec-hole"]').forEach(el => { el.addEventListener('input', populateAllInspectionData); });
            const allInputs = document.querySelectorAll('#pcb-spec-section input, #pcb-spec-section select');
            allInputs.forEach(el => { el.addEventListener('input', syncPcbSpecs); el.addEventListener('change', syncPcbSpecs); });
            document.querySelectorAll('.reset-btn').forEach(btn => { btn.addEventListener('click', () => setTimeout(syncPcbSpecs, 50)); });
            setTimeout(() => { const basicInfoGrid = document.querySelector('#unified-header-container .info-grid'); if (basicInfoGrid) { basicInfoGrid.addEventListener('input', () => { hasUserInteracted = true; checkCompletion(); }); basicInfoGrid.addEventListener('change', () => { hasUserInteracted = true; checkCompletion(); }); } }, 500); 
        });
    </script>
</body>
</html>