<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‡ºè²¨æª¢é©—å ±å‘Š - æœ€çµ‚å®Œç¾ç‰ˆ</title>
    
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="report.css">

<style>
        /* === é é¢å°ˆå±¬å¾®èª¿ === */
        
        /* æ¨™é¡Œå€å¡Šæ’ç‰ˆ */
        .section-header-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
            padding-right: 5px; 
        }
        .section-header-wrapper .section-title { margin-bottom: 0; }

.standard-badge {
    font-size: 13px; 
    color: #333; /* ä½¿ç”¨ä¸€è‡´çš„æ·±è‰² */
    background-color: var(--label-bg); /* ç¶å®š report.css è®Šæ•¸ (é è¨­: #fafafa) */
    padding: 5px 12px; 
    border-radius: 20px; 
    font-weight: 600;
    border: 1px solid var(--border-color); /* ç¶å®š report.css è®Šæ•¸ (é è¨­: #c2a878) */
    letter-spacing: 0.5px;
}

        /* æœ€çµ‚åˆ¤å®šå€å¡Š */
        .final-decision-box {
            margin-top: 15px; 
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #e5e7eb; 
            border-radius: 8px;
            background-color: #fff;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
        }

        .decision-label {
            font-size: 16px;
            font-weight: 700;
            color: #374151;
        }

        /* åˆ¤å®šçµæœæ¨™ç±¤æ¨£å¼ */
        .result-badge {
            font-size: 18px;
            font-weight: 800;
            padding: 8px 30px;
            border-radius: 4px;
            letter-spacing: 2px;
            text-transform: uppercase;
            transition: all 0.3s ease;
            text-align: center;
            min-width: 150px;
            box-sizing: border-box; 
        }

        /* ç‹€æ…‹ï¼šç­‰å¾…ä¸­ */
        .status-pending {
            background-color: #f3f4f6;
            color: #9ca3af;
            border: 1px dashed #d1d5db;
        }

        /* ç‹€æ…‹ï¼šåˆæ ¼ (ç¶ è‰²å°ç« æ„Ÿ) */
        .status-pass {
            background-color: #ecfdf5;
            color: #059669;
            border: 2px solid #059669;
            box-shadow: 0 0 5px rgba(5, 150, 105, 0.2);
        }

        /* ç‹€æ…‹ï¼šä¸åˆæ ¼ (ç´…è‰²è­¦ç¤ºæ„Ÿ) */
        .status-fail {
            background-color: #fef2f2;
            color: #dc2626;
            border: 2px solid #dc2626;
            box-shadow: 0 0 5px rgba(220, 38, 38, 0.2);
        }

        .sign-stamp-area { position: relative; overflow: hidden; }
        .wrapper-toggle { display: flex; align-items: center; width: 100%; position: relative; }
        .toggle-input-box { width: 100%; display: flex; align-items: center; flex: 1; }
        .reset-btn { cursor: pointer; font-size: 18px; color: #999; padding: 0 8px; line-height: 1; font-weight: bold; user-select: none; }
        .reset-btn:hover { color: red; }
        
        /* è¡¨æ ¼æ¬„ä½æ¨£å¼ */
        .editable-cell {
            min-width: 50px; display: inline-block; padding: 2px 5px;
            outline: none; border-bottom: 1px dashed #ccc; text-align: center;
            background: transparent;
        }
        .editable-cell:focus { border-bottom: 1px solid #b38728; background-color: #fffdf5; }
        .tolerance-display { font-size: 0.85em; color: #666; margin-left: 4px; }

        /* Grid æ’ç‰ˆ */
        .info-grid.grid-3 { display: grid; grid-template-columns: repeat(6, 1fr); gap: 10px 20px; }
        .span-standard { grid-column: span 2; }
        .span-half { grid-column: span 3; }
        /* .split-input æ¨£å¼å·²ç§»è‡³ report.css */
        
        /* æ‰‹æ©Ÿç‰ˆ RWD */
        @media screen and (max-width: 768px) {
            .info-grid.grid-3 { grid-template-columns: 1fr; gap: 8px; } 
            .span-standard, .span-half { grid-column: auto; } 
            .input-group { width: 100%; }
            .section-header-wrapper { flex-direction: column; align-items: flex-start; gap: 5px; }
            .final-decision-box { flex-direction: column; gap: 10px; align-items: stretch; }
            .result-badge { width: 100%; max-width: 100%; margin-top: 5px; }
        }

        /* åˆ—å°è¨­å®š */
        @media print {
            .reset-btn { display: none !important; }
            input { border: none !important; background: transparent !important; }
            .editable-cell { border-bottom: 1px dashed #000 !important; }
            body { padding-top: 0; }
            .page-container { margin-top: 0; }
            .remarks-input { height: 40px !important; min-height: 40px !important; resize: none; }
            .standard-badge { border: 1px solid #999; color: #000; }
            
            /* åˆ—å°æ™‚éš±è—æœªè¼¸å…¥çš„æˆå“å­”å¾‘è¡Œ */
            .print-hidden-row {
                display: none !important;
            }

            /* å¼·åˆ¶åˆ—å°èƒŒæ™¯é¡è‰² */
            .result-badge {
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
                color-adjust: exact !important;
            }
            .status-pass { 
                background-color: #ecfdf5 !important;
                color: #059669 !important;
                border: 2px solid #059669 !important;
            }
            .status-fail { 
                background-color: #fef2f2 !important;
                color: #dc2626 !important;
                border: 2px solid #dc2626 !important;
            }
            .status-pending { display: none; }
            .final-decision-box { border: 1px solid #e5e7eb; }
        }
    </style>
</head>
<body>

    <div id="navbar-container"></div>

    <div class="page-container">
        
        <div class="action-buttons">
            <button class="btn-print" onclick="validateAndPrint()">
                <svg class="icon-printer" viewBox="0 0 24 24">
                    <path d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z"/>
                </svg>
                åˆ—å° / PDF
            </button>
        </div>

        <div class="a4-paper">
            
            <div id="unified-header-container" data-title="å‡ºè²¨æª¢é©—å ±å‘Š"></div>

            <h3 class="section-title">PCB è¦æ ¼</h3>

            <section class="info-grid grid-3" id="pcb-spec-section">
                <div class="info-item span-standard">
                    <span class="label">æ¿æ</span>
                    <div class="input-group wrapper-toggle">
                        <select class="unit-select toggle-select" data-target="material-input-group" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="FR-4">FR-4</option>
                            <option value="FR-1">FR-1</option>
                            <option value="é‹åŸºæ¿">é‹åŸºæ¿</option>
                            <option value="éŠ…åŸºæ¿">éŠ…åŸºæ¿</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="material-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥æ¿æ" oninput="checkCompletion()">
                            <span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span>
                        </div>
                    </div>
                </div>

                <div class="info-item span-standard">
                    <span class="label">å±¤åˆ¥</span>
                    <div class="input-group wrapper-toggle">
                        <select class="unit-select toggle-select" data-target="layer-input-group" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="å–®é¢æ¿">å–®é¢æ¿</option>
                            <option value="é›™é¢æ¿">é›™é¢æ¿</option>
                            <option value="å››å±¤æ¿">å››å±¤æ¿</option>
                            <option value="å…­å±¤æ¿">å…­å±¤æ¿</option>
                            <option value="å…«å±¤æ¿">å…«å±¤æ¿</option>
                            <option value="åå±¤æ¿">åå±¤æ¿</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="layer-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥å±¤åˆ¥" oninput="checkCompletion()">
                            <span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span>
                        </div>
                    </div>
                </div>

                <div class="info-item span-standard">
                    <span class="label">æ¿åš</span>
                    <div class="input-group wrapper-toggle">
                        <select class="unit-select toggle-select" data-target="thickness-input-group" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="0.4mm">0.4 mm</option>
                            <option value="0.6mm">0.6 mm</option>
                            <option value="0.8mm">0.8 mm</option>
                            <option value="1.0mm">1.0 mm</option>
                            <option value="1.2mm">1.2 mm</option>
                            <option value="1.6mm">1.6 mm</option>
                            <option value="2.0mm">2.0 mm</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="thickness-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥æ¿åš" oninput="checkCompletion()">
                            <span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span>
                        </div>
                    </div>
                </div>

                <div class="info-item span-standard">
                    <span class="label">é˜²ç„Š</span>
                    <div class="input-group wrapper-toggle">
                        <select class="unit-select toggle-select" data-target="mask-input-group" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="ç¶ è‰²">ğŸŸ¢ ç¶ è‰²</option>
                            <option value="ç™½è‰²">âšª ç™½è‰²</option>
                            <option value="ç´…è‰²">ğŸ”´ ç´…è‰²</option>
                            <option value="é»‘è‰²">âš« é»‘è‰²</option>
                            <option value="è—è‰²">ğŸ”µ è—è‰²</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="mask-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥é¡è‰²" oninput="checkCompletion()">
                            <span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span>
                        </div>
                    </div>
                </div>

                <div class="info-item span-standard">
                    <span class="label">æ–‡å­—</span>
                    <div class="input-group wrapper-toggle">
                        <select class="unit-select toggle-select" data-target="legend-input-group" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="ç™½è‰²">âšª ç™½è‰²</option>
                            <option value="é»‘è‰²">âš« é»‘è‰²</option>
                            <option value="ç„¡æ–‡å­—">ç„¡æ–‡å­—</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="legend-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥é¡è‰²" oninput="checkCompletion()">
                            <span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span>
                        </div>
                    </div>
                </div>

                <div class="info-item span-standard">
                    <span class="label">ç„Šç›¤</span>
                    <div class="input-group wrapper-toggle">
                        <select class="unit-select toggle-select" data-target="surface-input-group" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="æœ‰é‰›å™´éŒ«">æœ‰é‰›å™´éŒ«</option>
                            <option value="ç„¡é‰›å™´éŒ«" selected>ç„¡é‰›å™´éŒ«</option>
                            <option value="åŒ–é‡‘ 1u">åŒ–é‡‘ 1u"</option>
                            <option value="åŒ–é‡‘ 2u">åŒ–é‡‘ 2u"</option>
                            <option value="åŒ–é‡‘ 3u">åŒ–é‡‘ 3u"</option>
                            <option value="ç¡¬é‡‘ 3u">ç¡¬é‡‘ 3u"</option>
                            <option value="ç¡¬é‡‘ 5u">ç¡¬é‡‘ 5u"</option>
                            <option value="OSP">OSP</option>
                            <option value="è£¸éŠ…">è£¸éŠ…</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)ç¹†</option>
                        </select>
                        <div class="input-group toggle-input-box" id="surface-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥è™•ç†" oninput="checkCompletion()">
                            <span class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span>
                        </div>
                    </div>
                </div>

                <div class="info-item span-half">
                    <span class="label">å°ºå¯¸</span>
                    <div class="input-group" style="gap: 5px;">
                        <input type="text" id="dim-length-input" class="input-line split-input" placeholder="é•·" oninput="updateSpecs(); checkCompletion();">
                        <span>x</span>
                        <input type="text" id="dim-width-input" class="input-line split-input" placeholder="å¯¬" oninput="updateSpecs(); checkCompletion();">
                        <span class="unit-display-text" style="font-size: 12px; color: #666; white-space: nowrap;">mm</span>
                    </div>
                </div>

                <div class="info-item span-half">
                    <span class="label">æ’ç‰ˆ</span>
                    <div class="input-group" style="gap: 5px;">
                        <input type="text" id="pnl-x" class="input-line split-input" placeholder="X" oninput="checkCompletion()">
                        <span>x</span>
                        <input type="text" id="pnl-y" class="input-line split-input" placeholder="Y" oninput="checkCompletion()">
                        
                        <span class="unit-display-text" style="flex-shrink: 0; width: 65px; font-size: 12px; font-weight: 600; text-align: center;">PCS / PNL</span>
                    </div>
                </div>
            </section>

            <div class="section-header-wrapper">
                <h3 class="section-title">æª¢é©—æ•¸æ“š</h3>
                <span class="standard-badge">æŠ½æ¨£æ¨™æº–: MIL-STD-105D</span>
            </div>

            <div class="table-wrapper">
                <table class="inspection-table" id="inspection-data-table">
                    <thead>
                        <tr>
                            <th style="width: 15%;">é …ç›®</th>
                            <th style="width: 20%;">è¦æ ¼</th>
                            <th>æª¢é©— 1</th>
                            <th>æª¢é©— 2</th>
                            <th>æª¢é©— 3</th>
                            <th>æª¢é©— 4</th>
                            <th>æª¢é©— 5</th>
                            <th style="width: 10%;">åˆ¤å®š</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-item="length">
                            <td>æˆå“é•·åº¦ (mm)</td>
                            <td>
                                <span contenteditable="true" class="editable-cell" id="spec-length-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> 
                                <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.2">0.2</span></span>
                            </td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td class="judgment-field" style="font-weight:bold;"></td> 
                        </tr>
                        <tr data-item="width">
                            <td>æˆå“å¯¬åº¦ (mm)</td>
                            <td>
                                <span contenteditable="true" class="editable-cell" id="spec-width-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> 
                                <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.2">0.2</span></span>
                            </td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td> 
                            <td class="judgment-field" style="font-weight:bold;"></td> 
                        </tr>
                        <tr id="row-hole-1">
                            <td>æˆå“å­”å¾‘ A</td>
                            <td>
                                <span contenteditable="true" class="editable-cell placeholder-text" id="spec-hole1-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> 
                                <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span>
                            </td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                        <tr id="row-hole-2">
                            <td>æˆå“å­”å¾‘ B</td>
                            <td>
                                <span contenteditable="true" class="editable-cell placeholder-text" id="spec-hole2-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> 
                                <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span>
                            </td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                        <tr id="row-hole-3">
                            <td>æˆå“å­”å¾‘ C</td>
                            <td>
                                <span contenteditable="true" class="editable-cell placeholder-text" id="spec-hole3-nominal" inputmode="decimal" oninput="populateAllInspectionData()"></span> 
                                <span class="tolerance-display"> Â± <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span>
                            </td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal" oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="final-decision-box">
                <span class="decision-label">åˆ¤å®šçµæœ:</span>
                
                <div id="final-decision-badge" class="result-badge status-pending">
                    ç­‰å¾…æ•¸æ“š...
                </div>
            </div>

            <div id="unified-remarks-container"></div>

            <div class="signature-section">
                <div class="sign-box">
                    <div class="sign-title">æª¢é©—äººå“¡</div>
                    <div class="sign-stamp-area">
                        <img src="pic/reviewer.png" alt="æª¢é©—äººå“¡" class="stamp-img">
                    </div>
                </div>
                <div class="sign-box">
                    <div class="sign-title">æ ¸å‡†äººå“¡</div>
                    <div class="sign-stamp-area">
                         <img src="pic/approver.png" alt="æ ¸å‡†äººå“¡" class="stamp-img">
                    </div>
                </div>
            </div>

        </div> </div> <script src="navbar.js"></script>
    <script src="template.js"></script>

    <script>
        // *** 1. æ–°å¢å…¨åŸŸè®Šæ•¸ï¼šè¿½è¹¤ä½¿ç”¨è€…æ˜¯å¦å·²é–‹å§‹äº’å‹•æˆ–å˜—è©¦åˆ—å° ***
        let hasUserInteracted = false;
        
        // === 1. ä¸‹æ‹‰é¸å–®èˆ‡è¼¸å…¥æ¡†åˆ‡æ›é‚è¼¯ ===
        function initToggleLogic() {
            document.querySelectorAll('.toggle-select').forEach(select => {
                select.addEventListener('change', function() {
                    const targetId = this.getAttribute('data-target');
                    const targetBox = document.getElementById(targetId);
                    if (this.value === 'å…¶ä»–' && targetBox) {
                        this.style.display = 'none';
                        targetBox.style.display = 'flex';
                        const input = targetBox.querySelector('input');
                        if (input) input.focus();
                    }
                    hasUserInteracted = true; // äº’å‹•
                    checkCompletion(); 
                });
            });

            document.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    const inputBox = this.closest('.toggle-input-box');
                    const wrapper = this.closest('.wrapper-toggle');
                    const select = wrapper.querySelector('select');
                    if (inputBox && select) {
                        const input = inputBox.querySelector('input');
                        if (input) input.value = ''; 
                        inputBox.style.display = 'none';
                        select.style.display = 'block';
                        select.value = ""; 
                    }
                    hasUserInteracted = true; // äº’å‹•
                    checkCompletion(); 
                });
            });
        }

        // === 2. æ•¸å€¼åŒæ­¥é‚è¼¯ ===
        function updateSpecs() {
            const lengthInput = document.getElementById('dim-length-input');
            const widthInput = document.getElementById('dim-width-input');
            const lengthNominal = document.getElementById('spec-length-nominal');
            const widthNominal = document.getElementById('spec-width-nominal');

            if (lengthInput && lengthNominal) lengthNominal.textContent = lengthInput.value || '';
            if (widthInput && widthNominal) widthNominal.textContent = widthInput.value || '';
            
            populateAllInspectionData();
        }

        // === 3. éš¨æ©Ÿæ•¸æ“šç”Ÿæˆé‚è¼¯ ===
        function parseSpec(nominalId) {
            const nominalEl = document.getElementById(nominalId);
            if (!nominalEl) return null;
            const row = nominalEl.closest('tr');
            const toleranceEl = row.querySelector('.spec-tolerance');
            const nominal = parseFloat(nominalEl.textContent.trim());
            const tolerance = toleranceEl ? parseFloat(toleranceEl.getAttribute('data-tolerance')) : 0;
            if (isNaN(nominal)) return null;
            return { nominal, tolerance };
        }

        function generateRandomData(nominal, tolerance, rowIndex) {
            let val = nominal;
            
            // æƒ…æ³ 1: æˆå“é•·åº¦èˆ‡å¯¬åº¦ (Row 0, 1) - ç¶­æŒåŸæ¡ˆ
            if (rowIndex === 0 || rowIndex === 1) {
                // 90% æ©Ÿç‡: æ­£å…¬å·® +0.1 å…§
                if (Math.random() < 0.90) { 
                    val = nominal + (Math.random() * 0.10);
                } 
                // 10% æ©Ÿç‡: è² å…¬å·® -0.05 å…§
                else { 
                    val = nominal - (Math.random() * 0.05);
                }
            } 
            // æƒ…æ³ 2: æˆå“å­”å¾‘ (Row >= 2) - [ç¶­æŒé‚è¼¯]
            else {
                // 20% æ©Ÿç‡: ç”Ÿæˆç²¾ç¢º +0.04
                if (Math.random() < 0.20) {
                    val = nominal + 0.04;
                } else {
                    // 80% æ©Ÿç‡: ç”Ÿæˆ +0.01 ~ +0.04 ä¹‹é–“
                    val = nominal + 0.01 + (Math.random() * 0.03);
                }
            }
            
            return val.toFixed(2);
        }

        function populateRowData(rowIndex, nominalId) {
            const parsed = parseSpec(nominalId);
            const tbody = document.getElementById('inspection-data-table').querySelector('tbody');
            const row = tbody.rows[rowIndex];
            if (!row) return;

            const judgementCell = row.querySelector('.judgment-field');
            const dataCells = row.querySelectorAll('.data-field');

            if (!parsed) {
                dataCells.forEach(cell => cell.textContent = '');
                judgementCell.textContent = '';
                return;
            }

            dataCells.forEach(cell => {
                cell.textContent = generateRandomData(parsed.nominal, parsed.tolerance, rowIndex);
            });
            judgementCell.textContent = 'OK';
            judgementCell.style.color = 'green';
        }

        function populateAllInspectionData() {
            populateRowData(0, 'spec-length-nominal');
            populateRowData(1, 'spec-width-nominal');
            populateRowData(2, 'spec-hole1-nominal');
            populateRowData(3, 'spec-hole2-nominal');
            populateRowData(4, 'spec-hole3-nominal');
            // populateRowData(5, 'spec-hole4-nominal'); // å·²ç§»é™¤å­”å¾‘ D
            checkCompletion(); 
        }

        function checkJudgement(dataEl) {
            const row = dataEl.closest('tr');
            const judgementCell = row.querySelector('.judgment-field');
            const allEmpty = Array.from(row.querySelectorAll('.data-field')).every(el => el.textContent.trim() === '');
            if (allEmpty) {
                judgementCell.textContent = '';
            } else {
                judgementCell.textContent = 'OK';
                judgementCell.style.color = 'green';
            }
            hasUserInteracted = true; // äº’å‹•
            checkCompletion();
        }

        // === åˆ¤å®šé‚è¼¯ä¿®æ­£ (å·²ç§»é™¤æˆå“å­”å¾‘ A è¦æ ¼çš„ç´…æ¡†åˆ¤æ–·) ===
        function checkCompletion() {
            let isComplete = true;

            // 1. æª¢æŸ¥åŸºæœ¬è³‡æ–™
            const infoInputs = document.querySelectorAll('#unified-header-container .input-line');
            if (infoInputs[0] && infoInputs[0].value.trim() === "") isComplete = false;
            
            const basicInfoSection = document.querySelector('.info-grid'); 
            if (basicInfoSection) {
                const inputs = basicInfoSection.querySelectorAll('input[type="text"]');
                inputs.forEach(input => {
                    if (input.id !== 'cycle-input' && input.offsetParent !== null && input.value.trim() === "") {
                        isComplete = false;
                    }
                });
            }

            // 2. æª¢æŸ¥ PCB è¦æ ¼
            const pcbSection = document.getElementById('pcb-spec-section');
            if (pcbSection) {
                const visibleSelects = pcbSection.querySelectorAll('select');
                visibleSelects.forEach(select => {
                    if (select.offsetParent !== null && (select.value === "" || select.value === "è«‹é¸æ“‡")) {
                        isComplete = false;
                    }
                });
                const visibleInputs = pcbSection.querySelectorAll('input[type="text"]');
                visibleInputs.forEach(input => {
                    if (input.offsetParent !== null && input.value.trim() === "") {
                        isComplete = false;
                    }
                });
            }
            
            // 3. æª¢æŸ¥æˆå“å­”å¾‘ A è¦æ ¼æ˜¯å¦è¼¸å…¥ (åƒ…å½±éŸ¿ isComplete ç‹€æ…‹ï¼Œä¸é¡¯ç¤ºç´…æ¡†)
            const nominalSpecA = document.getElementById('spec-hole1-nominal');
            const holeADataFields = document.getElementById('row-hole-1')?.querySelectorAll('.data-field');
            
            let isHoleASpecEmpty = nominalSpecA?.textContent.trim() === '';
            
            if (isHoleASpecEmpty) {
                isComplete = false;
                
                // ç¢ºä¿åœ¨éåˆ—å°ç‹€æ…‹ä¸‹ä¸é¡¯ç¤ºç´…æ¡†
                nominalSpecA?.classList.remove('input-error'); 
            } else {
                nominalSpecA?.classList.remove('input-error');
            }


            // 4. æª¢æŸ¥æˆå“å­”å¾‘ A æ•¸æ“šæ˜¯å¦è¼¸å…¥
            if (isComplete && holeADataFields) {
                const isHoleADataEmpty = Array.from(holeADataFields).every(field => field.textContent.trim() === '');
                
                if (isHoleADataEmpty) {
                    isComplete = false;
                }
            }


            // æ›´æ–° UI ç‹€æ…‹
            const badgeEl = document.getElementById('final-decision-badge');
            
            if (isComplete) {
                badgeEl.textContent = "PASSED / åˆæ ¼";
                badgeEl.className = "result-badge status-pass";
            } else {
                // é€™è£¡ç§»é™¤æ‰€æœ‰å­”å¾‘ B, C è¦æ ¼æ¬„ä½çš„ç´…æ¡†ï¼Œé¿å…ä¸Šæ¬¡çš„éŒ¯èª¤å½±éŸ¿æœ¬æ¬¡æª¢æŸ¥
                document.querySelectorAll('#inspection-data-table .editable-cell:not(.data-field)').forEach(el => {
                    if (el.id !== 'spec-hole1-nominal') { // å³ä½¿æ˜¯å­”å¾‘ A ä¹Ÿåªç§»é™¤
                        el.classList.remove('input-error');
                    }
                });
                
                badgeEl.textContent = "ç­‰å¾…æ•¸æ“š...";
                badgeEl.className = "result-badge status-pending";
            }
        }

        // [ä¿®æ­£é» 2] éš±è—æœªè¼¸å…¥çš„æˆå“å­”å¾‘è¡Œ (åœ¨åˆ—å°å‰åŸ·è¡Œ)
        function prepareRowsForPrint() {
            const holeRows = [
                document.getElementById('row-hole-1'), // A
                document.getElementById('row-hole-2'), // B
                document.getElementById('row-hole-3')  // C
            ];

            holeRows.forEach(row => {
                if (row) {
                    const nominalSpec = row.querySelector('.editable-cell:not(.data-field)');
                    
                    // æª¢æŸ¥ï¼šå¦‚æœè¦æ ¼å€¼ç‚ºç©º (ä½¿ç”¨è€…æ²’æœ‰è¨­å®šæ­¤å­”å¾‘)ï¼Œå‰‡éš±è—æ•´è¡Œ
                    let isSpecEmpty = nominalSpec?.textContent.trim() === '';

                    // ç¢ºä¿åœ¨æª¢æŸ¥å‰åŸ·è¡Œä¸€æ¬¡æ¸…ç†ï¼Œè§£æ±ºéš±å½¢å­—å…ƒå•é¡Œ (é€™æ˜¯é—œéµ)
                    if (nominalSpec && !isSpecEmpty) {
                         let content = nominalSpec.textContent;
                         // ç§»é™¤æ‰€æœ‰éæ•¸å­—/å°æ•¸é»çš„å­—ç¬¦ï¼Œä¸¦ trim
                         content = content.replace(/[^0-9.]/g, '').trim(); 
                         // é‡æ–°æª¢æŸ¥
                         if (content === '') {
                             isSpecEmpty = true;
                         }
                    }
                    
                    if (isSpecEmpty) {
                        row.classList.add('print-hidden-row');
                    } else {
                        row.classList.remove('print-hidden-row');
                    }
                }
            });
        }
        
        // è¦†å¯« window.validateAndPrintï¼Œä»¥åœ¨åˆ—å°å‰å‘¼å« prepareRowsForPrint
        const originalValidateAndPrint = window.validateAndPrint; 
        window.validateAndPrint = function() {
            
            // é—œéµä¿®æ­£ 1ï¼šé»æ“Šåˆ—å°æ™‚ï¼Œæª¢æŸ¥æˆå“å­”å¾‘ A è¦æ ¼æ˜¯å¦è¼¸å…¥ï¼Œä¸¦æ•´åˆåˆ°ä¸»æª¢æŸ¥ä¸­
            const nominalSpecA = document.getElementById('spec-hole1-nominal');
            let isHoleASpecEmpty = nominalSpecA?.textContent.trim() === '';

            if (isHoleASpecEmpty) {
                // å¦‚æœæˆå“å­”å¾‘Aè¦æ ¼ç‚ºç©ºï¼Œå‰‡å°‡å…¶æ¨™è¨˜ç‚ºéŒ¯èª¤ï¼Œä½¿å…¶è¢«å¾ŒçºŒçš„ originalValidateAndPrint æ•æ‰
                if (nominalSpecA) {
                    nominalSpecA.classList.add('input-error'); 
                }
            } else {
                nominalSpecA?.classList.remove('input-error');
            }
            
            // é—œéµä¿®æ­£ï¼šé»æ“Šåˆ—å°æ™‚ï¼Œè¦–ç‚ºç”¨æˆ¶å·²äº’å‹•
            hasUserInteracted = true;
            checkCompletion(); // ç¢ºä¿ UI æ¨™è¨˜ç«‹å³æ›´æ–°
            
            // 1. å…ˆåŸ·è¡Œå…§å®¹æª¢æŸ¥ (é©—è­‰å¤±æ•—å‰‡ä¸­æ–·)
            if (!originalValidateAndPrint()) {
                // å¦‚æœé©—è­‰å¤±æ•— (åŒ…æ‹¬æˆå“å­”å¾‘ A è¦æ ¼ç¾åœ¨è¢«æ¨™è¨˜ç‚º error)ï¼Œå‰‡é€€å‡º
                return false;
            }
            
            // 2. é©—è­‰æˆåŠŸå¾Œï¼Œæº–å‚™åˆ—å°
            
            // [ä¿®æ­£ 1] éš±è—æœªè¼¸å…¥çš„æˆå“å­”å¾‘è¡Œ
            prepareRowsForPrint();
            
            // [ä¿®æ­£ 2] æª¢æŸ¥å‚™è¨»ä¸¦ç¨ç«‹éš±è—å‚™è¨»å€ (ç¾åœ¨ template.js ä¸åŸ·è¡Œåˆ—å°ï¼Œæ‰€ä»¥åœ¨é€™è£¡åŠ å…¥å‚™è¨»éš±è—/é¡¯ç¤ºé‚è¼¯)
            const remarksInput = document.querySelector('.remarks-input');
            const remarksContainer = document.getElementById('unified-remarks-container');
            const remarksIsEmpty = remarksInput && remarksInput.value.trim() === '';
            
            if (remarksContainer) {
                if (remarksIsEmpty) {
                    // å¦‚æœå‚™è¨»ç‚ºç©ºï¼Œå‰‡åœ¨åˆ—å°æ™‚å®Œå…¨éš±è—å‚™è¨»å€ (ä½¿ç”¨ print-hide-remarks)
                    remarksContainer.classList.add('print-hide-remarks');
                } else {
                    // å¦‚æœå‚™è¨»ä¸ç‚ºç©ºï¼Œå‰‡ç¢ºä¿å€å¡Šé¡¯ç¤º
                    remarksContainer.classList.remove('print-hide-remarks');
                }
            }
            
            // 3. åŸ·è¡Œåˆ—å° (åªåŸ·è¡Œé€™ä¸€æ¬¡)
            window.print();
            
            // 4. ç‚ºäº†è®“è¢å¹•é¡¯ç¤ºæ¢å¾©æ­£å¸¸ï¼Œåœ¨åˆ—å°å®Œæˆå¾Œç§»é™¤ class
            setTimeout(() => {
                document.querySelectorAll('.print-hidden-row').forEach(row => {
                    row.classList.remove('print-hidden-row');
                });
                
                // ç§»é™¤å‚™è¨»éš±è— class
                if (remarksContainer) remarksContainer.classList.remove('print-hide-remarks');
                
                // ç§»é™¤æˆå“å­”å¾‘ A è¦æ ¼çš„ç´…æ¡† (å¦‚æœå­˜åœ¨)
                if (nominalSpecA) nominalSpecA.classList.remove('input-error');
                
            }, 100);
            
            return true;
        };


        // === é™åˆ¶æ•¸å€¼è¼¸å…¥ (å¼·åŠ›é˜»æ“‹ä¸­æ–‡) ===
        function initNumericInputLogic() {
            const numericInputs = document.querySelectorAll('#dim-length-input, #dim-width-input, #pnl-x, #pnl-y');
            numericInputs.forEach(input => {
                input.addEventListener('input', function() {
                    this.value = this.value.replace(/[^0-9.]/g, '');
                    hasUserInteracted = true; // äº’å‹•
                });
            });

            const editableCells = document.querySelectorAll('.editable-cell, .data-field');
            
            editableCells.forEach(cell => {
                cell.addEventListener('compositionend', function(e) {
                    const text = this.innerText;
                    const clean = text.replace(/[^0-9.]/g, '');
                    if (text !== clean) {
                        this.innerText = clean;
                        try {
                            const range = document.createRange();
                            const sel = window.getSelection();
                            range.selectNodeContents(this);
                            range.collapse(false);
                            sel.removeAllRanges();
                            sel.addRange(range);
                        } catch(e) {}
                    }
                    hasUserInteracted = true; // äº’å‹•
                });

                cell.addEventListener('input', function(e) {
                    if (e.isComposing) return;

                    const text = this.innerText;
                    const clean = text.replace(/[^0-9.]/g, '');
                    if (text !== clean) {
                        this.innerText = clean;
                        try {
                            const range = document.createRange();
                            const sel = window.getSelection();
                            range.selectNodeContents(this);
                            range.collapse(false);
                            sel.removeAllRanges();
                            sel.addRange(range);
                        } catch(e) {}
                    }
                    hasUserInteracted = true; // äº’å‹•
                });

                cell.addEventListener('keydown', function(e) {
                    const allowedKeys = [
                        "Backspace", "Delete", "Tab", "Escape", "Enter",
                        "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown",
                        "Home", "End", "."
                    ];
                    if (!isNaN(parseInt(e.key)) || allowedKeys.includes(e.key)) {
                        if (e.key === '.' && this.innerText.includes('.')) {
                             e.preventDefault();
                        }
                        return;
                    }
                    e.preventDefault();
                });
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            initToggleLogic();
            initNumericInputLogic(); 
            
            // ç›£è½è¡¨æ ¼è¼¸å…¥äº‹ä»¶ï¼Œè¨­å®š hasUserInteracted ç‚º true
            document.querySelectorAll('#inspection-data-table').forEach(table => {
                table.addEventListener('input', () => {
                    hasUserInteracted = true;
                    checkCompletion();
                });
            });

            document.getElementById('spec-length-nominal')?.addEventListener('input', populateAllInspectionData);
            document.getElementById('spec-width-nominal')?.addEventListener('input', populateAllInspectionData);
            document.querySelectorAll('[id^="spec-hole"]').forEach(el => {
                el.addEventListener('input', populateAllInspectionData);
            });

            setTimeout(() => {
                const basicInfoGrid = document.querySelector('#unified-header-container .info-grid');
                if (basicInfoGrid) {
                    // ç›£è½åŸºæœ¬è³‡è¨Šå€ï¼Œè¨­å®š hasUserInteracted ç‚º true
                    basicInfoGrid.addEventListener('input', () => {
                        hasUserInteracted = true;
                        checkCompletion();
                    });
                    basicInfoGrid.addEventListener('change', () => {
                        hasUserInteracted = true;
                        checkCompletion();
                    });
                }
                // ç§»é™¤åˆå§‹çš„ checkCompletion() å‘¼å«
            }, 500); 
        });
    </script>
</body>

</html>