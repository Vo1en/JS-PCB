<!DOCTYPE html>
<html lang="zh-Hant">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>é§¿é‘« è¦æ ¼ç”¢ç”Ÿå™¨</title>

    <link rel="stylesheet" href="report.css">
    <link rel="stylesheet" href="navbar.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><path d='M50 0L20 60H40L30 100L80 40H60L70 0Z' fill='%23c2a878'/></svg>">

    <style>
        /* ç§»é™¤ JS PCB æµ®æ°´å°æ¨£å¼ */
        body::before {
            content: none !important;
        }

        /* é‡å°æ–°çš„å ±è¡¨çµæ§‹èª¿æ•´ä¸»è¦å®¹å™¨ */
        body {
            background-color: #f5f5f5;
            margin: 0;
            font-family: 'Noto Sans TC', sans-serif;
        }

        .main-container {
            width: 100%;
            margin: 0 auto;
            padding: 0;
        }

        .logo-wrap,
        h1.page-title {
            display: none;
        }

        .info-grid-custom {
            display: grid;
            grid-template-columns: 1fr;
            gap: 8px;
            margin-bottom: 25px;
        }

        .info-item-custom {
            display: flex;
            align-items: flex-start;
            /* [ä¿®æ­£] æ”¹ç‚ºé ä¸Šå°é½Š */
            border-bottom: 1px solid #ddd;
            padding-bottom: 2px;
            /* height ç”±ä¸‹é¢ media query æ§åˆ¶ */
        }

        .info-item-custom .label {
            background-color: var(--label-bg, #f0ebde);
            color: #333;
            font-weight: 700;
            font-size: 14px;
            padding: 3px 10px;
            border-radius: 4px;
            width: 85px;
            text-align: center;
            margin-right: 8px;
            flex-shrink: 0;
            border: 1px solid var(--gold-dark, #e0d8c8);
            margin-top: 3px;
            /* [ä¿®æ­£] å¢åŠ é ‚éƒ¨é–“è·ä»¥å°é½Šå³å´å…§å®¹ */
        }

        .info-content-wrap {
            flex-grow: 1;
            display: flex;
            align-items: center;
            gap: 8px;
            /* [ä¿®æ­£] å…è¨±æŠ˜è¡Œï¼Œä»¥ä¾¿è®“è­¦å‘Šè¨Šæ¯æ›è¡Œé¡¯ç¤º */
            flex-wrap: wrap;
        }

        .warning {
            color: #ef4444;
            font-size: 13px;
            margin-left: 93px;
            margin-top: 5px;
            padding-left: 35px;
            margin-bottom: -5px;
        }

        .input-line-custom {
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
            outline: none;
            font-size: 14px;
            font-family: 'Noto Sans TC', sans-serif;
            width: 100%;
            padding: 6px 8px;
            /* [ä¿®æ­£] èª¿æ•´ padding ä»¥é…åˆæŒ‰éˆ•é«˜åº¦ */
            color: #000;
            transition: all 0.2s ease;
            box-sizing: border-box;
            /* [ä¿®æ­£] ç¢ºä¿é«˜åº¦è¨ˆç®—ä¸€è‡´ */
            height: 33px;
            /* [ä¿®æ­£] å¼·åˆ¶é«˜åº¦èˆ‡æŒ‰éˆ•ä¸€è‡´ (33px) */
        }

        .input-line-custom:focus {
            border-color: var(--gold-dark);
            box-shadow: 0 0 0 3px rgba(179, 135, 40, 0.1);
        }

        .custom-input-wrapper {
            display: none;
            width: 100%;
            align-items: center;
            gap: 5px;
        }

        .custom-input-wrapper input {
            flex-grow: 1;
            width: auto !important;
            border-radius: 4px;
            padding: 4px 8px;
            font-size: 14px;
        }

        .reset-btn {
            width: 24px;
            height: 24px;
            line-height: 1;
            font-size: 14px;
            flex-shrink: 0;
        }

        .page-container {
            width: 100%;
            display: flex;
            justify-content: center;
            padding: 20px;
            padding-bottom: 40px;
            box-sizing: border-box;
        }

        .a4-paper {
            width: 210mm;
            min-height: 297mm;
            background: var(--bg-page);
            padding: 15mm 15mm;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            box-sizing: border-box;
            display: flex;
            flex-direction: column;
            position: relative;
            margin: 0;
        }

        .remarks-container {
            margin-bottom: 20px;
        }

        .remarks-input {
            min-height: 90px !important;
            resize: vertical;
        }

        .output-area {
            margin-top: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 6px;
            background-color: #fff;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }

        #output-text {
            width: 90%;
            min-height: 400px;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            font-size: 14px;
            line-height: 1.6;
            resize: vertical;
            display: block;
            margin: 0 auto;
        }

        .output-label {
            font-size: 14px;
            font-weight: 700;
            color: #333;
            margin-bottom: 5px;
            display: block;
        }

        .btn-row {
            display: flex;
            justify-content: center;
            gap: 15px;
            margin: 20px 0 20px 0;
            flex-wrap: wrap;
            /* é¿å…æ‰‹æ©Ÿç‰ˆçˆ†ç‰ˆ */
        }
    </style>
    <style>
        /* === æ–°å¢ï¼šé›»è…¦ç‰ˆæŒ‰éˆ•é¸é …æ¨£å¼ === */
        .desktop-option-group {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            /* å¢åŠ é–“è· */
            row-gap: 10px;
            /* å¢åŠ è¡Œè· */
            width: 100%;
            margin-bottom: 8px;
            /* å¢åŠ åº•éƒ¨é–“è·é¿å…è²¼åˆ */
        }

        .option-btn {
            padding: 6px 12px;
            border: 1px solid #ccc;
            background-color: #fff;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            color: #333;
            min-width: 60px;
            /* [ä¿®æ­£] ç‚ºäº†å³ä¸‹è§’æ‰“å‹¾ */
            position: relative;
            overflow: hidden;
        }

        .option-btn:hover {
            background-color: #f0f0f0;
            border-color: #bbb;
        }

        .option-btn.selected {
            background-color: #fdfae8;
            border-color: var(--gold-dark, #b38728);
            color: #806600;
            font-weight: bold;
            box-shadow: 0 0 0 1px var(--gold-dark, #b38728) inset;
        }

        /* [ä¿®æ­£] é¸å–æ™‚å³ä¸‹è§’é¡¯ç¤ºæ‰“å‹¾ä¸‰è§’å½¢ */
        .option-btn.selected::after {
            content: 'âœ”';
            position: absolute;
            bottom: 0;
            right: 0;
            font-size: 10px;
            color: #fff;
            background-color: var(--gold-dark, #b38728);
            padding: 2px 2px 1px 5px;
            /* ä¸Š å³ ä¸‹ å·¦ padding å¾®èª¿ä»¥ç½®ä¸­å‹¾å‹¾ */
            clip-path: polygon(0 100%, 100% 100%, 100% 0);
            /* ä¸‰è§’å½¢è£åˆ‡ */
            line-height: 1;
        }

        .option-btn:disabled,
        .option-btn.disabled {
            opacity: 0.5;
            cursor: not-allowed;
            background-color: #eee;
            color: #999;
            border-color: #ddd;
            text-decoration: line-through;
        }

        /* === æ–°å¢ï¼šç‰¹æ®Šè£½ç¨‹å¤šé¸å€å¡Š (æ‰‹æ©Ÿ/é›»è…¦å…±ç”¨) === */
        .special-process-container {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            padding: 0;
            /* [ä¿®æ­£] ç§»é™¤å…§è·ä»¥å°é½Šå·¦å´ Label */
            width: 100%;
        }

        /* === RWD é¡¯ç¤ºæ§åˆ¶ === */
        /* é è¨­ (é›»è…¦ç‰ˆ)ï¼šéš±è— selectï¼Œé¡¯ç¤ºæŒ‰éˆ•ç¾¤çµ„ */
        @media (min-width: 769px) {

            /* [ä¿®æ­£] é›»è…¦ç‰ˆè¦ç¢ºä¿å®¹å™¨é«˜åº¦èƒ½è‡ªé©æ‡‰ï¼Œé¿å…æŒ‰éˆ•è¢«åˆ‡æ‰æˆ–æ“ å£“ */
            .info-item-custom {
                height: auto !important;
                min-height: 34px;
                padding-bottom: 8px;
                /* å¢åŠ åˆ—èˆ‡åˆ—ä¹‹é–“çš„å‘¼å¸ç©ºé–“ */
            }

            .input-line-custom {
                display: none;
            }

            /* è‡ªè¨‚è¼¸å…¥æ¡†æœ¬èº«çš„ input é‚„æ˜¯è¦é¡¯ç¤ºï¼Œåªè¦éš±è— select */
            input.input-line-custom,
            textarea.input-line-custom {
                display: block;
            }

            /* [ä¿®æ­£] é€£ç‰‡é…ç½®å·¥å…·å…§çš„ select è¦é¡¯ç¤º */
            #panelization_tool select.input-line-custom {
                display: block;
            }

            /* ç‰¹æ®Šè™•ç†ï¼šå¦‚æœæœ‰ custom-input-wrapper é¡¯ç¤ºæ™‚ï¼ŒæŒ‰éˆ•ç¾¤çµ„è¦éš±è— (é€é JS æ§åˆ¶ .hidden) */
            .desktop-option-group.hidden {
                display: none;
            }
        }

        /* æ‰‹æ©Ÿç‰ˆï¼šéš±è—æŒ‰éˆ•ç¾¤çµ„ï¼Œé¡¯ç¤º select */
        @media (max-width: 768px) {
            .desktop-option-group {
                display: none !important;
            }

            .input-line-custom {
                display: block !important;
            }

            .page-container {
                padding: 5px;
                padding-bottom: 20px !important;
            }

            .a4-paper {
                width: 100%;
                min-height: auto;
                padding: 15px;
                box-shadow: none;
                margin: 0;
            }

            #output-text {
                width: 90% !important;
                margin: 0 auto !important;
            }

            .warning {
                margin-left: 93px !important;
                margin-top: 5px;
                padding-left: 35px !important;
                margin-bottom: -5px;
            }

            .info-item-custom {
                display: flex !important;
                flex-direction: row !important;
                align-items: flex-start !important;
                /* [ä¿®æ­£] æ”¹ç‚ºé ä¸Šå°é½Šï¼Œé…åˆå¤šè¡Œç‰¹æ®Šè£½ç¨‹ */
                height: auto;
                padding-bottom: 5px;
                border-bottom: 1px solid #ddd;
            }

            .info-item-custom .label {
                width: 85px !important;
                margin-right: 8px !important;
                margin-bottom: 0px !important;
                flex-shrink: 0 !important;
                text-align: center;
                margin-top: 5px !important;
                /* [ä¿®æ­£] å¢åŠ é ‚éƒ¨é–“è·ä»¥å°é½ŠåŠ å¤§çš„è¼¸å…¥æ¡† (38px - 28px) / 2 */
            }

            /* [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆåŠ å¤§è¼¸å…¥æ¡†èˆ‡ Select é«˜åº¦ (è§¸æ§å‹å–„) ä¸¦å°é½Š */
            .input-line-custom,
            select.input-line-custom {
                display: block !important;
                height: 38px !important;
                box-sizing: border-box !important;
                padding: 6px 8px !important;
                margin: 0 !important;
                font-size: 16px;
                /* é˜²æ­¢ iOS Zoom */
            }

            /* [ä¿®æ­£] æ‰‹æ©Ÿç‰ˆç‰¹æ®Šè£½ç¨‹æŒ‰éˆ•åŠ å¤§ */
            .option-btn {
                min-height: 38px;
                padding: 8px 12px;
            }

            .info-content-wrap {
                width: auto !important;
                flex-grow: 1 !important;
            }

            .btn-row {
                flex-direction: column;
                align-items: stretch;
            }

            /* [ä¿®æ­£] æ’ç‰ˆå°å·¥å…·å…§çš„è¼¸å…¥æ¡†åœ¨æ‰‹æ©Ÿç‰ˆè‡ªé©æ‡‰ */
            #panelization_tool .info-content-wrap {
                gap: 5px;
                flex-wrap: nowrap !important;
                /* ä¸æ›è¡Œï¼Œè®“è¼¸å…¥æ¡†è‡ªå‹•ç¸®å° */
                overflow-x: hidden;
                /* éš±è—æ²è»¸ */
                width: 100%;
            }

            #panelization_tool input.input-line-custom {
                width: 0 !important;
                /* è®“ flex-grow æ±ºå®šå¯¬åº¦ */
                flex-grow: 1;
                min-width: 40px;
                /* è¨­å®šæœ€å°å¯¬åº¦é¿å…å¤ªçª„ */
                display: inline-block !important;
                margin: 0 !important;
                height: 38px !important;
                text-align: center;
                padding: 0 !important;
                /* æ¸›å°‘ padding å¢åŠ è¼¸å…¥ç©ºé–“ */
            }

            /* é¿å… X ç¬¦è™Ÿæˆ–å–®ä½æ“ å£“ */
            #panelization_tool span {
                flex-shrink: 0;
                white-space: nowrap;
                font-size: 14px;
            }
        }

        /* ç‰¹æ®Šè£½ç¨‹å€å¡Šï¼šéš±è—åŸå§‹çš„ select è¡Œï¼Œæ”¹ç”¨æ–° UI */
        .original-special-row {
            display: none !important;
        }
    </style>
</head>

<body>

    <div id="navbar-container"></div>
    <script src="navbar.js"></script>

    <div class="page-container">
        <div class="a4-paper">

            <div id="unified-header-container" data-title="è¦æ ¼ç”¢ç”Ÿå™¨" data-simple="true"></div>

            <section class="info-grid-custom">

                <div class="info-item-custom">
                    <span class="label">æ–™è™Ÿ</span>
                    <div class="info-content-wrap">
                        <input type="text" id="partNo" class="input-line-custom" placeholder="(é¸å¡«)"
                            style="text-transform: uppercase;" oninput="this.value = this.value.toUpperCase();" />
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">æ¿æ</span>
                        <div class="info-content-wrap">
                            <select id="material" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option selected>FR-4</option>
                                <option>FR-1</option>
                                <option>é‹åŸºæ¿</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="material_custom_div" class="custom-input-wrapper">
                                <input type="text" id="material_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥æ¿æ"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('material')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                            <div id="materialWarning" class="warning"
                                style="display:none; width: 100%; margin-top: 5px; margin-left: 0 !important;">
                                FR-1 äº¤æœŸè¼ƒé•·ï¼Œå»ºè­°ä»¥ FR-4 è£½ä½œ
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">å±¤åˆ¥</span>
                        <div class="info-content-wrap">
                            <select id="layers" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option>å–®é¢æ¿</option>
                                <option selected>é›™é¢æ¿</option>
                                <option>å››å±¤æ¿</option>
                                <option>å…­å±¤æ¿</option>
                                <option>å…«å±¤æ¿</option>
                                <option>åå±¤æ¿</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">æˆå“æ¿åš</span>
                        <div class="info-content-wrap">
                            <select id="thickness" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option value="0.4 mm">0.4 mm</option>
                                <option value="0.6 mm">0.6 mm</option>
                                <option value="0.8 mm">0.8 mm</option>
                                <option value="1.0 mm">1.0 mm</option>
                                <option value="1.2 mm">1.2 mm</option>
                                <option value="1.6 mm" selected>1.6 mm</option>
                                <option value="2.0 mm">2.0 mm</option>
                                <option value="2.4 mm">2.4 mm</option>
                                <option value="3.0 mm">3.0 mm</option>
                                <option value="3.2 mm">3.2 mm</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="thickness_custom_div" class="custom-input-wrapper">
                                <input type="text" id="thickness_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥æ¿åš"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('thickness')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                            <!-- [ä¿®æ­£] å°‡è­¦å‘Šç§»è‡³ info-content-wrap å…§ -->
                            <div id="thicknessWarning" class="warning"
                                style="display:none; width: 100%; margin-top: 5px; margin-left: 0 !important;">
                                æ¿åš 0.4 mm å¤ªè–„ï¼Œç„¡æ³•é€²è¡Œ V-Cutã€‚è‹¥éœ€æ‹¼æ¿ï¼Œå»ºè­°æ¡ç”¨éƒµç¥¨å­”è¨­è¨ˆã€‚
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">å…§å±¤éŠ…åš</span>
                        <div class="info-content-wrap">
                            <select id="innerCu" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option>0.5 oz</option>
                                <option>1 oz</option>
                                <option>2 oz</option>
                            </select>
                            <!-- [ä¿®æ­£] å°‡è­¦å‘Šç§»è‡³ info-content-wrap å…§ï¼Œä½¿å…¶æ›´ç·Šè²¼æ¬„ä½ -->
                            <div id="innerCuWarning" class="warning"
                                style="display:none; width: 100%; margin-top: 5px; margin-left: 0 !important;">
                                å–®é¢æ¿ã€é›™é¢æ¿ä¸æ”¯æ´å…§å±¤éŠ…åš
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">å¤–å±¤éŠ…åš</span>
                        <div class="info-content-wrap">
                            <select id="outerCu" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option selected>1 oz</option>
                                <option>2 oz</option>
                                <option>3 oz</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">é˜²ç„Šé¡è‰²</span>
                        <div class="info-content-wrap">
                            <select id="solderMask" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option value="ç¶ è‰²" selected>ğŸŸ¢ ç¶ è‰²</option>
                                <option value="è—è‰²">ğŸ”µ è—è‰²</option>
                                <option value="é»‘è‰²">âš« é»‘è‰²</option>
                                <option value="ç™½è‰²">âšª ç™½è‰²</option>
                                <option value="ç´…è‰²">ğŸ”´ ç´…è‰²</option>
                                <option value="é»ƒè‰²">ğŸŸ¡ é»ƒè‰²</option>
                                <option value="ç„¡"> ç„¡</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="solderMask_custom_div" class="custom-input-wrapper">
                                <input type="text" id="solderMask_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥é˜²ç„Šé¡è‰²"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('solderMask')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">æ–‡å­—é¡è‰²</span>
                        <div class="info-content-wrap">
                            <select id="legendColor" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option value="ç™½å­—" selected>âšª ç™½å­—</option>
                                <option value="é»‘å­—">âš« é»‘å­—</option>
                                <option value="ç„¡">ç„¡</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="legendColor_custom_div" class="custom-input-wrapper">
                                <input type="text" id="legendColor_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥æ–‡å­—é¡è‰²"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('legendColor')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">è¡¨é¢è™•ç†</span>
                        <div class="info-content-wrap">
                            <select id="finish" class="input-line-custom" onchange="onSelectChange(this)">
                                <option value="-">-</option>
                                <option value="æœ‰é‰›å™´éŒ«">æœ‰é‰›å™´éŒ«</option>
                                <option value="ç„¡é‰›å™´éŒ«" selected>ç„¡é‰›å™´éŒ«</option>
                                <option value="åŒ–é‡‘ 1u">åŒ–é‡‘ 1u"</option>
                                <option value="åŒ–é‡‘ 2u">åŒ–é‡‘ 2u"</option>
                                <option value="åŒ–é‡‘ 3u">åŒ–é‡‘ 3u"</option>
                                <option value="ç¡¬é‡‘ 3u">ç¡¬é‡‘ 3u"</option>
                                <option value="ç¡¬é‡‘ 5u">ç¡¬é‡‘ 5u"</option>
                                <option value="OSP">OSP</option>
                                <option value="è£¸éŠ…">è£¸éŠ…</option>
                            </select>
                        </div>
                    </div>
                    <div id="finishWarning" class="warning" style="display:none;">
                        å…­å±¤æ¿ä»¥ä¸Šï¼Œçµ±ä¸€è£½åšåŒ–é‡‘ 2u è¡¨é¢è™•ç†
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">é‡‘(éŒ«)æ‰‹æŒ‡</span>
                        <div class="info-content-wrap">
                            <select id="goldFinger" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option>æ–œé‚Š30Â°</option>
                                <option>æ–œé‚Š45Â°</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">é›»æ€§æ¸¬è©¦</span>
                        <div class="info-content-wrap">
                            <select id="testMethod" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option selected>å…¨æ¸¬</option>
                                <option>æŠ½æ¸¬</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">ç‰¹æ®Šè£½ç¨‹#1</span>
                        <div class="info-content-wrap">
                            <select id="special1" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option>åŠå­”</option>
                                <option>å¡å­”</option>
                                <option>æ¨¹è„‚å¡å­”</option>
                                <option>BGA</option>
                                <option>å´é‚ŠééŠ…</option>
                                <option>é˜»æŠ—è¦æ±‚</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="special1_custom_div" class="custom-input-wrapper">
                                <input type="text" id="special1_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥ç‰¹æ®Šè£½ç¨‹"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('special1')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                        </div>
                    </div>
                    <div id="special1Warning" class="warning" style="display:none;">
                        å…­å±¤æ¿ä»¥ä¸Šï¼Œçµ±ä¸€è£½ä½œæ¨¹è„‚å¡å­”è£½ç¨‹
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">ç‰¹æ®Šè£½ç¨‹#2</span>
                        <div class="info-content-wrap">
                            <select id="special2" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option>åŠå­”</option>
                                <option>å¡å­”</option>
                                <option>æ¨¹è„‚å¡å­”</option>
                                <option>BGA</option>
                                <option>å´é‚ŠééŠ…</option>
                                <option>é˜»æŠ—è¦æ±‚</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="special2_custom_div" class="custom-input-wrapper">
                                <input type="text" id="special2_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥ç‰¹æ®Šè£½ç¨‹"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('special2')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">ç‰¹æ®Šè£½ç¨‹#3</span>
                        <div class="info-content-wrap">
                            <select id="special3" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option>åŠå­”</option>
                                <option>å¡å­”</option>
                                <option>æ¨¹è„‚å¡å­”</option>
                                <option>BGA</option>
                                <option>å´é‚ŠééŠ…</option>
                                <option>é˜»æŠ—è¦æ±‚</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="special3_custom_div" class="custom-input-wrapper">
                                <input type="text" id="special3_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥ç‰¹æ®Šè£½ç¨‹"
                                    class="input-line-custom" />
                                <button type="button" class="reset-btn" onclick="resetSelect('special3')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-item-custom">
                        <span class="label">æ•¸é‡(å‡ºè²¨ç‰‡)</span>
                        <div class="info-content-wrap">
                            <select id="qty" class="input-line-custom" onchange="onSelectChange(this)">
                                <option>-</option>
                                <option selected>5</option>
                                <option>10</option>
                                <option>15</option>
                                <option>20</option>
                                <option>25</option>
                                <option>30</option>
                                <option>50</option>
                                <option>75</option>
                                <option>100</option>
                                <option>125</option>
                                <option>150</option>
                                <option>200</option>
                                <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                            </select>
                            <div id="qty_custom_div" class="custom-input-wrapper">
                                <input type="text" id="qty_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥æ•¸é‡" class="input-line-custom"
                                    oninput="formatNumber(this)" />
                                <button type="button" class="reset-btn" onclick="resetSelect('qty')"
                                    title="åˆ‡æ›å›é¸å–®">Ã—</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="info-item-custom">
                    <span class="label">è¨‚å–®é‡‘é¡</span>
                    <div class="info-content-wrap">
                        <input type="text" id="specialAmount" inputmode="numeric" oninput="formatNumber(this)"
                            placeholder="è«‹è¼¸å…¥é‡‘é¡" class="input-line-custom" />
                    </div>
                </div>

                <div class="field-group-wrap">
                    <div class="info-content-wrap" style="width: 100%;">
                        <div id="unified-remarks-container" data-hide-signature="true" data-remarks-label="è¨‚å–®å‚™è¨»"></div>
                    </div>
                </div>

                <!-- å·¥ç¨‹è£½ä½œèªªæ˜å€å¡Š -->
                <div class="engineering-section-container"
                    style="margin-top: 30px; padding: 20px; background-color: #f9f9f9; border: 2px solid #e0e0e0; border-radius: 8px; display: flex; flex-direction: column; gap: 15px;">
                    <h3
                        style="margin-top: 0; margin-bottom: 5px; padding-bottom: 10px; border-bottom: 2px solid #4CAF50; color: #2E7D32; font-size: 1.25em; display: flex; align-items: center;">
                        <span
                            style="background: #4CAF50; width: 4px; height: 1.2em; display: inline-block; margin-right: 10px;"></span>
                        å·¥ç¨‹è£½ä½œèªªæ˜
                    </h3>


                    <!-- å°ºå¯¸æ¬„ä½å·²ç§»é™¤ï¼Œæ”¹ç”¨é€£ç‰‡é…ç½®å·¥å…·å…§çš„å–®ç‰‡å°ºå¯¸ -->

                    <div class="field-group-wrap">
                        <div class="info-item-custom">
                            <span class="label">UL</span>
                            <div class="info-content-wrap">
                                <select id="ulOption" class="input-line-custom" onchange="onSelectChange(this)">
                                    <option>-</option>
                                    <option>ä¸éœ€è¦</option>
                                    <option>éœ€è¦(æ¯PCS)</option>
                                    <option>éœ€è¦(æŠ˜æ–·é‚Šä¸Š)</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field-group-wrap">
                        <div class="info-item-custom">
                            <span class="label">é€±æœŸ</span>
                            <div class="info-content-wrap">
                                <select id="dateCodeOption" class="input-line-custom" onchange="onSelectChange(this)">
                                    <option>-</option>
                                    <option>ä¸éœ€è¦</option>
                                    <option>éœ€è¦(æ¯PCS)</option>
                                    <option>éœ€è¦(æŠ˜æ–·é‚Šä¸Š)</option>
                                    <option value="custom">è‡ªè¡Œè¼¸å…¥</option>
                                </select>
                                <div id="dateCodeOption_custom_div" class="custom-input-wrapper">
                                    <input type="text" id="dateCodeOption_custom" placeholder="è«‹è‡ªè¡Œè¼¸å…¥é€±æœŸè¦æ±‚"
                                        class="input-line-custom" />
                                    <button type="button" class="reset-btn" onclick="resetSelect('dateCodeOption')"
                                        title="åˆ‡æ›å›é¸å–®">Ã—</button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="field-group-wrap">
                        <div class="info-item-custom">
                            <span class="label">å‡ºè²¨æ–¹å¼</span>
                            <div class="info-content-wrap">
                                <select id="shippingMethod" class="input-line-custom" onchange="onSelectChange(this)">
                                    <option>-</option>
                                    <option>å–®ç‰‡å‡ºè²¨</option>
                                    <option>é€£ç‰‡å‡ºè²¨</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="field-group-wrap" id="panelizingMethod_wrapper" style="display: none;">
                        <div class="info-item-custom">
                            <span class="label">é€£ç‰‡æ–¹å¼</span>
                            <div class="info-content-wrap">
                                <select id="panelizingMethod" class="input-line-custom" onchange="onSelectChange(this)">
                                    <option>-</option>
                                    <option>ç…§æª”æ¡ˆè£½ä½œ</option>
                                    <option>å·¥ç¨‹ä»£æ’ç‰ˆ</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- å·¥ç¨‹å‚™è¨» -->
                    <div class="field-group-wrap">
                        <div class="info-item-custom" style="height: auto;">
                            <span class="label">å·¥ç¨‹å‚™è¨»</span>
                            <div class="info-content-wrap">
                                <textarea id="engRemarkInput" class="input-line-custom"
                                    style="width: 100%; height: 80px; resize: vertical; border: 1px solid #ccc !important; padding: 8px; border-radius: 4px; background: #fff !important;"
                                    placeholder="è«‹è¼¸å…¥å·¥ç¨‹ç›¸é—œå‚™è¨»..."></textarea>
                            </div>
                        </div>
                    </div>

                    <!-- é€£ç‰‡é…ç½®å·¥å…· (ç•¶é¸æ“‡ã€Œå·¥ç¨‹ä»£æ’ç‰ˆã€æ™‚é¡¯ç¤º) -->
                    <div id="panelization_tool" class="field-group-wrap"
                        style="display: none; margin-top: 15px; padding: 15px; background: #fafafa; border: 1px solid #ddd; border-radius: 8px;">
                        <h4
                            style="margin-top: 0; margin-bottom: 15px; color: #333; border-bottom: 2px solid #4CAF50; padding-bottom: 5px; display: inline-block;">
                            æ’ç‰ˆå°å·¥å…·</h4>

                        <!-- å–®ç‰‡å°ºå¯¸ -->
                        <div class="info-item-custom" style="border-bottom: none; margin-bottom: 10px;">
                            <span class="label">å–®ç‰‡å°ºå¯¸</span>
                            <div class="info-content-wrap" style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" id="panelSingleX" placeholder="X" class="input-line-custom"
                                    style="width: 70px;" oninput="updatePanelPreview()" />
                                <span>Ã—</span>
                                <input type="text" id="panelSingleY" placeholder="Y" class="input-line-custom"
                                    style="width: 70px;" oninput="updatePanelPreview()" />
                                <span>mm</span>
                            </div>
                        </div>

                        <!-- æ’ç‰ˆæ–¹å¼ -->
                        <div class="info-item-custom" style="border-bottom: none; margin-bottom: 10px;">
                            <span class="label">æ’ç‰ˆæ–¹å¼</span>
                            <div class="info-content-wrap" style="display: flex; gap: 5px; align-items: center;">
                                <input type="text" id="panelLayoutX" placeholder="åˆ—" class="input-line-custom"
                                    style="width: 50px;" value="1" oninput="updatePanelPreview()" />
                                <span>Ã—</span>
                                <input type="text" id="panelLayoutY" placeholder="è¡Œ" class="input-line-custom"
                                    style="width: 50px;" value="1" oninput="updatePanelPreview()" />
                            </div>
                        </div>

                        <!-- é–“è· -->
                        <div class="info-item-custom" style="border-bottom: none; margin-bottom: 10px;">
                            <span class="label">æ’ç‰ˆé–“è·</span>
                            <div class="info-content-wrap" style="display: flex; gap: 5px; align-items: center;">
                                <span>X:</span>
                                <input type="text" id="panelSpacingX" placeholder="0" class="input-line-custom"
                                    style="width: 50px;" value="0" oninput="updatePanelPreview()" />
                                <span>Y:</span>
                                <input type="text" id="panelSpacingY" placeholder="0" class="input-line-custom"
                                    style="width: 50px;" value="0" oninput="updatePanelPreview()" />
                                <span>mm</span>
                            </div>
                        </div>

                        <!-- æŠ˜æ–·é‚Š -->
                        <div class="info-item-custom" style="border-bottom: none; margin-bottom: 10px;">
                            <span class="label">æŠ˜æ–·é‚Š</span>
                            <div class="info-content-wrap" style="display: flex; gap: 8px; align-items: center;">
                                <select id="panelBreakPos" class="input-line-custom" style="width: 80px;"
                                    onchange="updatePanelPreview()">
                                    <option value="none">ç„¡</option>
                                    <option value="lr">å·¦å³</option>
                                    <option value="tb">ä¸Šä¸‹</option>
                                    <option value="all" selected>å››å‘¨</option>
                                </select>
                                <input type="text" id="panelBreakWidth" placeholder="5" class="input-line-custom"
                                    style="width: 50px;" value="5" oninput="updatePanelPreview()" />
                                <span>mm</span>
                            </div>
                        </div>

                        <!-- æ’ç‰ˆå¾Œå°ºå¯¸ -->
                        <div class="info-item-custom"
                            style="border-bottom: none; background: #e8f4e8; padding: 10px; border-radius: 4px; margin-bottom: 15px;">
                            <span class="label" style="background: #4CAF50; color: white;">æ’ç‰ˆå¾Œå°ºå¯¸</span>
                            <span id="panelResultSize"
                                style="font-weight: bold; font-size: 18px; color: #2e7d32; margin-left: 10px;">-- Ã— --
                                mm</span>
                        </div>

                        <!-- é è¦½åœ–å€å¡Š (ç½®æ–¼ä¸‹æ–¹ï¼Œæ›´å¤§) -->
                        <div
                            style="display: flex; justify-content: center; align-items: center; padding: 10px; background: #1a1a2e; border-radius: 4px;">
                            <canvas id="panelPreviewCanvas" width="650" height="450" style="max-width: 100%;"></canvas>
                        </div>
                    </div>

                </div> <!-- End of engineering-section-container -->

            </section>



            <div class="btn-row">
                <button type="button" class="btn-glass-base btn-glass-gold"
                    onclick="generateAndCopyText()">ä¸€éµç”Ÿæˆ+è¤‡è£½</button>
                <button type="button" class="btn-glass-base btn-glass-red" onclick="resetAllFields()">æ¸…ç©ºé‡å¡«</button>
            </div>

            <div class="output-area">
                <span class="output-label">è¦æ ¼è¨Šæ¯</span>
                <textarea id="output-text" placeholder="é»æ“Šã€Œç”Ÿæˆæ–‡å­—ã€æŒ‰éˆ•å¾Œï¼Œæœƒåœ¨æ­¤è™•é¡¯ç¤ºå®Œæ•´çš„ PCB è¦æ ¼è³‡è¨Š" readonly></textarea>
            </div>

        </div>
    </div>

    <script src="template.js"></script>

    <script>
        function formatNumber(input) {
            var value = input.value.replace(/\D/g, "");
            if (value) {
                input.value = Number(value).toLocaleString("en-US");
            } else {
                input.value = "";
            }
        }

        function checkCustom(selectEl) {
            if (selectEl.value === 'custom') {
                var customDivId = selectEl.id + '_custom_div';
                var customDiv = document.getElementById(customDivId);
                var customInput = document.getElementById(selectEl.id + '_custom');
                if (customDiv) {
                    selectEl.style.display = 'none';

                    // é›»è…¦ç‰ˆï¼šéš±è—æŒ‰éˆ•ç¾¤çµ„
                    const btnGroup = document.getElementById(`btn-group-${selectEl.id}`);
                    if (btnGroup) btnGroup.classList.add('hidden');

                    customDiv.style.display = 'flex';
                    // è‡ªå‹•èšç„¦
                    if (customInput) {
                        setTimeout(() => customInput.focus(), 50);
                    }
                }
                return true;
            }
            return false;
        }

        function resetSelect(selectId) {
            var selectEl = document.getElementById(selectId);
            var customDiv = document.getElementById(selectId + '_custom_div');
            var customInput = document.getElementById(selectId + '_custom');
            if (selectEl && customDiv) {
                customDiv.style.display = 'none';
                customInput.value = '';

                // [ä¿®æ­£] æ¢å¾© Select é¡¯ç¤ºé‚è¼¯
                // 1. å…ˆæ¸…é™¤ inline styleï¼Œè®“ CSS æ±ºå®š (æ‰‹æ©Ÿ block, é›»è…¦ none)
                selectEl.style.display = '';

                // 2. ç‰¹æ®Šä¾‹å¤–ï¼šQty åœ¨é›»è…¦ç‰ˆå¿…é ˆæ˜¯ block (å› ç‚º CSS è¨­å®š input-line-custom ç‚º none)
                if (selectId === 'qty') {
                    selectEl.style.setProperty('display', 'block', 'important');
                }

                // 3. æ¢å¾© Select å€¼
                selectEl.value = '-';

                // 4. æ¢å¾©æŒ‰éˆ•ç¾¤çµ„é¡¯ç¤º (é›»è…¦ç‰ˆ)
                const btnGroup = document.getElementById(`btn-group-${selectId}`);
                if (btnGroup) btnGroup.classList.remove('hidden');

                updateStates();
            }
        }

        function onSelectChange(el) {
            checkCustom(el);
            updateStates();
        }

        // [ä¿®æ”¹] ç”Ÿæˆæ–‡å­— + è¤‡è£½ + å­˜æª” (è‹¥æœ‰æ–™è™Ÿ)
        function generateAndCopyText() {
            generateText();
            // åªè¦æœ‰æœ›æœ‰å¡«æ–™è™Ÿå°±å„²å­˜ç´€éŒ„ï¼Œä¸éœ€å®¢æˆ¶åç¨±
            if (getValue("partNo")) {
                if (typeof saveCurrentReportToHistory === 'function') saveCurrentReportToHistory();
            }
            copyText(true); // å‚³å…¥ true é¿å… copyText å†æ¬¡é‡è¤‡å„²å­˜
        }

        // [æ–°å¢] å°ˆé–€çµ¦ã€Œç”Ÿæˆæ–‡å­—ã€æŒ‰éˆ•ç”¨çš„å‡½å¼ï¼Œä¹Ÿæœƒè§¸ç™¼å­˜æª”
        function generateTextAndSave() {
            generateText();
            if (getValue("partNo")) {
                if (typeof saveCurrentReportToHistory === 'function') saveCurrentReportToHistory();
                window.showToast("è¦æ ¼å·²ç”Ÿæˆä¸¦å„²å­˜");
            }
        }

        // [ä¿®æ”¹] æ¸…ç©ºé‡å¡«åŠŸèƒ½ï¼šæ”¹ç‚ºé‡æ–°æ•´ç†é é¢ (ä¸¦ç§»é™¤ URL åƒæ•¸ä»¥é˜²è®€å–æ­·å²ç´€éŒ„)
        // [ä¿®æ”¹] æ¸…ç©ºé‡å¡«åŠŸèƒ½ï¼šæ”¹ç‚ºé‡æ–°æ•´ç†é é¢ (ä¸¦ç§»é™¤ URL åƒæ•¸ä»¥é˜²è®€å–æ­·å²ç´€éŒ„)
        function resetAllFields() {
            if (!confirm('ç¢ºå®šè¦æ¸…ç©ºæ‰€æœ‰æ¬„ä½å—ï¼Ÿ')) return;

            // ä½¿ç”¨ href split ä¾†ç¢ºä¿ä¿ç•™ protocol å’Œ drive letter (é‡å° file:// å”å®š)
            // é€™æ¨£å¯ä»¥å…¼å®¹ file: å’Œ http: å”è­°
            var cleanUrl = window.location.href.split('?')[0];
            window.location.href = cleanUrl;
        }

        // === æ–°å¢ï¼šUI åˆå§‹åŒ–èˆ‡äº’å‹•é‚è¼¯ ===

        // ä¸€èˆ¬é¸é … ID åˆ—è¡¨ (æ’é™¤ç‰¹æ®Šè£½ç¨‹èˆ‡æ•¸é‡)
        const GENERAL_SELECT_IDS = [
            'material', 'layers', 'thickness', 'innerCu', 'outerCu',
            'solderMask', 'legendColor', 'finish', 'goldFinger', 'testMethod',
            'ulOption', 'dateCodeOption', 'shippingMethod', 'panelizingMethod'
        ];

        // åˆå§‹åŒ–é›»è…¦ç‰ˆæŒ‰éˆ•é¸é …
        function initDesktopOptions() {
            // [ä¿®æ­£] é‡å°æ•¸é‡æ¬„ä½ï¼Œç¢ºä¿åœ¨é›»è…¦ç‰ˆé¡¯ç¤ºä¸‹æ‹‰é¸å–® (å› ç‚º CSS æŠŠ input-line-custom éš±è—äº†)
            const qtySelect = document.getElementById('qty');
            if (qtySelect) {
                // å¼·åˆ¶è¦†è“‹ media query çš„ display: none
                qtySelect.style.setProperty('display', 'block', 'important');
            }

            GENERAL_SELECT_IDS.forEach(id => {
                const select = document.getElementById(id);
                if (!select) return;

                const wrapper = select.parentNode;
                // å»ºç«‹æŒ‰éˆ•ç¾¤çµ„å®¹å™¨
                const btnGroup = document.createElement('div');
                btnGroup.className = 'desktop-option-group';
                btnGroup.id = `btn-group-${id}`;

                // éæ­·é¸é …å»ºç«‹æŒ‰éˆ•
                Array.from(select.options).forEach(opt => {
                    // è·³éé è¨­ "-" ç©ºé¸é …ï¼Œé™¤éå®ƒæ˜¯å”¯ä¸€é¸é … (ä¸å¤ªå¯èƒ½)
                    if (opt.value === '-' || opt.text === '-') return;

                    const btn = document.createElement('button');
                    btn.type = 'button';
                    btn.className = 'option-btn';

                    // [ä¿®æ­£] ä¿ç•™ emoji é¡è‰²é¡¯ç¤º
                    let btnText = opt.text;
                    // [ä¿®æ­£] æ¿åšæŒ‰éˆ•ä¸é¡¯ç¤º mm (ä½†ç”Ÿæˆæ–‡å­—ä¿ç•™) - é›»è…¦ç‰ˆ UI å„ªåŒ–éœ€æ±‚
                    if (id === 'thickness') {
                        btnText = btnText.replace(' mm', '');
                    }
                    btn.textContent = btnText;

                    btn.dataset.value = opt.value;

                    if (opt.value === 'custom') {
                        btn.textContent = 'è‡ªè¡Œè¼¸å…¥';
                    }

                    // é»æ“Šäº‹ä»¶
                    btn.onclick = () => {
                        select.value = opt.value;
                        // è§¸ç™¼åŸå§‹è®Šæ›´é‚è¼¯
                        onSelectChange(select);
                        // å¦‚æœæ˜¯ customï¼Œä»‹é¢æœƒç”± checkCustom è™•ç† (éš±è—æŒ‰éˆ•ç¾¤çµ„)
                    };

                    btnGroup.appendChild(btn);
                });

                // æ’å…¥åˆ° select ä¹‹å‰
                wrapper.insertBefore(btnGroup, select);
            });
        }

        // åˆå§‹åŒ–ç‰¹æ®Šè£½ç¨‹å¤šé¸å€å¡Š (å–ä»£åŸæœ‰çš„ä¸‰å€‹ select)
        function initSpecialProcessOptions() {
            // æ”¶é›†æ‰€æœ‰ç‰¹æ®Šè£½ç¨‹é¸é … (å¾ special1 æ‹¿å³å¯ï¼Œå‡è¨­éƒ½ä¸€æ¨£)
            const srcSelect = document.getElementById('special1');
            if (!srcSelect) return;

            const options = Array.from(srcSelect.options)
                .filter(opt => opt.value !== '-' && opt.value !== 'custom')
                .map(opt => ({ text: opt.text, value: opt.value }));

            // å»ºç«‹å®¹å™¨æ’å…¥åœ¨ special1 çš„ä½ç½®ä¹‹ä¸Š
            const refItem = document.getElementById('special1').closest('.info-item-custom').parentNode; // field-group-wrap
            const section = refItem.parentNode; // info-grid-custom

            const newRow = document.createElement('div');
            newRow.className = 'info-item-custom';
            newRow.style.height = 'auto'; // allow wrap (æ‰‹æ©Ÿç‰ˆä¹Ÿå¯èƒ½æŠ˜è¡Œ)
            newRow.innerHTML = `
          <span class="label">ç‰¹æ®Šè£½ç¨‹</span>
          <div class="info-content-wrap">
              <div class="special-process-container" id="special-multi-container">
                  <!-- JS ç”Ÿæˆ -->
              </div>
              <input type="hidden" id="specialProcess_full_list" />
          </div>
      `;

            section.insertBefore(newRow, refItem);

            const container = newRow.querySelector('.special-process-container');

            // ç›£è½ history load äº‹ä»¶ (é€é input event on hidden field)
            const hiddenInput = newRow.querySelector('#specialProcess_full_list');
            hiddenInput.addEventListener('input', function () {
                try {
                    const values = JSON.parse(this.value || '[]');
                    const btns = container.querySelectorAll('.option-btn');
                    btns.forEach(btn => {
                        if (values.includes(btn.dataset.value)) {
                            btn.classList.add('selected');
                        } else {
                            btn.classList.remove('selected');
                        }
                    });
                    // åŒæ­¥å› select (å‰3å€‹) ä»¥ç¬¦åˆé˜²å‘†é‚è¼¯
                    syncSpecialProcessToSelects(true); // true = é¿å…éè¿´æ›´æ–° hidden, just sync to selects
                } catch (e) { console.error('Error parsing special process history', e); }
            });

            // ç”Ÿæˆé¸é …æŒ‰éˆ•
            options.forEach(opt => {
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.className = 'option-btn';
                btn.textContent = opt.text;
                btn.dataset.value = opt.value;
                btn.onclick = () => toggleSpecialOption(btn);
                container.appendChild(btn);
            });

            // éš±è—åŸå§‹çš„ special1, special2, special3 å€å¡Š
            ['special1', 'special2', 'special3'].forEach(id => {
                const el = document.getElementById(id);
                if (el) {
                    const wrap = el.closest('.field-group-wrap');
                    if (wrap) wrap.classList.add('original-special-row');
                }
            });
        }

        // ç‰¹æ®Šè£½ç¨‹åˆ‡æ›é‚è¼¯
        function toggleSpecialOption(btn) {
            btn.classList.toggle('selected');
            syncSpecialProcessToSelects();
        }

        // å°‡å¤šé¸ç‹€æ…‹åŒæ­¥å›åŸæœ¬çš„ select (å‰3å€‹å¡«å…¥ï¼Œå…¶é¤˜ç•¥éï¼Œä½†å®Œæ•´æ¸…å–®å­˜å…¥ hidden)
        function syncSpecialProcessToSelects(skipHiddenUpdate = false) {
            const selectedBtns = document.querySelectorAll('#special-multi-container .option-btn.selected');
            const values = Array.from(selectedBtns).map(b => b.dataset.value);

            // 1. å¡«å…¥ hidden input (ä¾›æ­·å²å„²å­˜ç”¨)
            if (!skipHiddenUpdate) {
                const hiddenInput = document.getElementById('specialProcess_full_list');
                if (hiddenInput) hiddenInput.value = JSON.stringify(values);
            }

            // 2. å¡«å…¥ special1, 2, 3 (ä¾›æ—¢æœ‰é‚è¼¯æª¢æŸ¥ç”¨ï¼Œæœ€å¤š3å€‹)
            const targets = ['special1', 'special2', 'special3'];

            targets.forEach((id, index) => {
                const select = document.getElementById(id);
                if (select) {
                    if (index < values.length) {
                        select.value = values[index];
                    } else {
                        select.value = '-';
                    }
                }
            });

            // è§¸ç™¼å…¨åŸŸç‹€æ…‹æ›´æ–° (æª¢æŸ¥è¦å‰‡)
            updateStates();
        }

        // å¾ Select æ›´æ–°æŒ‰éˆ•ç‹€æ…‹ (ç”¨æ–¼ updateStates æ”¹è®Šäº† select å€¼ï¼Œæˆ–åˆ‡æ›å›é è¨­æ™‚)
        function updateButtonStates() {
            // 1. æ›´æ–°ä¸€èˆ¬é¸é …æŒ‰éˆ•
            GENERAL_SELECT_IDS.forEach(id => {
                const select = document.getElementById(id);
                const btnGroup = document.getElementById(`btn-group-${id}`);
                if (!select || !btnGroup) return;

                const currentVal = select.value;

                // è™•ç† "Custom" é¡¯ç¤ºç‹€æ…‹
                if (currentVal === 'custom') {
                    btnGroup.classList.add('hidden');
                } else {
                    btnGroup.classList.remove('hidden');
                }

                Array.from(btnGroup.children).forEach(btn => {
                    // Set Selected
                    if (btn.dataset.value === currentVal) {
                        btn.classList.add('selected');
                    } else {
                        btn.classList.remove('selected');
                    }

                    // Set Disabled
                    const opt = Array.from(select.options).find(o => o.value === btn.dataset.value);
                    // [ä¿®æ­£] å¦‚æœ option è¢« disabledï¼Œæˆ–æ•´å€‹ select è¢« disabled
                    if ((opt && opt.disabled) || select.disabled) {
                        btn.classList.add('disabled');
                        btn.disabled = true;
                    } else {
                        btn.classList.remove('disabled');
                        btn.disabled = false;
                    }
                });
            });

            // 2. æ›´æ–°ç‰¹æ®Šè£½ç¨‹æŒ‰éˆ•ç‹€æ…‹ (åå‘åŒæ­¥)
            // é€™è£¡åªéœ€è™•ç†è¦å‰‡å¼·åˆ¶ä¿®æ”¹çš„æƒ…æ³ (å¦‚å…­å±¤æ¿å¼·åˆ¶æ¨¹è„‚å¡å­”)
            // æˆ‘å€‘æª¢æŸ¥æ˜¯å¦æœ‰ selects ä¸­çš„å€¼æ˜¯è¢« disabled çš„ (ä»£è¡¨è¢«é–å®š)ï¼Œå¦‚æœæ˜¯ï¼Œå¼·åˆ¶æŒ‰éˆ•é¸å–
            // ä¸¦ç¶­æŒå…¶ä»–å·²é¸çš„æŒ‰éˆ•ç‹€æ…‹ (é™¤éè¡çª? ä½†ç‰¹æ®Šè£½ç¨‹æ˜¯å¤šé¸ï¼Œé€šå¸¸ä¸è¡çª)

            // ç°¡æ˜“é‚è¼¯ï¼šè®€å– selects ä¸­è¢«é–å®š (disabled) ä¸”æœ‰å€¼çš„é …ç›®ï¼Œå¼·åˆ¶åœ¨ UI ä¸Šè¨­ç‚º selected
            ['special1', 'special2', 'special3'].forEach(id => {
                const sel = document.getElementById(id);
                if (sel && sel.disabled && sel.value !== '-' && sel.value !== 'custom') {
                    // æ‰¾åˆ°å°æ‡‰æŒ‰éˆ•ä¸¦é¸å–
                    const btn = document.querySelector(`#special-multi-container .option-btn[data-value="${sel.value}"]`);
                    if (btn && !btn.classList.contains('selected')) {
                        btn.classList.add('selected');
                        // æ›´æ–° hidden ç¢ºä¿ consistency
                        syncSpecialProcessToSelects();
                    }
                }
            });
        }

        document.addEventListener('DOMContentLoaded', function () {
            // åˆå§‹åŒ–æ–° UI
            initDesktopOptions();
            initSpecialProcessOptions();

            document.querySelectorAll('.custom-input-wrapper input').forEach(input => {
                input.addEventListener('blur', function () {
                    if (this.value.trim() === '') {
                        const selectId = this.id.replace('_custom', '');
                        resetSelect(selectId);
                    }
                });
            });
            updateStates();
        });

        const SPEC_RULES = {
            locks: [
                {
                    rule: (material, layers) => ['å…­å±¤æ¿', 'å…«å±¤æ¿', 'åå±¤æ¿'].includes(layers),
                    target: 'finish',
                    action: (sel) => { sel.value = 'åŒ–é‡‘ 2u'; sel.disabled = true; document.getElementById('finishWarning').style.display = 'block'; }
                },

                {
                    rule: (material, layers) => ['å…­å±¤æ¿', 'å…«å±¤æ¿', 'åå±¤æ¿'].includes(layers),
                    target: 'special1',
                    action: (sel) => { sel.value = 'æ¨¹è„‚å¡å­”'; sel.disabled = true; document.getElementById('special1Warning').style.display = 'block'; }
                },
            ],
            restrictions: [
                {
                    rule: (material) => material === 'FR-1',
                    targets: [
                        { id: 'layers', disable_values: ['é›™é¢æ¿', 'å››å±¤æ¿', 'å…­å±¤æ¿', 'å…«å±¤æ¿', 'åå±¤æ¿'], default_value: 'å–®é¢æ¿', warning: 'materialWarning' },
                        { id: 'thickness', disable_values: ['0.4 mm', '0.6 mm', '0.8 mm', '1.0 mm', '1.2 mm', '2.0 mm', '2.4 mm', '3.0 mm', '3.2 mm'], default_value: '1.6 mm' },
                        { id: 'outerCu', disable_values: ['2 oz', '3 oz'], default_value: '1 oz' },
                        { id: 'goldFinger', disable_all: true, default_value: '-' },
                        { id: 'special1', disable_all: true, default_value: '-' },
                        { id: 'special2', disable_all: true, default_value: '-' },
                        { id: 'special3', disable_all: true, default_value: '-' },
                        { id: 'innerCu', disable_all: true, default_value: '-', warning: 'innerCuWarning' }
                    ]
                },
                {
                    rule: (material, layers) => ['å–®é¢æ¿', 'é›™é¢æ¿'].includes(layers),
                    targets: [
                        { id: 'innerCu', disable_all: true, default_value: '-', warning: 'innerCuWarning' }
                    ]
                },
                {
                    rule: (material, layers) => ['å››å±¤æ¿', 'å…­å±¤æ¿', 'å…«å±¤æ¿', 'åå±¤æ¿'].includes(layers),
                    targets: [
                        { id: 'thickness', disable_values: ['0.4 mm'], warning: 'thicknessWarning' }
                    ]
                },
                {
                    rule: (material, layers) => ['å…«å±¤æ¿', 'åå±¤æ¿'].includes(layers),
                    targets: [
                        { id: 'thickness', disable_values: ['0.4 mm', '0.6 mm'], warning: 'thicknessWarning' }
                    ]
                }
            ],
            defaults: [
                {
                    rule: (material, layers) => layers !== 'å–®é¢æ¿' && layers !== 'é›™é¢æ¿' && layers !== '-' && layers !== 'custom',
                    target: 'innerCu',
                    action: (sel, currentVal) => { if (currentVal === '-' || currentVal === '') sel.value = '0.5 oz'; }
                }
            ]
        };

        function updateStates() {
            const currentValues = {
                material: getValue("material"),
                layers: getValue("layers"),
                thickness: getValue("thickness"),
                innerCu: getValue("innerCu"),
                finish: getValue("finish"),
                special1: getValue("special1")
            };

            document.querySelectorAll('select').forEach(sel => {
                if (sel.id.startsWith('special') || sel.id === 'layers' || sel.id === 'thickness' || sel.id === 'innerCu' || sel.id === 'finish' || sel.id === 'outerCu' || sel.id === 'goldFinger' || sel.id === 'testMethod') {
                    sel.disabled = false;
                    Array.from(sel.options).forEach(opt => opt.disabled = false);
                }
            });
            document.querySelectorAll('.warning').forEach(warn => warn.style.display = 'none');

            SPEC_RULES.restrictions.forEach(restriction => {
                if (restriction.rule(currentValues.material, currentValues.layers)) {
                    restriction.targets.forEach(target => {
                        const sel = document.getElementById(target.id);
                        if (!sel || checkCustom(sel)) return;

                        if (target.warning) {
                            const warnEl = document.getElementById(target.warning);
                            if (warnEl) warnEl.style.display = 'block';
                        }

                        if (target.disable_all) {
                            sel.disabled = true;
                        } else if (target.disable_values) {
                            target.disable_values.forEach(val => {
                                const opt = sel.querySelector(`option[value="${val}"]`);
                                if (opt) opt.disabled = true;
                            });
                        }

                        const currentOpt = sel.options[sel.selectedIndex];
                        if (currentOpt && currentOpt.disabled && sel.value !== 'custom') {
                            sel.value = target.default_value;
                        }
                    });
                }
            });

            const thickness = getValue("thickness");
            if (thickness === "0.4 mm" && currentValues.material !== "FR-1") {
                const thicknessOpt = document.getElementById("thickness").options[document.getElementById("thickness").selectedIndex];
                if (thicknessOpt && !thicknessOpt.disabled) {
                    document.getElementById('thicknessWarning').style.display = 'block';
                }
            }

            SPEC_RULES.locks.forEach(lock => {
                const sel = document.getElementById(lock.target);
                if (lock.rule(currentValues.material, currentValues.layers) && !checkCustom(sel)) {
                    lock.action(sel);
                }
            });

            SPEC_RULES.defaults.forEach(defaultRule => {
                const sel = document.getElementById(defaultRule.target);
                if (defaultRule.rule(currentValues.material, currentValues.layers) && !checkCustom(sel)) {
                    defaultRule.action(sel, getValue(defaultRule.target));
                }
            });

            // [åŒæ­¥æŒ‰éˆ•ç‹€æ…‹]
            if (typeof updateButtonStates === 'function') {
                updateButtonStates();
            }

            // [æ–°å¢] é€£ç‰‡æ–¹å¼é¡¯ç¤ºé‚è¼¯
            const shippingMethod = getValue("shippingMethod");
            const panelWrapper = document.getElementById("panelizingMethod_wrapper");
            const panelTool = document.getElementById("panelization_tool");
            if (shippingMethod === "é€£ç‰‡å‡ºè²¨") {
                panelWrapper.style.display = "block";
                // é¡¯ç¤ºé€£ç‰‡é…ç½®å·¥å…· (ç•¶é¸æ“‡å·¥ç¨‹ä»£é€£ç‰‡æˆ–å·¥ç¨‹ä»£æ’ç‰ˆæ™‚)
                const panelMethod = getValue("panelizingMethod");
                if (panelMethod === "å·¥ç¨‹ä»£é€£ç‰‡" || panelMethod === "å·¥ç¨‹ä»£æ’ç‰ˆ") {
                    panelTool.style.display = "block";
                    updatePanelPreview();
                } else {
                    panelTool.style.display = "none";
                }
            } else {
                panelWrapper.style.display = "none";
                panelTool.style.display = "none";
                // éš±è—æ™‚é‡ç½®å€¼ï¼Œé¿å…èª¤å¸¶å…¥
                resetSelect('panelizingMethod');
            }
        }

        // [æ–°å¢] é€£ç‰‡é…ç½®é è¦½èˆ‡è¨ˆç®—
        function updatePanelPreview() {
            const singleX = parseFloat(document.getElementById('panelSingleX').value) || 0;
            const singleY = parseFloat(document.getElementById('panelSingleY').value) || 0;
            const layoutX = parseInt(document.getElementById('panelLayoutX').value) || 1;
            const layoutY = parseInt(document.getElementById('panelLayoutY').value) || 1;
            const breakPos = document.getElementById('panelBreakPos').value;
            const breakWidth = parseFloat(document.getElementById('panelBreakWidth').value) || 0;

            const spacingXInput = document.getElementById('panelSpacingX');
            const spacingYInput = document.getElementById('panelSpacingY');
            const breakWidthInput = document.getElementById('panelBreakWidth');
            const breakWidthLabel = breakWidthInput.nextElementSibling; // "mm" span

            // === é©—è­‰è¦å‰‡ ===
            // 1. åªæœ‰1åˆ—æ™‚ï¼ŒXé–“è·ç„¡æ„ç¾©
            // 2. åªæœ‰1è¡Œæ™‚ï¼ŒYé–“è·ç„¡æ„ç¾©
            // 3. æŠ˜æ–·é‚Šé¸æ“‡ã€Œä¸Šä¸‹ã€æ™‚ï¼Œæ¿å­å‚ç›´é€£æ¥ï¼ŒYé–“è·æ‡‰ç‚º0
            // 4. æŠ˜æ–·é‚Šé¸æ“‡ã€Œå·¦å³ã€æ™‚ï¼Œæ¿å­æ°´å¹³é€£æ¥ï¼ŒXé–“è·æ‡‰ç‚º0
            // 5. æŠ˜æ–·é‚Šé¸æ“‡ã€Œç„¡ã€æ™‚ï¼Œæ²’æœ‰æŠ˜æ–·é‚Šæ”¯æ’ï¼Œæ‰€æœ‰é–“è·å¿…é ˆç‚º0

            let allowSpacingX = layoutX > 1;
            let allowSpacingY = layoutY > 1;

            // å¦‚æœé¸æ“‡ã€Œç„¡ã€æŠ˜æ–·é‚Šï¼Œæ‰€æœ‰é–“è·éƒ½å¿…é ˆç‚º0
            if (breakPos === 'none') {
                allowSpacingX = false;
                allowSpacingY = false;
                // éš±è—æŠ˜æ–·é‚Šå¯¬åº¦è¼¸å…¥
                breakWidthInput.style.display = 'none';
                breakWidthLabel.style.display = 'none';
            } else {
                // é¡¯ç¤ºæŠ˜æ–·é‚Šå¯¬åº¦è¼¸å…¥
                breakWidthInput.style.display = 'block';
                breakWidthLabel.style.display = 'inline';
            }

            // å¦‚æœé¸æ“‡ã€Œä¸Šä¸‹ã€æŠ˜æ–·é‚Šï¼Œè¡¨ç¤ºæ¿å­å‚ç›´æ–¹å‘é€£æ¥ï¼ŒYä¸èƒ½æœ‰é–“è·
            if (breakPos === 'tb') {
                allowSpacingY = false;
            }
            // å¦‚æœé¸æ“‡ã€Œå·¦å³ã€æŠ˜æ–·é‚Šï¼Œè¡¨ç¤ºæ¿å­æ°´å¹³æ–¹å‘é€£æ¥ï¼ŒXä¸èƒ½æœ‰é–“è·
            if (breakPos === 'lr') {
                allowSpacingX = false;
            }

            // æ›´æ–°è¼¸å…¥æ¡†ç‹€æ…‹
            if (!allowSpacingX) {
                spacingXInput.value = '0';
                spacingXInput.disabled = true;
                spacingXInput.style.backgroundColor = '#eee';
            } else {
                spacingXInput.disabled = false;
                spacingXInput.style.backgroundColor = '#fff';
            }

            if (!allowSpacingY) {
                spacingYInput.value = '0';
                spacingYInput.disabled = true;
                spacingYInput.style.backgroundColor = '#eee';
            } else {
                spacingYInput.disabled = false;
                spacingYInput.style.backgroundColor = '#fff';
            }

            const spacingX = parseFloat(spacingXInput.value) || 0;
            const spacingY = parseFloat(spacingYInput.value) || 0;

            // è¨ˆç®—æ’ç‰ˆå¾Œå°ºå¯¸
            let panelW = (singleX * layoutX) + (spacingX * (layoutX - 1));
            let panelH = (singleY * layoutY) + (spacingY * (layoutY - 1));

            if (breakPos === 'lr' || breakPos === 'all') {
                panelW += breakWidth * 2;
            }
            if (breakPos === 'tb' || breakPos === 'all') {
                panelH += breakWidth * 2;
            }

            // æ›´æ–°é¡¯ç¤º
            const resultEl = document.getElementById('panelResultSize');
            if (singleX > 0 && singleY > 0) {
                resultEl.textContent = panelW.toFixed(1) + ' Ã— ' + panelH.toFixed(1) + ' mm';
            } else {
                resultEl.textContent = '-- Ã— -- mm';
            }

            // ç¹ªè£½é è¦½åœ–
            const canvas = document.getElementById('panelPreviewCanvas');
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            if (singleX <= 0 || singleY <= 0) return;

            // è¨ˆç®—ç¸®æ”¾æ¯”ä¾‹ (ç•™ç©ºé–“çµ¦å°ºå¯¸æ¨™è¨»)
            const padding = 50;
            const availW = canvas.width - padding * 2;
            const availH = canvas.height - padding * 2;
            const scale = Math.min(availW / panelW, availH / panelH);

            const drawW = panelW * scale;
            const drawH = panelH * scale;
            const offsetX = (canvas.width - drawW) / 2;
            const offsetY = padding;

            const boardW = singleX * scale;
            const boardH = singleY * scale;
            const gapW = spacingX * scale;
            const gapH = spacingY * scale;
            const breakScaleW = (breakPos === 'lr' || breakPos === 'all') ? breakWidth * scale : 0;
            const breakScaleH = (breakPos === 'tb' || breakPos === 'all') ? breakWidth * scale : 0;

            // è¨­å®šæ´‹ç´…è‰²ç·šæ¢
            ctx.strokeStyle = '#ff00ff';
            ctx.lineWidth = 1.5;

            // ç¹ªè£½å¤–æ¡† (æ•´å€‹é€£ç‰‡é¢æ¿)
            ctx.strokeRect(offsetX, offsetY, drawW, drawH);

            // è¨ˆç®—æ¿å­é™£åˆ—çš„èµ·å§‹ä½ç½®å’Œç¸½å°ºå¯¸
            const arrayStartX = offsetX + breakScaleW;
            const arrayStartY = offsetY + breakScaleH;
            const arrayW = (boardW * layoutX) + (gapW * (layoutX - 1));
            const arrayH = (boardH * layoutY) + (gapH * (layoutY - 1));

            // ç¹ªè£½å„å€‹æ¿å­
            for (let i = 0; i < layoutX; i++) {
                for (let j = 0; j < layoutY; j++) {
                    const x = arrayStartX + i * (boardW + gapW);
                    const y = arrayStartY + j * (boardH + gapH);
                    ctx.strokeRect(x, y, boardW, boardH);
                }
            }

            // ç¹ªè£½ V-cut ç·šæ¢ (åªåœ¨æ¿å­é™£åˆ—å€åŸŸå…§ï¼Œä¸å»¶ä¼¸åˆ°æŠ˜æ–·é‚Š)
            ctx.lineWidth = 1;
            // å‚ç›´åˆ†éš”ç·š (CNCæ§½)
            for (let i = 1; i < layoutX; i++) {
                const vx = arrayStartX + i * boardW + (i - 0.5) * gapW + gapW / 2;
                ctx.beginPath();
                ctx.moveTo(vx, arrayStartY);  // å¾æ¿å­é™£åˆ—é ‚éƒ¨é–‹å§‹
                ctx.lineTo(vx, arrayStartY + arrayH);  // åˆ°æ¿å­é™£åˆ—åº•éƒ¨çµæŸ
                ctx.stroke();
            }
            // æ°´å¹³åˆ†éš”ç·š (CNCæ§½)
            for (let j = 1; j < layoutY; j++) {
                const vy = arrayStartY + j * boardH + (j - 0.5) * gapH + gapH / 2;
                ctx.beginPath();
                ctx.moveTo(arrayStartX, vy);  // å¾æ¿å­é™£åˆ—å·¦å´é–‹å§‹
                ctx.lineTo(arrayStartX + arrayW, vy);  // åˆ°æ¿å­é™£åˆ—å³å´çµæŸ
                ctx.stroke();
            }

            // ç¹ªè£½æŠ˜æ–·é‚Šåˆ†éš”ç·š
            if (breakScaleW > 0) {
                ctx.beginPath();
                ctx.moveTo(arrayStartX, offsetY);
                ctx.lineTo(arrayStartX, offsetY + drawH);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(arrayStartX + arrayW, offsetY);
                ctx.lineTo(arrayStartX + arrayW, offsetY + drawH);
                ctx.stroke();
            }
            if (breakScaleH > 0) {
                ctx.beginPath();
                ctx.moveTo(offsetX, arrayStartY);
                ctx.lineTo(offsetX + drawW, arrayStartY);
                ctx.stroke();
                ctx.beginPath();
                ctx.moveTo(offsetX, arrayStartY + arrayH);
                ctx.lineTo(offsetX + drawW, arrayStartY + arrayH);
                ctx.stroke();
            }

            // ç¹ªè£½å®šä½å­” (å››å€‹è§’è½)
            // ç›´å¾‘ = æŠ˜æ–·é‚Šå¯¬åº¦ / 2ï¼Œæœ€å¤§ç›´å¾‘ 4mm
            // å¦‚æœåªæœ‰ã€Œä¸Šä¸‹ã€æˆ–ã€Œå·¦å³ã€æŠ˜æ–·é‚Šï¼Œå®šä½å­”è·é›¢æ¿é‚Š 5mm
            if (breakPos !== 'none' && breakWidth > 0) {
                ctx.fillStyle = '#ff00ff';
                const holeDiameter = Math.min(breakWidth / 2, 4);
                const holeRadius = (holeDiameter / 2) * scale;
                const edgeOffset5mm = 5 * scale;  // 5mm è·é›¢æ¿é‚Š

                // è¨ˆç®—è§’è½ä½ç½®
                let cornerOffsetX, cornerOffsetY;
                if (breakPos === 'all') {
                    // å››å‘¨æŠ˜æ–·é‚Šï¼šå®šä½å­”åœ¨æŠ˜æ–·é‚Šä¸­å¿ƒ
                    cornerOffsetX = breakScaleW / 2;
                    cornerOffsetY = breakScaleH / 2;
                } else if (breakPos === 'lr') {
                    // åªæœ‰å·¦å³æŠ˜æ–·é‚Šï¼šXåœ¨æŠ˜æ–·é‚Šä¸­å¿ƒï¼ŒYè·æ¿é‚Š5mm
                    cornerOffsetX = breakScaleW / 2;
                    cornerOffsetY = edgeOffset5mm;
                } else if (breakPos === 'tb') {
                    // åªæœ‰ä¸Šä¸‹æŠ˜æ–·é‚Šï¼šYåœ¨æŠ˜æ–·é‚Šä¸­å¿ƒï¼ŒXè·æ¿é‚Š5mm
                    cornerOffsetX = edgeOffset5mm;
                    cornerOffsetY = breakScaleH / 2;
                }

                const holes = [
                    [offsetX + cornerOffsetX, offsetY + cornerOffsetY],  // å·¦ä¸Š
                    [offsetX + drawW - cornerOffsetX, offsetY + cornerOffsetY],  // å³ä¸Š
                    [offsetX + cornerOffsetX, offsetY + drawH - cornerOffsetY],  // å·¦ä¸‹
                    [offsetX + drawW - cornerOffsetX, offsetY + drawH - cornerOffsetY]  // å³ä¸‹
                ];

                // ç¹ªè£½å®šä½å­”
                holes.forEach(([cx, cy]) => {
                    ctx.beginPath();
                    ctx.arc(cx, cy, holeRadius, 0, Math.PI * 2);
                    ctx.fill();
                });

                // ç¹ªè£½å…‰å­¸é» (ç›´å¾‘ 1.05mmï¼Œè·é›¢å®šä½å­”ï¼Œå¾€é¢æ¿ä¸­å¿ƒæ–¹å‘)
                ctx.fillStyle = '#00ff00';  // ç¶ è‰²å…‰å­¸é»
                const fiducialRadius = (1.05 / 2) * scale;
                const fiducialOffset = 10 * scale;  // 10mm

                // å››å€‹è§’è½çš„å…‰å­¸é»ï¼Œæ–¹å‘æ ¹æ“šæŠ˜æ–·é‚Šé¡å‹æ±ºå®š
                // é˜²å‘†ï¼šå·¦ä¸Šå…‰å­¸é»å…§ç¸® 15mmï¼Œå…¶ä»–ä¸‰é¡†å…§ç¸® 10mm
                const fiducialOffset15 = 15 * scale;  // 15mm (é˜²å‘†ç”¨)
                let fiducials;
                if (breakPos === 'lr') {
                    // å·¦å³æŠ˜æ–·é‚Šï¼šå…‰å­¸é»å¾€å‚ç›´æ–¹å‘ç§»å‹•
                    fiducials = [
                        [holes[0][0], holes[0][1] + fiducialOffset15],  // å·¦ä¸Š â†’ å¾€ä¸‹ 15mm (é˜²å‘†)
                        [holes[1][0], holes[1][1] + fiducialOffset],   // å³ä¸Š â†’ å¾€ä¸‹ 10mm
                        [holes[2][0], holes[2][1] - fiducialOffset],   // å·¦ä¸‹ â†’ å¾€ä¸Š 5mm
                        [holes[3][0], holes[3][1] - fiducialOffset]    // å³ä¸‹ â†’ å¾€ä¸Š 5mm
                    ];
                } else if (breakPos === 'tb') {
                    // ä¸Šä¸‹æŠ˜æ–·é‚Šï¼šå…‰å­¸é»å¾€æ°´å¹³æ–¹å‘ç§»å‹•
                    fiducials = [
                        [holes[0][0] + fiducialOffset15, holes[0][1]],  // å·¦ä¸Š â†’ å¾€å³ 10mm (é˜²å‘†)
                        [holes[1][0] - fiducialOffset, holes[1][1]],   // å³ä¸Š â†’ å¾€å·¦ 5mm
                        [holes[2][0] + fiducialOffset, holes[2][1]],   // å·¦ä¸‹ â†’ å¾€å³ 5mm
                        [holes[3][0] - fiducialOffset, holes[3][1]]    // å³ä¸‹ â†’ å¾€å·¦ 5mm
                    ];
                } else {
                    // å››å‘¨æŠ˜æ–·é‚Šï¼šå…‰å­¸é»å¾€æ°´å¹³æ–¹å‘ç§»å‹• (é è¨­)
                    fiducials = [
                        [holes[0][0] + fiducialOffset15, holes[0][1]],  // å·¦ä¸Š â†’ å¾€å³ 10mm (é˜²å‘†)
                        [holes[1][0] - fiducialOffset, holes[1][1]],   // å³ä¸Š â†’ å¾€å·¦ 5mm
                        [holes[2][0] + fiducialOffset, holes[2][1]],   // å·¦ä¸‹ â†’ å¾€å³ 5mm
                        [holes[3][0] - fiducialOffset, holes[3][1]]    // å³ä¸‹ â†’ å¾€å·¦ 5mm
                    ];
                }

                fiducials.forEach(([fx, fy]) => {
                    ctx.beginPath();
                    ctx.arc(fx, fy, fiducialRadius, 0, Math.PI * 2);
                    ctx.fill();
                });
            }

            // ç¹ªè£½å°ºå¯¸æ¨™è¨»
            ctx.fillStyle = '#ffffff';
            ctx.font = '12px Arial';
            ctx.textAlign = 'center';

            // ç¸½å¯¬åº¦æ¨™è¨» (ä¸Šæ–¹)
            ctx.fillText(panelW.toFixed(1) + 'mm', offsetX + drawW / 2, offsetY - 10);

            // ç¸½é«˜åº¦æ¨™è¨» (å³å´)
            ctx.save();
            ctx.translate(offsetX + drawW + 25, offsetY + drawH / 2);
            ctx.rotate(Math.PI / 2);
            ctx.fillText(panelH.toFixed(1) + 'mm', 0, 0);
            ctx.restore();

            // å–®æ¿å°ºå¯¸æ¨™è¨» (ç¬¬ä¸€å€‹æ¿å­å…§éƒ¨)
            if (boardW > 40 && boardH > 25) {
                ctx.font = '10px Arial';
                ctx.fillText(singleX.toFixed(0) + 'Ã—' + singleY.toFixed(0), arrayStartX + boardW / 2, arrayStartY + boardH / 2 + 4);
            }
        }

        function trim(str) {
            return str.replace(/^\s+|\s+$/g, "");
        }

        function getValue(id) {
            var el = document.getElementById(id);
            if (!el) return "";

            if (el.tagName === 'SELECT' && el.value === 'custom') {
                var customInput = document.getElementById(id + '_custom');
                if (customInput) {
                    var val = trim(customInput.value);
                    return val || "";
                }
            } else if (id === 'specialAmount') {
                var rawVal = trim(el.value || "");
                return rawVal.replace(/,/g, "") || "";
            }

            var v = trim(el.value);
            return v || "";
        }

        function generateText() {
            var partNo = getValue("partNo");
            var material = getValue("material");
            var layers = getValue("layers");
            var thickness = getValue("thickness");
            var innerCu = getValue("innerCu");
            var outerCu = getValue("outerCu");
            var solderMask = getValue("solderMask");
            var legendColor = getValue("legendColor");
            var finish = getValue("finish");
            var goldFinger = getValue("goldFinger");
            var testMethod = getValue("testMethod");
            var qty = getValue("qty");
            var specialAmount = getValue("specialAmount");

            // [ä¿®æ­£] æ”¹ç‚ºè®€å–å¤šé¸æŒ‰éˆ•çš„ç‹€æ…‹ (æ”¯æ´ç„¡é™æ•¸é‡)
            var specials = [];
            var selectedBtns = document.querySelectorAll('#special-multi-container .option-btn.selected');
            if (selectedBtns.length > 0) {
                selectedBtns.forEach(btn => specials.push(btn.dataset.value));
            } else {
                // Fallback (for safety, though UI should be primary)
                // å¦‚æœ UI æ²’é¸ï¼Œæª¢æŸ¥ hidden (ä¾‹å¦‚å‰›è¼‰å…¥é‚„æ²’ render? ä¸å¤ªå¯èƒ½)
                // æˆ–æª¢æŸ¥èˆŠ selects
                var specialsIds = ["special1", "special2", "special3"];
                for (var i = 0; i < specialsIds.length; i++) {
                    var v = getValue(specialsIds[i]);
                    if (v && v !== "-" && v !== "è«‹é¸æ“‡") specials.push(v);
                }
                // Remove duplicates if fallback mixed with UI (shouldn't happen)
                specials = [...new Set(specials)];
            }

            var remarksEl = document.querySelector('.remarks-input');
            var remark = remarksEl ? trim(remarksEl.value) : "";

            var lines = [
                "æ–™è™Ÿï¼š" + (partNo || "-"),
                "æ¿æï¼š" + (material || "-"),
                "å±¤åˆ¥ï¼š" + (layers || "-"),
                "æˆå“æ¿åšï¼š" + (thickness || "-")
            ];

            if (layers !== "å–®é¢æ¿" && layers !== "é›™é¢æ¿" && layers !== "" && layers !== "-") {
                lines.push("å…§å±¤éŠ…åšï¼š" + (innerCu || "-"));
            }

            lines.push(
                "å¤–å±¤éŠ…åšï¼š" + (outerCu || "-"),
                "é˜²ç„Šé¡è‰²ï¼š" + (solderMask || "-"),
                "æ–‡å­—é¡è‰²ï¼š" + (legendColor || "-"),
                "è¡¨é¢è™•ç†ï¼š" + (finish || "-")
            );

            if (goldFinger && goldFinger !== "-" && goldFinger !== "è«‹é¸æ“‡") {
                lines.push("é‡‘(éŒ«)æ‰‹æŒ‡ï¼š" + goldFinger);
            }

            if (testMethod && testMethod !== "-" && testMethod !== "è«‹é¸æ“‡") {
                lines.push("é›»æ€§æ¸¬è©¦ï¼š" + testMethod);
            }

            lines.push("æ•¸é‡(å‡ºè²¨ç‰‡)ï¼š" + (qty || "-"));

            if (remark) {
                lines.push("è¨‚å–®å‚™è¨»ï¼š" + remark);
            }

            if (specials.length > 0) {
                var uniqueSpecials = Array.from(new Set(specials));
                lines.push("ç‰¹æ®Šè£½ç¨‹ï¼š" + uniqueSpecials.join("ã€"));
            }

            if (specialAmount) {
                lines.push("è¨‚å–®é‡‘é¡ï¼š" + Number(specialAmount).toLocaleString("en-US") + "å…ƒ");
            }

            var dimLength = getValue("dimLength");
            var dimWidth = getValue("dimWidth");
            var shippingMethod = getValue("shippingMethod");
            var engRemarks = [];

            // UL æ¨™è¨˜
            var ulOption = getValue("ulOption");
            if (ulOption && ulOption !== "-") {
                engRemarks.push("ULæ¨™è¨˜ï¼š" + ulOption);
            }

            // é€±æœŸæ¨™è¨˜
            var dateCodeOption = getValue("dateCodeOption");
            if (dateCodeOption && dateCodeOption !== "-") {
                engRemarks.push("é€±æœŸæ¨™è¨˜ï¼š" + dateCodeOption);
            }

            // ç§»é™¤å°ºå¯¸æ¬„ä½ï¼Œæ”¹ç”¨å–®ç‰‡å°ºå¯¸
            if (shippingMethod && shippingMethod !== "-" && shippingMethod !== "è«‹é¸æ“‡") {
                engRemarks.push("å‡ºè²¨æ–¹å¼ï¼š" + shippingMethod);

                if (shippingMethod === "é€£ç‰‡å‡ºè²¨") {
                    var panelizingMethod = getValue("panelizingMethod");
                    if (panelizingMethod && panelizingMethod !== "-" && panelizingMethod !== "è«‹é¸æ“‡") {
                        engRemarks.push("é€£ç‰‡æ–¹å¼ï¼š" + panelizingMethod);

                        // å¦‚æœæ˜¯å·¥ç¨‹ä»£é€£ç‰‡ï¼ŒåŠ å…¥é€£ç‰‡é…ç½®è©³æƒ…
                        if (panelizingMethod === "å·¥ç¨‹ä»£é€£ç‰‡" || panelizingMethod === "å·¥ç¨‹ä»£æ’ç‰ˆ") {
                            var singleX = getValue("panelSingleX");
                            var singleY = getValue("panelSingleY");
                            var layoutX = getValue("panelLayoutX") || "1";
                            var layoutY = getValue("panelLayoutY") || "1";
                            var spacingX = getValue("panelSpacingX") || "0";
                            var spacingY = getValue("panelSpacingY") || "0";
                            var breakPos = document.getElementById("panelBreakPos").value;
                            var breakWidth = getValue("panelBreakWidth") || "0";
                            var resultSize = document.getElementById("panelResultSize").textContent;

                            var breakPosText = { "none": "ç„¡", "lr": "å·¦å³", "tb": "ä¸Šä¸‹", "all": "å››å‘¨" }[breakPos] || "å››å‘¨";

                            if (singleX && singleY) {
                                engRemarks.push("å–®ç‰‡å°ºå¯¸ï¼š" + singleX + " Ã— " + singleY + " mm");
                                engRemarks.push("æ’ç‰ˆæ–¹å¼ï¼š" + layoutX + " Ã— " + layoutY);
                                engRemarks.push("é–“è·ï¼šX=" + spacingX + " / Y=" + spacingY + " mm");
                                engRemarks.push("æŠ˜æ–·é‚Šï¼š" + breakPosText + " " + breakWidth + " mm");
                                engRemarks.push("æ’ç‰ˆå¾Œå°ºå¯¸ï¼š" + resultSize);
                            }
                        }
                    }
                }
            }

            // å·¥ç¨‹å‚™è¨»
            var engRemarkInput = document.getElementById("engRemarkInput");
            var engRemark = engRemarkInput ? engRemarkInput.value.trim() : "";
            if (engRemark) {
                engRemarks.push("å·¥ç¨‹å‚™è¨»ï¼š" + engRemark);
            }

            if (engRemarks.length > 0) {
                lines.push("", "ã€å·¥ç¨‹è£½ä½œèªªæ˜ã€‘");
                lines = lines.concat(engRemarks);
            }

            var resultText = lines.join("\n");
            document.getElementById("output-text").value = resultText;
            var now = new Date();
            var timeStr = now.getFullYear() + "/" +
                (now.getMonth() + 1).toString().padStart(2, '0') + "/" +
                now.getDate().toString().padStart(2, '0') + " " +
                now.getHours().toString().padStart(2, '0') + ":" +
                now.getMinutes().toString().padStart(2, '0');

            msg = timeStr + "\n" + msg;

            if (remark) {
                msg += "\n\nè¨‚å–®å‚™è¨»ï¼š" + remark;
            }

            document.getElementById("output-text").value = msg;
        }

        async function copyText(skipSave = false) {
            var output = document.getElementById("output-text");

            if (!output.value) {
                generateText();
                if (!output.value) {
                    window.showToast("è«‹å…ˆå®Œæˆè¦æ ¼è¼¸å…¥ï¼", "error");
                    return;
                }
            }

            // [ä¿®æ”¹] åªæœ‰ç•¶æ–™è™Ÿå­˜åœ¨æ™‚æ‰å„²å­˜ (çœç•¥å®¢æˆ¶æª¢æŸ¥)
            if (!skipSave && getValue("partNo")) {
                if (typeof saveCurrentReportToHistory === 'function') saveCurrentReportToHistory();
            }

            output.select();
            output.setSelectionRange(0, 99999);

            try {
                if (navigator.clipboard && navigator.clipboard.writeText) {
                    navigator.clipboard.writeText(output.value).then(() => {
                        window.showToast("æ–‡å­—è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
                    }).catch(err => {
                        fallbackCopy();
                    });
                } else {
                    fallbackCopy();
                }
            } catch (err) {
                fallbackCopy();
            }
        }

        function fallbackCopy() {
            try {
                document.execCommand("copy");
                window.showToast("æ–‡å­—è¨Šæ¯å·²è¤‡è£½åˆ°å‰ªè²¼ç°¿ï¼");
            } catch (err) {
                window.showToast("è¤‡è£½å¤±æ•—ï¼Œè«‹æ‰‹å‹•è¤‡è£½", "error");
            }
        }
    </script>

</body>

</html>