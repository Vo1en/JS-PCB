<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>é§¿é‘« å‡ºè²¨æª¢é©—å ±å‘Š</title>
    <link rel="stylesheet" href="navbar.css">
    <link rel="stylesheet" href="report.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <style>
        /* æ–°å¢æŒ‰éˆ•çš„æ¨£å¼ */
        .btn-add-row {
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            color: #333;
            padding: 2px 10px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 10px;
        }

        .btn-add-row:hover {
            background-color: #e0e0e0;
            border-color: #999;
        }

        /* åˆªé™¤æŒ‰éˆ•çš„æ¨£å¼ */
        .btn-del-row {
            background-color: #ffebee;
            border: 1px solid #ffcdd2;
            color: #c62828;
            padding: 2px 10px;
            font-size: 13px;
            border-radius: 4px;
            cursor: pointer;
            transition: all 0.2s;
            margin-left: 5px;
        }

        .btn-del-row:hover {
            background-color: #ffcdd2;
            border-color: #e57373;
        }

        @media print {

            /* åˆ—å°æ™‚éš±è—æ“ä½œæŒ‰éˆ• */
            .btn-add-row,
            .btn-del-row {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div id="navbar-container"></div>
    <div class="page-container">

        <div class="action-buttons">
            <button class="btn-print" onclick="handlePrintProcess(checkInspectionCompletion)">
                <svg class="icon-printer" viewBox="0 0 24 24">
                    <path
                        d="M19 8H5c-1.66 0-3 1.34-3 3v6h4v4h12v-4h4v-6c0-1.66-1.34-3-3-3zm-3 11H8v-5h8v5zm3-7c-.55 0-1-.45-1-1s.45-1 1-1 1 .45 1 1-.45 1-1 1zm-1-9H6v4h12V3z" />
                </svg>
                åˆ—å°
            </button>
            <button class="btn-pdf" onclick="handlePDFProcess(checkInspectionCompletion)">
                <svg class="icon-printer" viewBox="0 0 24 24" fill="currentColor">
                    <path
                        d="M20 2H8c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h12c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2zm-8.5 7.5c0 .83-.67 1.5-1.5 1.5H9v2H7.5V7H10c.83 0 1.5.67 1.5 1.5v1zm5 2c0 .83-.67 1.5-1.5 1.5h-2.5V7H15c.83 0 1.5.67 1.5 1.5v3zm4-3H19v1h1.5V11H19v2h-1.5V7h3v1.5zM9 9.5h1v-1H9v1zM4 6H2v14c0 1.1.9 2 2 2h14v-2H4V6zm10 5.5h1v-3h-1v3z" />
                </svg>
                ç”Ÿæˆ PDF
            </button>
        </div>

        <div class="a4-paper">
            <div id="unified-header-container" data-title="å‡ºè²¨æª¢é©—å ±å‘Š"></div>
            <h3 class="section-title">PCB è¦æ ¼</h3>
            <section class="info-grid grid-pcb" id="pcb-spec-section">
                <div class="info-item span-standard"><span class="label">æ¿æ</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="material-input-group" data-print-target="print-material"
                            onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="FR-4">FR-4</option>
                            <option value="FR-1">FR-1</option>
                            <option value="é‹åŸºæ¿">é‹åŸºæ¿</option>
                            <option value="éŠ…åŸºæ¿">éŠ…åŸºæ¿</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="material-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥æ¿æ" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>
                <div class="info-item span-standard"><span class="label">å±¤åˆ¥</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="layer-input-group" data-print-target="print-layer"
                            onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="å–®é¢æ¿">å–®é¢æ¿</option>
                            <option value="é›™é¢æ¿">é›™é¢æ¿</option>
                            <option value="å››å±¤æ¿">å››å±¤æ¿</option>
                            <option value="å…­å±¤æ¿">å…­å±¤æ¿</option>
                            <option value="å…«å±¤æ¿">å…«å±¤æ¿</option>
                            <option value="åå±¤æ¿">åå±¤æ¿</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="layer-input-group" style="display: none;"><input
                                type="text" class="input-line" placeholder="è¼¸å…¥å±¤åˆ¥" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>
                <div class="info-item span-standard"><span class="label">æ¿åš</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="thickness-input-group" data-print-target="print-thickness"
                            onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="0.4 mm">0.4 mm</option>
                            <option value="0.6 mm">0.6 mm</option>
                            <option value="0.8 mm">0.8 mm</option>
                            <option value="1.0 mm">1.0 mm</option>
                            <option value="1.2 mm">1.2 mm</option>
                            <option value="1.6 mm">1.6 mm</option>
                            <option value="2.0 mm">2.0 mm</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="thickness-input-group" style="display: none;">
                            <input type="text" class="input-line" placeholder="è¼¸å…¥æ¿åš" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>
                <div class="info-item span-standard"><span class="label">éŠ…åš</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="copper-input-group" data-print-target="print-copper"
                            onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="1 oz">1 oz</option>
                            <option value="2 oz">2 oz</option>
                            <option value="3 oz">3 oz</option>
                            <option value="4 oz">4 oz</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="copper-input-group" style="display: none;"><input
                                type="text" class="input-line" placeholder="è¼¸å…¥éŠ…åš" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>
                <div class="info-item span-standard"><span class="label">é˜²ç„Š</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="mask-input-group" data-print-target="print-mask" onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="ç¶ è‰²">ğŸŸ¢ ç¶ è‰²</option>
                            <option value="ç™½è‰²">âšª ç™½è‰²</option>
                            <option value="ç´…è‰²">ğŸ”´ ç´…è‰²</option>
                            <option value="é»‘è‰²">âš« é»‘è‰²</option>
                            <option value="è—è‰²">ğŸ”µ è—è‰²</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="mask-input-group" style="display: none;"><input
                                type="text" class="input-line" placeholder="è¼¸å…¥é¡è‰²" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>
                <div class="info-item span-standard"><span class="label">æ–‡å­—</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="legend-input-group" data-print-target="print-legend"
                            onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="ç™½è‰²">âšª ç™½è‰²</option>
                            <option value="é»‘è‰²">âš« é»‘è‰²</option>
                            <option value="ç„¡æ–‡å­—">ç„¡æ–‡å­—</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="legend-input-group" style="display: none;"><input
                                type="text" class="input-line" placeholder="è¼¸å…¥é¡è‰²" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>
                <div class="info-item span-standard"><span class="label">ç„Šç›¤</span>
                    <div class="input-group wrapper-toggle"><select class="unit-select toggle-select"
                            data-target="surface-input-group" data-print-target="print-surface"
                            onchange="checkCompletion()">
                            <option value="" disabled selected hidden>è«‹é¸æ“‡</option>
                            <option value="æœ‰é‰›å™´éŒ«">æœ‰é‰›å™´éŒ«</option>
                            <option value="ç„¡é‰›å™´éŒ«">ç„¡é‰›å™´éŒ«</option>
                            <option value="åŒ–é‡‘ 1u">åŒ–é‡‘ 1u"</option>
                            <option value="åŒ–é‡‘ 2u">åŒ–é‡‘ 2u"</option>
                            <option value="åŒ–é‡‘ 3u">åŒ–é‡‘ 3u"</option>
                            <option value="ç¡¬é‡‘ 3u">ç¡¬é‡‘ 3u"</option>
                            <option value="ç¡¬é‡‘ 5u">ç¡¬é‡‘ 5u"</option>
                            <option value="OSP">OSP</option>
                            <option value="è£¸éŠ…">è£¸éŠ…</option>
                            <option value="å…¶ä»–">å…¶ä»– (è¼¸å…¥)</option>
                        </select>
                        <div class="input-group toggle-input-box" id="surface-input-group" style="display: none;"><input
                                type="text" class="input-line" placeholder="è¼¸å…¥è™•ç†" oninput="checkCompletion()"><span
                                class="reset-btn" title="åˆ‡å›é¸å–®">Ã—</span></div>
                    </div>
                </div>

                <div class="info-item desktop-spacer"></div>

                <div class="info-item span-half">
                    <span class="label">å°ºå¯¸</span>
                    <div class="input-group" style="gap: 5px;">
                        <input type="text" id="dim-length-input" class="input-line split-input" placeholder="é•·"
                            oninput="updateSpecs(); checkCompletion(); syncDimensions();">
                        <span>x</span>
                        <input type="text" id="dim-width-input" class="input-line split-input" placeholder="å¯¬"
                            oninput="updateSpecs(); checkCompletion(); syncDimensions();">
                        <span class="unit-display-text"
                            style="font-size: 12px; color: #666; white-space: nowrap;">mm</span>
                    </div>
                </div>

                <div class="info-item span-half">
                    <span class="label">æ’ç‰ˆ</span>
                    <div class="input-group" style="gap: 5px;">
                        <input type="text" id="pnl-x" class="input-line split-input" placeholder="X"
                            oninput="checkCompletion(); syncArray();">
                        <span>x</span>
                        <input type="text" id="pnl-y" class="input-line split-input" placeholder="Y"
                            oninput="checkCompletion(); syncArray();">
                        <span class="unit-display-text"
                            style="flex-shrink: 0; width: 65px; font-size: 12px; font-weight: 600; text-align: center;">PCS
                            / PNL</span>
                    </div>
                </div>
            </section>

            <table class="print-only-table" id="print-pcb-specs">
                <tr>
                    <th>æ¿ã€€ã€€æ</th>
                    <td id="print-material"></td>
                    <th>å±¤ã€€ã€€åˆ¥</th>
                    <td id="print-layer"></td>
                    <th>æ¿ã€€ã€€åš</th>
                    <td id="print-thickness"></td>
                </tr>
                <tr>
                    <th>éŠ…ã€€ã€€åš</th>
                    <td id="print-copper"></td>
                    <th>é˜²ã€€ã€€ç„Š</th>
                    <td id="print-mask"></td>
                    <th>æ–‡ã€€ã€€å­—</th>
                    <td id="print-legend"></td>
                </tr>
                <tr>
                    <th>ç„Šã€€ã€€ç›¤</th>
                    <td id="print-surface"></td>
                    <th>å‡ºè²¨å°ºå¯¸</th>
                    <td id="print-dim"></td>
                    <th>æ’ç‰ˆè¦æ ¼</th>
                    <td id="print-array"></td>
                </tr>
            </table>

            <div class="section-header-wrapper">
                <div style="display:flex; align-items:center;">
                    <h3 class="section-title">æª¢é©—æ•¸æ“š</h3>
                    <button type="button" class="btn-add-row" onclick="addHoleRow()" data-html2canvas-ignore="true">+
                        æ–°å¢å­”å¾‘</button>
                    <button type="button" class="btn-del-row" onclick="deleteLastHoleRow()"
                        data-html2canvas-ignore="true">- åˆªé™¤å­”å¾‘</button>
                </div>
                <span class="standard-badge">æŠ½æ¨£æ¨™æº–: MIL-STD-105D</span>
            </div>

            <div class="table-wrapper">
                <table class="inspection-table" id="inspection-data-table">
                    <thead>
                        <tr>
                            <th style="min-width: 80px;">é …ç›®</th>
                            <th style="min-width: 100px;">è¦æ ¼ (mm)</th>
                            <th>æ¨£æœ¬ A</th>
                            <th>æ¨£æœ¬ B</th>
                            <th>æ¨£æœ¬ C</th>
                            <th>æ¨£æœ¬ D</th>
                            <th>æ¨£æœ¬ E</th>
                            <th style="min-width: 60px;">åˆ¤å®š</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr data-item="length">
                            <td>é•·åº¦</td>
                            <td><span contenteditable="true" class="editable-cell" id="spec-length-nominal"
                                    inputmode="decimal" oninput="populateAllInspectionData()"></span> <span
                                    class="tolerance-display"> Â± <span class="spec-tolerance"
                                        data-tolerance="0.2">0.2</span></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                        <tr data-item="width">
                            <td>å¯¬åº¦</td>
                            <td><span contenteditable="true" class="editable-cell" id="spec-width-nominal"
                                    inputmode="decimal" oninput="populateAllInspectionData()"></span> <span
                                    class="tolerance-display"> Â± <span class="spec-tolerance"
                                        data-tolerance="0.2">0.2</span></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                        <tr id="row-hole-1">
                            <td>å­”å¾‘ A</td>
                            <td><span contenteditable="true" class="editable-cell placeholder-text"
                                    id="spec-hole1-nominal" inputmode="decimal"
                                    oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â±
                                    <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                        <tr id="row-hole-2">
                            <td>å­”å¾‘ B</td>
                            <td><span contenteditable="true" class="editable-cell placeholder-text"
                                    id="spec-hole2-nominal" inputmode="decimal"
                                    oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â±
                                    <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                        <tr id="row-hole-3">
                            <td>å­”å¾‘ C</td>
                            <td><span contenteditable="true" class="editable-cell placeholder-text"
                                    id="spec-hole3-nominal" inputmode="decimal"
                                    oninput="populateAllInspectionData()"></span> <span class="tolerance-display"> Â±
                                    <span class="spec-tolerance" data-tolerance="0.05">0.05</span></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td><span class="editable-cell data-field" contenteditable="true" inputmode="decimal"
                                    oninput="checkJudgement(this)"></span></td>
                            <td class="judgment-field" style="font-weight:bold;"></td>
                        </tr>
                    </tbody>
                </table>
            </div>

            <div class="final-decision-box"><span class="decision-label">åˆ¤å®šçµæœ:</span>
                <div id="final-decision-badge" class="result-badge status-pending">ç­‰å¾…æ•¸æ“š...</div>
            </div>
            <div id="unified-remarks-container"></div>

            <div class="signature-section">
                <div class="sign-box">
                    <div class="sign-title">æª¢é©—äººå“¡</div>
                    <div class="sign-stamp-area">
                        <img src="pic/reviewer.png" alt="Reviewer" class="stamp-img"
                            onerror="this.style.display='none'">
                    </div>
                </div>
                <div class="sign-box">
                    <div class="sign-title">æ ¸å‡†äººå“¡</div>
                    <div class="sign-stamp-area">
                        <img src="pic/approver.png" alt="Approver" class="stamp-img"
                            onerror="this.style.display='none'">
                    </div>
                </div>
            </div>

        </div>
    </div>

    <script src="navbar.js"></script>
    <script src="template.js"></script>
    <script src="js/protection.js"></script>

    <script>
        let hasUserInteracted = false;

        // ã€æ–°å¢ã€‘å…¨åŸŸè®Šæ•¸ï¼šç”¨ä¾†å„²å­˜å­”å¾‘è¡Œçš„æ¨¡æ¿ï¼Œé¿å…åˆªå…‰å¾Œç„¡æ³•æ–°å¢
        let holeRowTemplate = null;

        // æ–°å¢å­”å¾‘åˆ—çš„åŠŸèƒ½ (ä¿®æ”¹ç‰ˆï¼šä½¿ç”¨å‚™ä»½æ¨¡æ¿)
        function addHoleRow() {
            const tbody = document.querySelector('#inspection-data-table tbody');
            const holeRows = tbody.querySelectorAll('tr[id^="row-hole-"]');
            const count = holeRows.length;
            const newIndex = count + 1;

            // è¨ˆç®—æ–°å­—æ¯ï¼šå¦‚æœåˆªå…‰äº† (count=0)ï¼Œé‚£å°±æ˜¯ 65+0='A'
            const nextChar = String.fromCharCode(65 + count);

            // ã€ä¿®æ”¹ã€‘å¾å…¨åŸŸè®Šæ•¸è¤‡è£½æ¨¡æ¿ï¼Œè€Œä¸æ˜¯å¾ DOM æŠ“å– (å› ç‚ºå¯èƒ½å·²ç¶“è¢«åˆªå…‰äº†)
            if (!holeRowTemplate) return; // å®‰å…¨æª¢æŸ¥
            const newRow = holeRowTemplate.cloneNode(true);

            // æ›´æ–° ID
            newRow.id = `row-hole-${newIndex}`;

            // æ›´æ–°æ¨™ç±¤ (ç¬¬ä¸€æ ¼)
            newRow.cells[0].textContent = `å­”å¾‘ ${nextChar}`;

            // æ›´æ–°è¦æ ¼è¼¸å…¥æ ¼ ID ä¸¦æ¸…ç©º
            const specCell = newRow.cells[1].querySelector('.editable-cell');
            specCell.id = `spec-hole${newIndex}-nominal`;
            specCell.textContent = '';

            // æ¸…ç©ºæ•¸æ“šæ ¼
            const dataCells = newRow.querySelectorAll('.data-field');
            dataCells.forEach(cell => {
                cell.textContent = '';
                cell.removeAttribute('id');
            });

            // æ¸…ç©ºåˆ¤å®šæ ¼
            const judgeCell = newRow.querySelector('.judgment-field');
            judgeCell.textContent = '';
            judgeCell.style.color = '';

            // ç§»é™¤éš±è—æ¨£å¼
            newRow.classList.remove('print-hidden-row');

            // æ’å…¥è¡¨æ ¼
            tbody.appendChild(newRow);

            // ç‚ºæ–°è¡Œç¶å®šäº‹ä»¶
            bindEventsToRow(newRow);

            // é‡æ–°æª¢æŸ¥
            checkCompletion();
        }

        // åˆªé™¤æœ€å¾Œä¸€åˆ—å­”å¾‘çš„åŠŸèƒ½ (ä¿®æ”¹ç‰ˆï¼šå…è¨±åˆªé™¤å…¨éƒ¨)
        function deleteLastHoleRow() {
            const tbody = document.querySelector('#inspection-data-table tbody');
            const holeRows = tbody.querySelectorAll('tr[id^="row-hole-"]');

            // ã€ä¿®æ”¹ã€‘é‚è¼¯æ”¹ç‚ºï¼šåªè¦æœ‰åˆ—å°±å¯ä»¥åˆªé™¤ (åŒ…å«å­”å¾‘ A)
            if (holeRows.length > 0) {
                // å–å¾—æœ€å¾Œä¸€åˆ—ä¸¦ç§»é™¤
                const lastRow = holeRows[holeRows.length - 1];
                lastRow.remove();

                // ç§»é™¤å¾Œé‡æ–°æª¢æŸ¥é é¢ç‹€æ…‹
                checkCompletion();
            } else {
                // å·²ç¶“åˆªå…‰äº†ï¼Œç„¡éœ€å‹•ä½œ
                // alert("å·²ç„¡å­”å¾‘å¯åˆªé™¤"); 
            }
        }

        // é é¢å°ˆå±¬ï¼šæª¢æŸ¥ PCB è¦æ ¼èˆ‡æª¢é©—æ•¸æ“šæ˜¯å¦å¡«å¯«å®Œæˆ
        function checkInspectionCompletion() {
            let isComplete = true;

            // æª¢æŸ¥ PCB è¦æ ¼å€å¡Š
            const pcbSection = document.getElementById('pcb-spec-section');
            if (pcbSection) {
                const selects = pcbSection.querySelectorAll('.toggle-select');
                selects.forEach(sel => {
                    const wrapper = sel.closest('.wrapper-toggle');
                    const inputGroup = wrapper ? wrapper.querySelector('.toggle-input-box') : null;
                    const input = inputGroup ? inputGroup.querySelector('input') : null;

                    if (inputGroup && inputGroup.style.display !== 'none') {
                        if (input && input.value.trim() === '') {
                            input.classList.add('input-error');
                            isComplete = false;
                        } else if (input) {
                            input.classList.remove('input-error');
                            syncPcbSpecToPrint(sel, input.value);
                        }
                    } else {
                        if (sel.value === '' || sel.value === 'è«‹é¸æ“‡') {
                            sel.classList.add('input-error');
                            isComplete = false;
                        } else {
                            sel.classList.remove('input-error');
                            syncPcbSpecToPrint(sel, sel.value);
                        }
                    }
                });

                const numericInputs = pcbSection.querySelectorAll('#dim-length-input, #dim-width-input, #pnl-x, #pnl-y');
                numericInputs.forEach(inp => {
                    if (inp.value.trim() === '') {
                        inp.classList.add('input-error');
                        isComplete = false;
                    } else {
                        inp.classList.remove('input-error');
                    }
                });

                syncDimensions();
                syncArray();
            }

            // [æ³¨æ„] å³ä½¿åˆªé™¤äº†æ‰€æœ‰å­”å¾‘è¡Œï¼Œåªè¦å¿…å¡«æ¬„ä½å®Œæˆï¼Œä»è¦–ç‚ºå®Œæˆ
            // å¦‚æœ spec-hole1-nominal ä¸å­˜åœ¨ (å› ç‚ºè¢«åˆªé™¤äº†)ï¼Œç¨‹å¼ä¹Ÿä¸æœƒå ±éŒ¯
            const nominalSpecA = document.getElementById('spec-hole1-nominal');
            if (nominalSpecA) {
                nominalSpecA.classList.remove('input-error');
            }

            // éš±è—æœªä½¿ç”¨çš„å­”å¾‘è¡Œ (åˆ—å°æº–å‚™)
            prepareRowsForPrint();

            return isComplete;
        }

        function syncPcbSpecToPrint(selectEl, value) {
            const printTargetId = selectEl.getAttribute('data-print-target');
            const target = document.getElementById(printTargetId);
            if (target) {
                const cleanValue = value.replace(/ğŸŸ¢|âšª|ğŸ”´|âš«|ğŸ”µ/g, '').trim();
                target.textContent = cleanValue;
            }
        }

        function syncDimensions() {
            const len = document.getElementById('dim-length-input')?.value || '';
            const wid = document.getElementById('dim-width-input')?.value || '';
            const dimTarget = document.getElementById('print-dim');
            if (dimTarget) dimTarget.textContent = (len && wid) ? `${len} x ${wid} mm` : '';
        }

        function syncArray() {
            const px = document.getElementById('pnl-x')?.value || '';
            const py = document.getElementById('pnl-y')?.value || '';
            const arrTarget = document.getElementById('print-array');
            if (arrTarget) arrTarget.textContent = (px && py) ? `${px} x ${py} PCS/PNL` : '';
        }

        function initToggleLogic() {
            document.querySelectorAll('.toggle-select').forEach(select => {
                select.addEventListener('change', function () {
                    const targetId = this.getAttribute('data-target');
                    const targetBox = document.getElementById(targetId);
                    if (this.value === 'å…¶ä»–' && targetBox) { this.style.display = 'none'; targetBox.style.display = 'flex'; targetBox.querySelector('input')?.focus(); }
                    hasUserInteracted = true; checkCompletion();
                });
            });
            document.querySelectorAll('.reset-btn').forEach(btn => {
                btn.addEventListener('click', function () {
                    const inputBox = this.closest('.toggle-input-box');
                    const wrapper = this.closest('.wrapper-toggle');
                    const select = wrapper.querySelector('select');
                    if (inputBox && select) { inputBox.querySelector('input').value = ''; inputBox.style.display = 'none'; select.style.display = 'block'; select.value = ""; }
                    hasUserInteracted = true; checkCompletion();
                });
            });

            document.querySelectorAll('.toggle-select').forEach(select => { syncPcbSpecToPrint(select, select.value); });
        }

        function prepareRowsForPrint() {
            // [ä¿®æ”¹] å‹•æ…‹é¸å–æ‰€æœ‰å­”å¾‘è¡Œ
            const holeRows = document.querySelectorAll('tr[id^="row-hole-"]');
            holeRows.forEach(row => {
                const nominalSpec = row.querySelector('.editable-cell:not(.data-field)');
                let isSpecEmpty = nominalSpec?.textContent.trim() === '';
                if (nominalSpec && !isSpecEmpty) {
                    let content = nominalSpec.textContent.replace(/[^0-9.]/g, '').trim();
                    if (content === '' || parseFloat(content) === 0) isSpecEmpty = true;
                }
                if (isSpecEmpty) row.classList.add('print-hidden-row'); else row.classList.remove('print-hidden-row');
            });
        }

        function updateSpecs() {
            const lengthInput = document.getElementById('dim-length-input');
            const widthInput = document.getElementById('dim-width-input');
            const lengthNominal = document.getElementById('spec-length-nominal');
            const widthNominal = document.getElementById('spec-width-nominal');

            const fmt = (v) => {
                if (!v) return '';
                const n = parseFloat(v);
                return isNaN(n) ? v : n.toFixed(2);
            };

            if (lengthInput && lengthNominal) lengthNominal.textContent = fmt(lengthInput.value);
            if (widthInput && widthNominal) widthNominal.textContent = fmt(widthInput.value);

            populateAllInspectionData();
        }

        function parseSpec(nominalId) {
            const nominalEl = document.getElementById(nominalId);
            if (!nominalEl) return null;
            const row = nominalEl.closest('tr');
            const toleranceEl = row.querySelector('.spec-tolerance');
            const nominal = parseFloat(nominalEl.textContent.trim());
            const tolerance = toleranceEl ? parseFloat(toleranceEl.getAttribute('data-tolerance')) : 0;
            if (isNaN(nominal)) return null;
            return { nominal, tolerance };
        }

        function generateRandomData(nominal, tolerance, rowIndex) {
            let val = nominal;
            // å°ºå¯¸ (0, 1) éš¨æ©Ÿ
            if (rowIndex === 0 || rowIndex === 1) {
                if (Math.random() < 0.90) { val = nominal + (Math.random() * tolerance * 0.5) - (tolerance * 0.25); } else { val = nominal + (Math.random() * 0.10) * (Math.random() < 0.5 ? 1 : -1); }
            } else {
                // å­”å¾‘
                val = nominal + (Math.random() * 0.04) + 0.01;
            }
            return (Math.round(val * 1000) / 1000).toFixed(2);
        }

        function populateRowData(rowElement) {
            const specCell = rowElement.querySelector('td:nth-child(2) .editable-cell');
            if (!specCell) return;
            const parsed = parseSpec(specCell.id);

            const judgementCell = rowElement.querySelector('.judgment-field');
            const dataCells = rowElement.querySelectorAll('.data-field');

            if (!parsed) {
                // è‹¥ç„¡è¦æ ¼å‰‡æ¸…ç©ºæ•¸æ“š
                dataCells.forEach(cell => cell.textContent = '');
                judgementCell.textContent = '';
                return;
            }

            // åˆ¤æ–·æ˜¯ç¬¬å¹¾è¡Œä¾†æ±ºå®šéš¨æ©Ÿé‚è¼¯ (é•·å¯¬æ˜¯å‰å…©è¡Œ)
            const isDimension = rowElement.getAttribute('data-item') === 'length' || rowElement.getAttribute('data-item') === 'width';
            const rowIndex = isDimension ? 0 : 2;

            dataCells.forEach(cell => {
                cell.textContent = generateRandomData(parsed.nominal, parsed.tolerance, rowIndex);
            });
            judgementCell.textContent = 'OK'; judgementCell.style.color = 'green';
        }

        function populateAllInspectionData() {
            // é•·å¯¬
            populateRowData(document.querySelector('tr[data-item="length"]'));
            populateRowData(document.querySelector('tr[data-item="width"]'));

            // [ä¿®æ”¹] å‹•æ…‹å¡«å¯«æ‰€æœ‰å­”å¾‘è¡Œ
            document.querySelectorAll('tr[id^="row-hole-"]').forEach(row => {
                populateRowData(row);
            });
            checkCompletion();
        }

        function checkJudgement(dataEl) {
            const row = dataEl.closest('tr');
            const judgementCell = row.querySelector('.judgment-field');
            const allEmpty = Array.from(row.querySelectorAll('.data-field')).every(el => el.textContent.trim() === '');
            if (allEmpty) { judgementCell.textContent = ''; } else { judgementCell.textContent = 'OK'; judgementCell.style.color = 'green'; }
            hasUserInteracted = true; checkCompletion();
        }

        function checkCompletion() {
            let isComplete = true;
            if (window.reportData.client.trim() === "" || window.reportData.partno.trim() === "") isComplete = false;

            const pcbSection = document.getElementById('pcb-spec-section');
            if (pcbSection) {
                pcbSection.querySelectorAll('.toggle-select').forEach(select => {
                    const isInputVisible = select.style.display === 'none';
                    if (!isInputVisible && (select.value === "" || select.value === "è«‹é¸æ“‡")) { isComplete = false; }
                });
                pcbSection.querySelectorAll('input[type="text"]').forEach(input => {
                    if (input.closest('.toggle-input-box') && input.closest('.toggle-input-box').style.display === 'flex' && input.value.trim() === "") {
                        isComplete = false;
                    } else if (!input.closest('.toggle-input-box') && input.value.trim() === "") {
                        isComplete = false;
                    }
                });
            }

            // æ›´æ–°åˆ¤å®š Badge
            const badgeEl = document.getElementById('final-decision-badge');
            if (isComplete) {
                badgeEl.textContent = "PASSED / åˆæ ¼";
                badgeEl.className = "result-badge status-pass";
            } else {
                badgeEl.textContent = "ç­‰å¾…æ•¸æ“š...";
                badgeEl.className = "result-badge status-pending";
            }
        }

        // æŠ½å–ç¶å®šäº‹ä»¶çš„é‚è¼¯ï¼Œä»¥ä¾¿å‹•æ…‹è¡Œä½¿ç”¨
        function bindEventsToRow(row) {
            // è¦æ ¼è¼¸å…¥è§¸ç™¼
            const specInput = row.querySelector('td:nth-child(2) .editable-cell');
            if (specInput) {
                specInput.addEventListener('input', populateAllInspectionData);
                // æ ¼å¼åŒ– logic
                specInput.addEventListener('blur', function () {
                    const val = parseFloat(this.innerText);
                    if (!isNaN(val)) {
                        this.innerText = val.toFixed(2);
                        populateAllInspectionData();
                    }
                });
                specInput.addEventListener('keydown', function (e) { if (e.key === 'Enter') { e.preventDefault(); this.blur(); } });
                specInput.addEventListener('paste', handlePaste);
            }

            // æ•¸æ“šè¼¸å…¥è§¸ç™¼
            const dataInputs = row.querySelectorAll('.data-field');
            dataInputs.forEach(cell => {
                cell.addEventListener('input', function (e) { checkJudgement(this); handleInputRestrict(e, this); });
                cell.addEventListener('keydown', handleKeyRestrict);
                cell.addEventListener('paste', handlePaste);
            });
        }

        // å…±ç”¨çš„è¼¸å…¥é™åˆ¶è™•ç†å™¨
        function handleInputRestrict(e, el) {
            if (e.isComposing) return;
            const text = el.innerText;
            const clean = text.replace(/[^0-9.]/g, '');
            if (text !== clean) {
                el.innerText = clean;
                try {
                    const range = document.createRange();
                    const sel = window.getSelection();
                    range.selectNodeContents(el);
                    range.collapse(false);
                    sel.removeAllRanges();
                    sel.addRange(range);
                } catch (e) { }
            }
            hasUserInteracted = true;
        }

        function handleKeyRestrict(e) {
            const allowedKeys = ["Backspace", "Delete", "Tab", "Escape", "Enter", "ArrowLeft", "ArrowRight", "ArrowUp", "ArrowDown", "Home", "End", "."];
            if (!isNaN(parseInt(e.key)) || allowedKeys.includes(e.key)) {
                if (e.key === '.' && this.innerText.includes('.')) e.preventDefault();
                return;
            }
            if (e.ctrlKey || e.metaKey) return;
            e.preventDefault();
        }

        function handlePaste(e) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand('insertText', false, text);
        }

        function initNumericInputLogic() {
            const numericInputs = document.querySelectorAll('#dim-length-input, #dim-width-input, #pnl-x, #pnl-y');
            numericInputs.forEach(input => { input.addEventListener('input', function () { this.value = this.value.replace(/[^0-9.]/g, ''); hasUserInteracted = true; }); });

            // åˆå§‹ç¶å®šç¾æœ‰è¡¨æ ¼
            document.querySelectorAll('#inspection-data-table tr').forEach(row => {
                if (row.querySelector('.editable-cell')) bindEventsToRow(row);
            });
        }

        document.addEventListener('DOMContentLoaded', () => {
            // ã€æ–°å¢ã€‘åœ¨åˆå§‹åŒ–æ™‚ï¼Œå‚™ä»½ç¬¬ä¸€è¡Œå­”å¾‘ä½œç‚ºæ¨¡æ¿
            const firstHoleRow = document.getElementById('row-hole-1');
            if (firstHoleRow) {
                holeRowTemplate = firstHoleRow.cloneNode(true);
            }

            initToggleLogic();
            initNumericInputLogic();

            const pcbInputs = document.querySelectorAll('#pcb-spec-section input, #pcb-spec-section select');
            pcbInputs.forEach(el => { el.addEventListener('input', checkCompletion); el.addEventListener('change', checkCompletion); });
            document.querySelectorAll('.reset-btn').forEach(btn => { btn.addEventListener('click', () => setTimeout(checkCompletion, 50)); });

            document.querySelectorAll('#inspection-data-table').forEach(table => { table.addEventListener('input', checkCompletion); });

            document.getElementById('dim-length-input')?.addEventListener('input', syncDimensions);
            document.getElementById('dim-width-input')?.addEventListener('input', syncDimensions);
            document.getElementById('pnl-x')?.addEventListener('input', syncArray);
            document.getElementById('pnl-y')?.addEventListener('input', syncArray);

            setTimeout(() => {
                const basicInfoGrid = document.querySelector('#unified-header-container .info-grid');
                if (basicInfoGrid) {
                    basicInfoGrid.addEventListener('input', checkCompletion);
                    basicInfoGrid.addEventListener('change', checkCompletion);
                }
                checkCompletion();
            }, 500);
        });
    </script>
</body>

</html>