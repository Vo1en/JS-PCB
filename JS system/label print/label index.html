<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é§¿é‘«å®¢æˆ¶æ¨™ç±¤ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* å®šç¾©å¥¢è¯é‡‘é…è‰² - äº®è‰²æ¨¡å¼ */
        :root {
            --gold-light: #fdf3e0;
            --gold-champagne: #f0e2c5;
            --gold-rich: #d4af37;
            --gold-dark: #8a6200;
            --bg-warm: #faf9f6;
            --text-dark: #1c1917;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-bg-hover: #fff;
            --modal-bg: linear-gradient(to bottom, #fffbf2, #fdf8ed);
            --overlay-bg: rgba(28, 25, 23, 0.5);
        }

        /* æš—è‰²æ¨¡å¼ */
        :root.dark {
            --gold-light: #2d2a20;
            --gold-champagne: #3d3825;
            --gold-rich: #d4af37;
            --gold-dark: #f1c40f;
            --bg-warm: #1a1918;
            --text-dark: #f5f5f4;
            --card-bg: rgba(45, 42, 35, 0.95);
            --card-bg-hover: #3d3825;
            --modal-bg: linear-gradient(to bottom, #2d2a20, #252320);
            --overlay-bg: rgba(0, 0, 0, 0.7);
        }

        body {
            background-color: var(--bg-warm);
            min-height: 100vh;
            color: var(--text-dark);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;

            /* â˜…ä¿®æ­£é‡é»ï¼šå¢åŠ é ‚éƒ¨è·é›¢ï¼Œè®“é ç±¤æŒ‰éˆ•ä¸é®ä½å…§å®¹ */
            padding-top: 190px;
        }

        /* --- èƒŒæ™¯æµé‡‘å‹•ç•« --- */
        body::before {
            content: '';
            position: fixed;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            z-index: -2;
            background: linear-gradient(45deg,
                    var(--bg-warm) 0%,
                    var(--gold-champagne) 25%,
                    var(--gold-light) 50%,
                    var(--gold-rich) 75%,
                    var(--bg-warm) 100%);
            background-size: 400% 400%;
            animation: flowingGold 60s ease infinite;
            opacity: 0.5;
            pointer-events: none;
        }

        @keyframes flowingGold {
            0% {
                background-position: 0% 50%;
            }

            50% {
                background-position: 100% 50%;
            }

            100% {
                background-position: 0% 50%;
            }
        }

        /* æœå°‹åˆ— */
        .search-container {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            padding: 24px 20px;
            z-index: 50;
            background: linear-gradient(to bottom, rgba(250, 249, 246, 0.95), rgba(250, 249, 246, 0.8));
            backdrop-filter: blur(20px);
            border-bottom: 1px solid var(--gold-champagne);
            box-shadow: 0 10px 30px -10px rgba(166, 124, 0, 0.15);
        }

        /* å¡ç‰‡è¨­è¨ˆ */
        .glass-card {
            background: linear-gradient(145deg, rgba(255, 255, 255, 0.95), rgba(253, 243, 224, 0.85));
            backdrop-filter: blur(20px);
            border: 1px solid rgba(212, 175, 55, 0.4);
            box-shadow: 0 8px 20px -5px rgba(166, 124, 0, 0.1);
            border-radius: 18px;
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .glass-card:active {
            transform: scale(0.98);
            background: #fff;
        }

        /* è¼¸å…¥æ¡† */
        .glass-input {
            background: rgba(255, 255, 255, 0.95);
            border: 2px solid var(--gold-champagne);
            color: #000;
            border-radius: 14px;
            transition: all 0.3s;
        }

        .glass-input:focus {
            background: white;
            border-color: var(--gold-rich);
            outline: none;
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.15);
        }

        /* å½ˆçª— */
        .glass-modal {
            background: linear-gradient(to bottom, #fffbf2, #fdf8ed);
            box-shadow: 0 -20px 60px rgba(80, 60, 0, 0.2);
            border-radius: 36px 36px 0 0;
            border-top: 1px solid rgba(212, 175, 55, 0.6);
            padding-bottom: env(safe-area-inset-bottom, 20px);
        }

        /* å­—é«”ç‰¹æ•ˆ */
        .text-gradient-gold {
            background: linear-gradient(135deg, #8a6200 0%, #d4af37 50%, #f1c40f 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
            filter: drop-shadow(0 1px 1px rgba(0, 0, 0, 0.05));
        }

        .font-serif-noble {
            font-family: "Times New Roman", Times, serif;
            letter-spacing: 0.5px;
        }

        /* ç·¨è¼¯è¦–çª—è¼¸å…¥æ¡† */
        .edit-input {
            background: transparent;
            border-bottom: 2px solid #a8a29e;
            border-radius: 0;
            color: #000;
            transition: all 0.3s ease;
        }

        .edit-input:focus {
            border-color: #d4af37;
            border-bottom-width: 3px;
        }

        .edit-label {
            color: #8a6200;
            font-weight: 800;
        }

        /* æŒ‰éˆ• */
        .btn-gold {
            background: linear-gradient(135deg, var(--gold-rich), var(--gold-dark));
            color: white;
            box-shadow: 0 4px 15px rgba(166, 124, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        ::-webkit-scrollbar-thumb {
            background: rgba(212, 175, 55, 0.3);
            border-radius: 4px;
        }

        /* åˆ—å°æˆåŠŸå‹•ç•« */
        @keyframes printSuccess {
            0% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }

            100% {
                transform: scale(1);
            }
        }

        @keyframes checkmark {
            0% {
                stroke-dashoffset: 100;
            }

            100% {
                stroke-dashoffset: 0;
            }
        }

        .print-success-animation {
            animation: printSuccess 0.5s ease;
        }

        .checkmark-animate {
            stroke-dasharray: 100;
            animation: checkmark 0.6s ease forwards;
        }

        /* å¿«é€Ÿæ•¸é‡æŒ‰éˆ• */
        .quick-qty-btn {
            background: var(--gold-champagne);
            color: var(--gold-dark);
            border: 2px solid rgba(212, 175, 55, 0.3);
            transition: all 0.2s;
        }

        .quick-qty-btn:hover {
            background: var(--gold-rich);
            color: white;
            border-color: transparent;
        }

        .quick-qty-btn:active {
            transform: scale(0.95);
        }

        /* æœ€è¿‘åˆ—å°ç´€éŒ„ */
        .recent-item {
            background: var(--gold-champagne);
            border: 1px solid rgba(212, 175, 55, 0.3);
            transition: all 0.2s;
        }

        .recent-item:hover {
            background: var(--gold-rich);
            color: white;
        }

        /* æš—è‰²æ¨¡å¼é©é… */
        :root.dark body {
            background-color: var(--bg-warm);
            color: var(--text-dark);
        }

        :root.dark body::before {
            opacity: 0.2;
        }

        :root.dark .search-container {
            background: linear-gradient(to bottom, rgba(26, 25, 24, 0.95), rgba(26, 25, 24, 0.8));
            border-color: var(--gold-champagne);
        }

        :root.dark .glass-card {
            background: var(--card-bg);
            border-color: rgba(212, 175, 55, 0.3);
        }

        :root.dark .glass-card:active {
            background: var(--card-bg-hover);
        }

        :root.dark .glass-input {
            background: rgba(45, 42, 35, 0.95);
            border-color: var(--gold-champagne);
            color: var(--text-dark);
        }

        :root.dark .glass-modal {
            background: var(--modal-bg);
        }

        :root.dark #overlay {
            background: var(--overlay-bg);
        }

        :root.dark .text-gradient-gold {
            background: linear-gradient(135deg, #f1c40f 0%, #d4af37 50%, #8a6200 100%);
            -webkit-background-clip: text;
        }

        /* â˜…â˜…â˜… æ‰¹é‡åˆ—å°æ¨¡å¼ â˜…â˜…â˜… */
        .batch-mode .glass-card {
            cursor: pointer;
        }

        .glass-card.selected {
            border: 3px solid var(--gold-rich);
            background: linear-gradient(145deg, rgba(212, 175, 55, 0.15), rgba(253, 243, 224, 0.95));
            box-shadow: 0 0 0 4px rgba(212, 175, 55, 0.2);
        }

        .glass-card .select-check {
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s;
        }

        .glass-card.selected .select-check {
            opacity: 1;
            transform: scale(1);
        }

        /* åº•éƒ¨å·¥å…·åˆ— */
        .bottom-toolbar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            padding: 16px 20px;
            padding-bottom: calc(16px + env(safe-area-inset-bottom, 0px));
            background: linear-gradient(to top, rgba(250, 249, 246, 0.98), rgba(250, 249, 246, 0.9));
            backdrop-filter: blur(20px);
            border-top: 1px solid var(--gold-champagne);
            box-shadow: 0 -10px 30px rgba(0, 0, 0, 0.05);
            transform: translateY(100%);
            transition: transform 0.3s ease;
            z-index: 25;
        }

        .bottom-toolbar.show {
            transform: translateY(0);
        }

        :root.dark .bottom-toolbar {
            background: linear-gradient(to top, rgba(26, 25, 24, 0.98), rgba(26, 25, 24, 0.9));
        }

        /* æ­·å²è¨˜éŒ„é ç±¤ */
        .tab-btn {
            padding: 8px 16px;
            border-radius: 20px;
            font-weight: 700;
            transition: all 0.2s;
        }

        .tab-btn.active {
            background: var(--gold-rich);
            color: white;
        }

        .tab-btn:not(.active) {
            background: var(--gold-champagne);
            color: var(--gold-dark);
        }

        /* æ­·å²è¨˜éŒ„é …ç›® */
        .history-item {
            background: var(--card-bg);
            border: 1px solid rgba(212, 175, 55, 0.2);
            border-radius: 12px;
            padding: 12px 16px;
        }
    </style>
</head>

<body class="pb-32">

    <div class="search-container">
        <div class="relative max-w-7xl mx-auto flex items-center gap-4">
            <div class="relative flex-1 group">
                <div class="absolute inset-y-0 left-0 pl-5 flex items-center pointer-events-none">
                    <svg class="h-6 w-6 text-yellow-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                        stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                    </svg>
                </div>
                <input type="text" id="searchInput" placeholder="æœå°‹ä»£è™Ÿæˆ–åç¨±..." autofocus
                    class="block w-full pl-14 pr-4 py-4 glass-input text-xl font-bold shadow-sm placeholder-stone-400">
            </div>
            <button onclick="openEditModal(null)"
                class="hidden md:flex btn-gold px-8 py-4 rounded-xl font-bold transition-all items-center gap-3 active:scale-95 tracking-wider">
                <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                </svg>
                æ–°å¢
            </button>
            <!-- æš—è‰²æ¨¡å¼åˆ‡æ›æŒ‰éˆ• -->
            <button onclick="toggleDarkMode()" id="darkModeBtn"
                class="w-12 h-12 rounded-xl bg-[#f0e2c5] hover:bg-[#d4af37] text-[#8a6200] hover:text-white flex items-center justify-center transition-all active:scale-95 border border-[#d4af37]/30">
                <svg id="sunIcon" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M12 3v1m0 16v1m9-9h-1M4 12H3m15.364 6.364l-.707-.707M6.343 6.343l-.707-.707m12.728 0l-.707.707M6.343 17.657l-.707.707M16 12a4 4 0 11-8 0 4 4 0 018 0z" />
                </svg>
                <svg id="moonIcon" class="w-6 h-6 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                    stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M20.354 15.354A9 9 0 018.646 3.646 9.003 9.003 0 0012 21a9.003 9.003 0 008.354-5.646z" />
                </svg>
            </button>

        </div>
        <!-- é ç±¤åˆ‡æ› -->
        <div class="flex justify-center items-center gap-2 mt-4 max-w-7xl mx-auto flex-wrap">
            <button onclick="switchTab('customers')" id="tabCustomers" class="tab-btn active">å®¢æˆ¶åˆ—è¡¨</button>
            <button onclick="switchTab('history')" id="tabHistory" class="tab-btn">åˆ—å°ç´€éŒ„</button>
            <button onclick="toggleBatchMode()" id="batchModeBtn" class="tab-btn">æ‰¹é‡åˆ—å°</button>
        </div>
    </div>

    <main id="listContainer" class="p-5 pt-2 grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-w-7xl mx-auto">
    </main>

    <!-- æ­·å²ç´€éŒ„å®¹å™¨ -->
    <div id="historyContainer" class="hidden p-5 pt-2 max-w-7xl mx-auto">
        <div id="historyList" class="space-y-3"></div>
        <div class="text-center mt-6">
            <button onclick="clearHistory()" class="text-red-500 font-bold text-sm hover:underline">æ¸…é™¤æ‰€æœ‰ç´€éŒ„</button>
        </div>
    </div>

    <!-- æ–°å¢æŒ‰éˆ•ï¼ˆæ‰‹æ©Ÿç‰ˆï¼‰ -->
    <button id="addBtnMobile" onclick="openEditModal(null)"
        class="md:hidden fixed bottom-8 right-6 w-16 h-16 rounded-full shadow-2xl flex items-center justify-center active:scale-95 transition-transform z-20 border-2 border-[#d4af37] bg-gradient-to-br from-[#a67c00] to-[#d4af37] overflow-hidden text-white">
        <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2.5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
        </svg>
    </button>

    <!-- æ‰¹é‡åˆ—å°å·¥å…·åˆ— -->
    <div id="batchToolbar" class="bottom-toolbar">
        <div class="max-w-7xl mx-auto flex items-center justify-between gap-4">
            <div class="flex items-center gap-3">
                <span class="font-bold text-[var(--text-dark)]">å·²é¸æ“‡ <span id="selectedCount"
                        class="text-[#d4af37] text-xl">0</span> ä½å®¢æˆ¶</span>
            </div>
            <div class="flex items-center gap-3">
                <div class="flex items-center gap-2">
                    <span class="text-sm font-bold text-[#8a6200]">æ¯äºº</span>
                    <input type="number" id="batchQty" value="1" min="1"
                        class="w-16 text-center py-2 rounded-lg border-2 border-[#d4af37]/30 font-bold text-lg">
                    <span class="text-sm font-bold text-[#8a6200]">ä»½</span>
                </div>
                <button onclick="doBatchPrint()"
                    class="btn-gold px-6 py-3 rounded-xl font-bold flex items-center gap-2 active:scale-95">
                    <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                        <path stroke-linecap="round" stroke-linejoin="round"
                            d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
                    </svg>
                    å…¨éƒ¨åˆ—å°
                </button>
            </div>
        </div>
    </div>

    <div id="overlay"
        class="fixed inset-0 bg-[#1c1917]/50 backdrop-blur-[2px] z-30 hidden transition-opacity opacity-0 duration-500"
        onclick="closeAllModals()"></div>

    <div id="editModal"
        class="fixed bottom-0 left-0 right-0 glass-modal z-40 transform translate-y-full transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) p-8 pb-12 max-w-2xl mx-auto">
        <div class="w-16 h-1.5 bg-[#d4af37]/40 rounded-full mx-auto mb-10"></div>
        <h2 id="modalTitle"
            class="text-3xl font-black text-center text-[#1c1917] mb-12 tracking-wider font-serif-noble">æ–°å¢å®¢æˆ¶</h2>

        <input type="hidden" id="originalCode">
        <div class="space-y-12 px-2">
            <div class="relative mt-2">
                <input type="text" id="inputCode"
                    class="edit-input peer w-full py-3 text-4xl font-mono font-black focus:outline-none uppercase placeholder-transparent"
                    placeholder="Code">
                <label
                    class="edit-label absolute left-0 -top-6 text-sm font-bold uppercase tracking-widest transition-all peer-placeholder-shown:text-xl peer-placeholder-shown:text-stone-400 peer-placeholder-shown:top-2 peer-focus:-top-6 peer-focus:text-sm">ä»£è™Ÿ
                    (Code)</label>
            </div>
            <div class="relative mt-2">
                <input type="text" id="inputName"
                    class="edit-input peer w-full py-3 text-3xl font-bold focus:outline-none placeholder-transparent"
                    placeholder="Name">
                <label
                    class="edit-label absolute left-0 -top-6 text-sm font-bold uppercase tracking-widest transition-all peer-placeholder-shown:text-xl peer-placeholder-shown:text-stone-400 peer-placeholder-shown:top-2 peer-focus:-top-6 peer-focus:text-sm">åç¨±
                    (Name)</label>
            </div>
        </div>

        <div class="flex gap-4 mt-16">
            <button id="btnDelete" onclick="deleteCurrent()"
                class="hidden w-20 h-16 flex items-center justify-center bg-red-50 text-red-600 border-2 border-red-200 rounded-2xl hover:bg-red-100 transition-all active:scale-95">
                <svg class="w-8 h-8" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                    <path stroke-linecap="round" stroke-linejoin="round"
                        d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                </svg>
            </button>
            <button onclick="saveCustomer()"
                class="flex-1 btn-gold h-16 rounded-2xl font-bold text-xl active:scale-[0.98] transition-transform tracking-widest shadow-lg">å„²å­˜è³‡æ–™</button>
        </div>
    </div>

    <div id="printModal"
        class="fixed bottom-0 left-0 right-0 glass-modal z-40 transform translate-y-full transition-transform duration-500 cubic-bezier(0.32, 0.72, 0, 1) p-6 pb-8 max-w-2xl mx-auto max-h-[85vh] overflow-y-auto">
        <div class="w-12 h-1 bg-[#d4af37]/40 rounded-full mx-auto mb-6"></div>

        <div class="text-center mb-6">
            <h2 id="printName" class="text-3xl font-black text-[#1c1917] leading-tight px-2 break-all font-serif-noble">
                å®¢æˆ¶åç¨±</h2>
            <p class="text-[#8a6200] font-bold mt-2 text-lg tracking-wider">æº–å‚™åˆ—å°æ¨™ç±¤</p>
        </div>

        <div class="flex items-center justify-center gap-4 mb-6">
            <button onclick="updateQty(-1)"
                class="w-14 h-14 rounded-full bg-[#f0e2c5] text-[#8a6200] border-2 border-[#d4af37]/20 text-3xl font-light flex items-center justify-center active:scale-90 hover:bg-[#d4af37] hover:text-white transition-all">-</button>
            <div class="flex flex-col items-center w-28">
                <input type="number" id="printQtyInput" inputmode="numeric" pattern="[0-9]*" value="1" min="1"
                    onchange="syncQty(this.value)"
                    class="w-full bg-transparent text-center text-6xl font-black text-[#1c1917] outline-none p-0 font-serif-noble">
                <span class="text-xs font-bold text-[#8a6200] mt-1 uppercase tracking-[0.2em]">ä»½æ•¸</span>
            </div>
            <button onclick="updateQty(1)"
                class="w-14 h-14 rounded-full bg-[#f0e2c5] text-[#8a6200] border-2 border-[#d4af37]/20 text-3xl font-light flex items-center justify-center active:scale-90 hover:bg-[#d4af37] hover:text-white transition-all">+</button>
        </div>

        <!-- å¿«é€Ÿæ•¸é‡æŒ‰éˆ• -->
        <div class="flex justify-center gap-2 mb-6">
            <button onclick="setQty(5)" class="quick-qty-btn px-4 py-2 rounded-full font-bold">5</button>
            <button onclick="setQty(10)" class="quick-qty-btn px-4 py-2 rounded-full font-bold">10</button>
            <button onclick="setQty(20)" class="quick-qty-btn px-4 py-2 rounded-full font-bold">20</button>
        </div>

        <button id="printBtn" onclick="doPrint()"
            class="w-full btn-gold py-4 rounded-2xl font-bold text-xl active:scale-[0.98] transition-transform flex items-center justify-center gap-3 tracking-wider">
            <svg id="printIcon" class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                <path stroke-linecap="round" stroke-linejoin="round"
                    d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z" />
            </svg>
            <svg id="successIcon" class="w-7 h-7 hidden" fill="none" viewBox="0 0 24 24" stroke="currentColor"
                stroke-width="3">
                <path class="checkmark-animate" stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
            </svg>
            <span id="printBtnText">ç¢ºèªåˆ—å°</span>
        </button>

        <!-- æœ€è¿‘åˆ—å°ç´€éŒ„ -->
        <div id="recentPrintsContainer" class="mt-6 hidden">
            <p class="text-center text-xs font-bold text-[#8a6200] mb-2 uppercase tracking-widest">æœ€è¿‘åˆ—å°</p>
            <div id="recentPrints" class="flex flex-wrap justify-center gap-2"></div>
        </div>
    </div>

    <div id="toast"
        class="fixed top-28 left-1/2 -translate-x-1/2 bg-gradient-to-r from-[#292524] to-[#000] text-[#f1c40f] px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 font-bold tracking-wide border border-[#d4af37]/50 text-base flex items-center gap-2 whitespace-nowrap">
        <span id="toastIcon">âœ¨</span><span id="toastMsg">æˆåŠŸ</span>
    </div>

    <script>
        let customers = [];
        let currentPrintName = "";
        let currentQty = 1;
        let customerElements = [];

        // â˜…â˜…â˜… æ‰¹é‡åˆ—å°æ¨¡å¼ â˜…â˜…â˜…
        let batchMode = false;
        let selectedCustomers = new Set();

        // â˜…â˜…â˜… æœ€è¿‘åˆ—å°ç´€éŒ„ï¼ˆå­˜åœ¨ localStorageï¼‰â˜…â˜…â˜…
        const MAX_RECENT = 5;
        function getRecentPrints() {
            try {
                return JSON.parse(localStorage.getItem('recentPrints') || '[]');
            } catch { return []; }
        }
        function addRecentPrint(name) {
            let recent = getRecentPrints().filter(n => n !== name);
            recent.unshift(name);
            if (recent.length > MAX_RECENT) recent = recent.slice(0, MAX_RECENT);
            localStorage.setItem('recentPrints', JSON.stringify(recent));
            renderRecentPrints();
        }
        function renderRecentPrints() {
            const recent = getRecentPrints();
            const container = document.getElementById('recentPrintsContainer');
            const list = document.getElementById('recentPrints');
            if (recent.length === 0) {
                container.classList.add('hidden');
                return;
            }
            container.classList.remove('hidden');
            list.innerHTML = recent.map(name =>
                `<button onclick="event.stopPropagation(); openPrintModal('${name}')" 
                    class="recent-item px-4 py-2 rounded-full text-sm font-bold text-[#8a6200]">${name}</button>`
            ).join('');
        }

        // â˜…â˜…â˜… æš—è‰²æ¨¡å¼ â˜…â˜…â˜…
        function initDarkMode() {
            const isDark = localStorage.getItem('darkMode') === 'true';
            if (isDark) {
                document.documentElement.classList.add('dark');
                updateDarkModeIcons(true);
            }
        }
        function toggleDarkMode() {
            const isDark = document.documentElement.classList.toggle('dark');
            localStorage.setItem('darkMode', isDark);
            updateDarkModeIcons(isDark);
        }
        function updateDarkModeIcons(isDark) {
            document.getElementById('sunIcon').classList.toggle('hidden', isDark);
            document.getElementById('moonIcon').classList.toggle('hidden', !isDark);
        }

        // â˜…â˜…â˜… å¿«é€Ÿæ•¸é‡è¨­å®š â˜…â˜…â˜…
        function setQty(qty) {
            currentQty = qty;
            updateInputDisplay();
        }

        // â˜…â˜…â˜… é ç±¤åˆ‡æ› â˜…â˜…â˜…
        function switchTab(tab) {
            const listContainer = document.getElementById('listContainer');
            const historyContainer = document.getElementById('historyContainer');
            const settingsContainer = document.getElementById('settingsContainer');
            const tabs = ['tabCustomers', 'tabHistory', 'tabSettings'];

            // éš±è—æ‰€æœ‰å®¹å™¨
            listContainer.classList.add('hidden');
            historyContainer.classList.add('hidden');
            settingsContainer.classList.add('hidden');

            // ç§»é™¤æ‰€æœ‰ active
            tabs.forEach(t => document.getElementById(t)?.classList.remove('active'));

            if (tab === 'customers') {
                listContainer.classList.remove('hidden');
                document.getElementById('tabCustomers').classList.add('active');
            } else if (tab === 'history') {
                historyContainer.classList.remove('hidden');
                document.getElementById('tabHistory').classList.add('active');
                loadHistory();
            } else if (tab === 'settings') {
                settingsContainer.classList.remove('hidden');
                document.getElementById('tabSettings').classList.add('active');
                loadSettings();
            }
            // å¦‚æœåœ¨æ‰¹é‡æ¨¡å¼åˆ‡æ›é ç±¤ï¼Œå…ˆé—œé–‰æ‰¹é‡æ¨¡å¼
            if (batchMode) toggleBatchMode();
        }

        // â˜…â˜…â˜… è¨­å®šåŠŸèƒ½ â˜…â˜…â˜…
        let appSettings = { has_password: false, label_template: '{name}', printer_name: '' };

        // â˜…â˜…â˜… é ç±¤åˆ‡æ› â˜…â˜…â˜…
        function switchTab(tab) {
            const listContainer = document.getElementById('listContainer');
            const historyContainer = document.getElementById('historyContainer');

            if (tab === 'customers') {
                listContainer.classList.remove('hidden');
                historyContainer.classList.add('hidden');
                document.getElementById('tabCustomers').classList.add('active');
                document.getElementById('tabHistory').classList.remove('active');
            } else {
                listContainer.classList.add('hidden');
                historyContainer.classList.remove('hidden');
                document.getElementById('tabCustomers').classList.remove('active');
                document.getElementById('tabHistory').classList.add('active');
                loadHistory();
            }
            // å¦‚æœåœ¨æ‰¹é‡æ¨¡å¼åˆ‡æ›é ç±¤ï¼Œå…ˆé—œé–‰æ‰¹é‡æ¨¡å¼
            if (batchMode) toggleBatchMode();
        }



        // â˜…â˜…â˜… æ­·å²è¨˜éŒ„ â˜…â˜…â˜…
        async function loadHistory() {
            try {
                const res = await fetch('/api/history?limit=50');
                const history = await res.json();
                renderHistory(history);
            } catch (e) {
                showToast('ç„¡æ³•è¼‰å…¥æ­·å²è¨˜éŒ„', 'âš ï¸');
            }
        }
        function renderHistory(history) {
            const list = document.getElementById('historyList');
            if (history.length === 0) {
                list.innerHTML = '<div class="text-center text-[#8a6200] font-bold py-12">ç›®å‰æ²’æœ‰åˆ—å°ç´€éŒ„</div>';
                return;
            }
            list.innerHTML = history.map(h => {
                const date = new Date(h.timestamp);
                const timeStr = date.toLocaleString('zh-TW', {
                    month: 'numeric', day: 'numeric',
                    hour: '2-digit', minute: '2-digit'
                });
                const deviceStr = h.device ? `<div class="text-xs text-[#d4af37] font-mono mt-1">${h.device}</div>` : '';
                return `
                    <div class="history-item flex items-center justify-between">
                        <div>
                            <span class="font-bold text-[var(--text-dark)]">${h.customer_name}</span>
                            <span class="text-[#8a6200] font-bold ml-2">Ã— ${h.copies}</span>
                            ${deviceStr}
                        </div>
                        <span class="text-sm text-stone-400 pl-2 text-right">${timeStr}</span>
                    </div>
                `;
            }).join('');
        }
        async function clearHistory() {
            if (!confirm('ç¢ºå®šè¦æ¸…é™¤æ‰€æœ‰åˆ—å°ç´€éŒ„å—ï¼Ÿ')) return;
            try {
                await fetch('/api/history', { method: 'DELETE' });
                loadHistory();
                showToast('å·²æ¸…é™¤ç´€éŒ„', 'ğŸ—‘ï¸');
            } catch (e) {
                showToast('æ¸…é™¤å¤±æ•—', 'âŒ');
            }
        }

        // â˜…â˜…â˜… æ‰¹é‡åˆ—å°æ¨¡å¼ â˜…â˜…â˜…
        function toggleBatchMode() {
            batchMode = !batchMode;
            selectedCustomers.clear();
            updateBatchUI();

            const body = document.body;
            const toolbar = document.getElementById('batchToolbar');
            const batchBtn = document.getElementById('batchModeBtn');
            const addBtn = document.getElementById('addBtnMobile');

            if (batchMode) {
                body.classList.add('batch-mode');
                toolbar.classList.add('show');
                batchBtn.classList.add('active');
                if (addBtn) addBtn.classList.add('hidden');
                showToast('é»æ“Šé¸æ“‡è¦åˆ—å°çš„å®¢æˆ¶', 'ğŸ‘†');
            } else {
                body.classList.remove('batch-mode');
                toolbar.classList.remove('show');
                batchBtn.classList.remove('active');
                if (addBtn) addBtn.classList.remove('hidden');
                // ç§»é™¤æ‰€æœ‰é¸ä¸­ç‹€æ…‹
                document.querySelectorAll('.glass-card.selected').forEach(el => el.classList.remove('selected'));
            }
            renderAll(customers);
        }
        function updateBatchUI() {
            document.getElementById('selectedCount').textContent = selectedCustomers.size;
        }
        function toggleSelectCustomer(name, el) {
            if (selectedCustomers.has(name)) {
                selectedCustomers.delete(name);
                el.classList.remove('selected');
            } else {
                selectedCustomers.add(name);
                el.classList.add('selected');
            }
            updateBatchUI();
        }
        async function doBatchPrint() {
            if (selectedCustomers.size === 0) {
                showToast('è«‹å…ˆé¸æ“‡å®¢æˆ¶', 'âš ï¸');
                return;
            }
            const qty = parseInt(document.getElementById('batchQty').value) || 1;
            const items = Array.from(selectedCustomers).map(name => ({
                customer_name: name,
                copies: qty
            }));

            showToast(`æ­£åœ¨åˆ—å° ${items.length} ä½å®¢æˆ¶...`, 'ğŸ–¨ï¸');
            try {
                const res = await fetch('/api/print/batch', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ items })
                });
                const result = await res.json();
                if (result.status === 'success') {
                    showToast(`å·²å®Œæˆ ${result.total} ä»½`, 'âœ…');
                    toggleBatchMode();
                } else {
                    showToast(result.message || 'åˆ—å°å¤±æ•—', 'âŒ');
                }
            } catch (e) {
                showToast('åˆ—å°å¤±æ•—', 'âŒ');
            }
        }

        window.addEventListener('load', () => {
            const input = document.getElementById('searchInput');
            if (input) input.focus();
            initDarkMode();
            renderRecentPrints();
        });

        document.addEventListener('click', (e) => {
            const isInteractive = e.target.closest('button, input, .glass-card, .glass-modal');
            if (!isInteractive && !document.getElementById('editModal').classList.contains('translate-y-0')) {
                document.getElementById('searchInput').focus();
            }
        });

        async function init() { await fetchCustomers(); }

        async function fetchCustomers() {
            try {
                const res = await fetch('/api/customers');
                customers = await res.json();
                renderAll(customers);
            } catch (e) { showToast('ç„¡æ³•é€£ç·š', 'âš ï¸'); }
        }

        function renderAll(data) {
            const container = document.getElementById('listContainer');

            if (data.length === 0) {
                container.innerHTML = `<div class="col-span-full text-center mt-24 text-[#8a6200] font-bold text-2xl font-serif-noble">ç›®å‰æ²’æœ‰è³‡æ–™</div>`;
                return;
            }

            container.innerHTML = data.map((c, index) => {
                const isSelected = selectedCustomers.has(c.name);
                const clickHandler = batchMode
                    ? `toggleSelectCustomer('${c.name}', this)`
                    : `openPrintModal('${c.name}')`;
                return `
                <div id="card-${index}" class="glass-card p-5 flex items-center justify-between min-h-[90px] cursor-pointer group ${isSelected ? 'selected' : ''}" onclick="${clickHandler}">
                    
                    <!-- é¸ä¸­å‹¾å‹¾ -->
                    <div class="select-check absolute top-2 right-2 w-6 h-6 rounded-full bg-[#d4af37] text-white flex items-center justify-center">
                        <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="3">
                            <path stroke-linecap="round" stroke-linejoin="round" d="M5 13l4 4L19 7" />
                        </svg>
                    </div>
                    
                    <div class="flex items-center gap-2 shrink-0 pr-4 border-r-2 border-[#d4af37]/20 w-[90px] md:w-[120px] justify-center">
                        <span class="text-3xl md:text-4xl font-black text-gradient-gold font-serif-noble tracking-tight">
                            ${c.code}
                        </span>
                    </div>

                    <div class="flex-1 flex items-center justify-between pl-4 overflow-hidden min-w-0"> 
                        <h3 class="text-xl md:text-2xl font-bold text-[var(--text-dark)] truncate whitespace-nowrap group-hover:opacity-80 transition-opacity">
                            ${c.name}
                        </h3>
                        
                        ${!batchMode ? `
                        <button onclick="event.stopPropagation(); openEditModal('${c.code}')" class="w-10 h-10 flex shrink-0 items-center justify-center rounded-full bg-[#f0e2c5]/50 text-[#8a6200] hover:text-white hover:bg-[#d4af37] active:scale-90 ml-2 transition-all opacity-100 border border-[#d4af37]/10 hover:border-transparent">
                            <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                        ` : ''}
                    </div>
                </div>
            `}).join('');

            customerElements = data.map((c, index) => ({
                el: document.getElementById(`card-${index}`),
                searchStr: (c.code + c.name).toLowerCase()
            }));
        }

        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            customerElements.forEach(item => {
                item.el.style.display = item.searchStr.includes(term) ? '' : 'none';
            });
        });

        function openPrintModal(name) {
            if (batchMode) return; // æ‰¹é‡æ¨¡å¼ä¸é–‹å–®ç¨åˆ—å°
            currentPrintName = name;
            currentQty = 1;
            document.getElementById('printName').innerText = name;
            updateInputDisplay();
            resetPrintButton();
            renderRecentPrints();
            showModal('printModal');
        }
        function updateQty(delta) {
            let newQty = currentQty + delta;
            if (newQty < 1) newQty = 1;
            currentQty = newQty;
            updateInputDisplay();
        }
        function syncQty(val) {
            let parsed = parseInt(val);
            if (isNaN(parsed) || parsed < 1) parsed = 1;
            currentQty = parsed;
            updateInputDisplay();
        }
        function updateInputDisplay() {
            document.getElementById('printQtyInput').value = currentQty;
        }

        // â˜…â˜…â˜… åˆ—å°æˆåŠŸå‹•ç•« â˜…â˜…â˜…
        function resetPrintButton() {
            const btn = document.getElementById('printBtn');
            const printIcon = document.getElementById('printIcon');
            const successIcon = document.getElementById('successIcon');
            const btnText = document.getElementById('printBtnText');
            btn.classList.remove('print-success-animation');
            printIcon.classList.remove('hidden');
            successIcon.classList.add('hidden');
            btnText.innerText = 'ç¢ºèªåˆ—å°';
        }
        function showPrintSuccess() {
            const btn = document.getElementById('printBtn');
            const printIcon = document.getElementById('printIcon');
            const successIcon = document.getElementById('successIcon');
            const btnText = document.getElementById('printBtnText');

            printIcon.classList.add('hidden');
            successIcon.classList.remove('hidden');
            btnText.innerText = 'åˆ—å°æˆåŠŸï¼';
            btn.classList.add('print-success-animation');
        }

        async function doPrint() {
            showToast(`æ­£åœ¨åˆ—å° ${currentQty} ä»½...`, 'ğŸ–¨ï¸');
            try {
                const res = await fetch('/api/print', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ customer_name: currentPrintName, copies: currentQty })
                });
                if (res.ok) {
                    addRecentPrint(currentPrintName);
                    showPrintSuccess();
                    setTimeout(() => {
                        closeAllModals();
                        showToast(`å·²å®Œæˆ ${currentQty} ä»½`, 'âœ…');
                    }, 800);
                } else {
                    showToast('åˆ—å°å¤±æ•—', 'âŒ');
                }
            } catch (e) {
                showToast('åˆ—å°å¤±æ•—', 'âŒ');
            }
        }
        function openEditModal(code) {
            const isEdit = !!code;
            document.getElementById('modalTitle').innerText = isEdit ? "ç·¨è¼¯å®¢æˆ¶" : "æ–°å¢å®¢æˆ¶";
            document.getElementById('btnDelete').classList.toggle('hidden', !isEdit);
            const inputCode = document.getElementById('inputCode');
            const inputName = document.getElementById('inputName');

            if (isEdit) {
                const c = customers.find(x => x.code === code);
                inputCode.value = c.code;
                inputName.value = c.name;
                document.getElementById('originalCode').value = c.code;
            } else {
                inputCode.value = "";
                inputName.value = "";
                document.getElementById('originalCode').value = "";
            }
            inputCode.dispatchEvent(new Event('input', { bubbles: true }));
            inputName.dispatchEvent(new Event('input', { bubbles: true }));

            showModal('editModal');
            setTimeout(() => document.getElementById(isEdit ? 'inputName' : 'inputCode').focus(), 400);
        }
        async function saveCustomer() {
            const code = document.getElementById('inputCode').value.toUpperCase().trim();
            const name = document.getElementById('inputName').value.trim();
            const oldCode = document.getElementById('originalCode').value;
            if (!code || !name) return showToast('è«‹è¼¸å…¥å®Œæ•´è³‡æ–™', 'âš ï¸');
            const isEdit = !!oldCode;
            const url = isEdit ? `/api/customers/${oldCode}` : '/api/customers';
            const method = isEdit ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ code, name })
                });
                if (res.ok) { closeAllModals(); fetchCustomers(); showToast('è³‡æ–™å·²å„²å­˜', 'âœ¨'); }
                else { showToast('ä»£è™Ÿå·²å­˜åœ¨', 'âš ï¸'); }
            } catch (e) { showToast('å„²å­˜å¤±æ•—', 'âŒ'); }
        }
        async function deleteCurrent() {
            if (!confirm('ç¢ºå®šè¦åˆªé™¤æ­¤å®¢æˆ¶å—?')) return;
            const code = document.getElementById('originalCode').value;
            await fetch(`/api/customers/${code}`, { method: 'DELETE' });
            closeAllModals(); fetchCustomers(); showToast('å®¢æˆ¶å·²åˆªé™¤', 'ğŸ—‘ï¸');
        }
        function showModal(id) {
            document.getElementById('overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('overlay').classList.remove('opacity-0'), 10);
            document.getElementById(id).classList.remove('translate-y-full');
        }
        function closeAllModals() {
            document.getElementById('overlay').classList.add('opacity-0');
            setTimeout(() => document.getElementById('overlay').classList.add('hidden'), 500);
            ['printModal', 'editModal'].forEach(id => {
                document.getElementById(id).classList.add('translate-y-full');
            });
            document.getElementById('searchInput').focus();
        }
        function showToast(msg, icon = 'âœ¨') {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            document.getElementById('toastIcon').innerText = icon;
            t.classList.remove('opacity-0', 'translate-y-[-20px]');
            setTimeout(() => t.classList.add('opacity-0', 'translate-y-[-20px]'), 2500);
        }

        // â˜…â˜…â˜… éµç›¤å¿«æ·éµ â˜…â˜…â˜…
        document.addEventListener('keydown', (e) => {
            const printModal = document.getElementById('printModal');
            const editModal = document.getElementById('editModal');
            const isPrintModalOpen = !printModal.classList.contains('translate-y-full');
            const isEditModalOpen = !editModal.classList.contains('translate-y-full');

            // Escapeï¼šé—œé–‰å½ˆçª—æˆ–é€€å‡ºæ‰¹é‡æ¨¡å¼
            if (e.key === 'Escape') {
                if (isPrintModalOpen || isEditModalOpen) {
                    closeAllModals();
                    e.preventDefault();
                } else if (batchMode) {
                    toggleBatchMode();
                    e.preventDefault();
                }
                return;
            }

            // ä»¥ä¸‹å¿«æ·éµåªåœ¨åˆ—å°å½ˆçª—é–‹å•Ÿæ™‚æœ‰æ•ˆ
            if (!isPrintModalOpen) return;

            // é¿å…åœ¨å…¶ä»–è¼¸å…¥æ¡†å…§è§¸ç™¼
            if (document.activeElement.tagName === 'INPUT' && document.activeElement.id !== 'printQtyInput') return;

            switch (e.key) {
                case 'Enter':
                    // Enterï¼šç¢ºèªåˆ—å°
                    e.preventDefault();
                    doPrint();
                    break;
                case 'ArrowUp':
                    // â†‘ï¼šæ•¸é‡ +1
                    e.preventDefault();
                    updateQty(1);
                    break;
                case 'ArrowDown':
                    // â†“ï¼šæ•¸é‡ -1
                    e.preventDefault();
                    updateQty(-1);
                    break;
                case 'ArrowRight':
                    // â†’ï¼šæ•¸é‡ +5
                    e.preventDefault();
                    updateQty(5);
                    break;
                case 'ArrowLeft':
                    // â†ï¼šæ•¸é‡ -5
                    e.preventDefault();
                    updateQty(-5);
                    break;
            }
        });

        init();
    </script>
</body>

</html>