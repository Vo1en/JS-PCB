<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>æ¨™ç±¤ç³»çµ±</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            background-color: #f3f4f6;
            min-height: 100vh;
            color: #334155;
            font-family: -apple-system, BlinkMacSystemFont, "SF Pro TC", "Microsoft JhengHei", sans-serif;
            -webkit-tap-highlight-color: transparent;
            user-select: none;
            overflow-x: hidden;
            padding-top: 80px; /* é ç•™çµ¦æœå°‹æ¡†çš„é«˜åº¦ */
        }

        /* èƒŒæ™¯æµå‹•å…‰æ–‘ */
        .ambient-light {
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
            background: white;
        }
        .blob {
            position: absolute;
            filter: blur(90px);
            opacity: 0.6;
            animation: float 10s infinite ease-in-out;
        }
        .blob-1 { background: #bfdbfe; width: 400px; height: 400px; top: -10%; left: -10%; }
        .blob-2 { background: #e9d5ff; width: 350px; height: 350px; top: 40%; right: -10%; animation-delay: 2s; }
        .blob-3 { background: #fbcfe8; width: 400px; height: 400px; bottom: -10%; left: 20%; animation-delay: 4s; }

        @keyframes float { 0%, 100% { transform: translate(0, 0); } 50% { transform: translate(20px, 30px); } }

        /* æœå°‹æ¡†æ‡¸æµ®ç»ç’ƒ */
        .search-container {
            position: fixed;
            top: 0; left: 0; right: 0;
            padding: 16px;
            z-index: 50;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 20px rgba(0,0,0,0.03);
        }

        /* å¡ç‰‡æ¨£å¼ */
        .glass-card {
            background: rgba(255, 255, 255, 0.65);
            backdrop-filter: blur(20px) saturate(180%);
            border: 1px solid rgba(255, 255, 255, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.02);
            border-radius: 20px;
            transition: transform 0.1s;
        }
        .glass-card:active { transform: scale(0.98); background: rgba(255, 255, 255, 0.85); }

        /* è¼¸å…¥æ¡† */
        .glass-input {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(0, 0, 0, 0.1);
            color: #1e293b;
            border-radius: 14px;
        }
        .glass-input:focus {
            background: white;
            border-color: #3b82f6;
            outline: none;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.2);
        }

        /* å½ˆçª— */
        .glass-modal {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(30px);
            border-radius: 32px 32px 0 0;
            box-shadow: 0 -10px 40px rgba(0, 0, 0, 0.15);
        }

        .text-gradient {
            background: linear-gradient(135deg, #2563eb 0%, #0891b2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            font-weight: 900;
        }
    </style>
</head>
<body class="pb-32">

    <div class="ambient-light">
        <div class="blob blob-1 rounded-full"></div>
        <div class="blob blob-2 rounded-full"></div>
        <div class="blob blob-3 rounded-full"></div>
    </div>

    <div class="search-container">
        <div class="relative max-w-3xl mx-auto">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <svg class="h-6 w-6 text-slate-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
            </div>
            <input type="text" id="searchInput" placeholder="ç›´æ¥è¼¸å…¥ä»£è™Ÿæˆ–åç¨±..." autofocus
                   class="block w-full pl-11 pr-4 py-3.5 glass-input text-xl font-bold placeholder-slate-400 transition-all shadow-sm">
        </div>
    </div>

    <main id="listContainer" class="p-4 grid grid-cols-1 gap-3 max-w-3xl mx-auto">
        </main>

    <button onclick="openEditModal(null)" class="fixed bottom-8 right-6 w-16 h-16 rounded-full shadow-lg flex items-center justify-center active:scale-95 transition-transform z-20 border-2 border-white bg-slate-800 overflow-hidden">
        <svg class="w-8 h-8 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M12 4v16m8-8H4"/></svg>
    </button>

    <div id="overlay" class="fixed inset-0 bg-slate-600/20 backdrop-blur-[2px] z-30 hidden transition-opacity opacity-0 duration-300" onclick="closeAllModals()"></div>

    <div id="editModal" class="fixed bottom-0 left-0 right-0 glass-modal z-40 transform translate-y-full transition-transform duration-300 p-6 pb-10 max-w-2xl mx-auto">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
        <h2 id="modalTitle" class="text-2xl font-black text-center text-slate-800 mb-8">æ–°å¢å®¢æˆ¶</h2>
        
        <input type="hidden" id="originalCode"> 
        <div class="space-y-8 px-2">
            <div>
                <input type="text" id="inputCode" class="w-full bg-transparent border-b-2 border-slate-200 py-2 text-4xl font-mono font-black text-slate-800 focus:outline-none focus:border-blue-500 uppercase placeholder-slate-300" placeholder="ä»£è™Ÿ (CODE)">
            </div>
            <div>
                <input type="text" id="inputName" class="w-full bg-transparent border-b-2 border-slate-200 py-2 text-3xl font-bold text-slate-800 focus:outline-none focus:border-blue-500 placeholder-slate-300" placeholder="åç¨± (NAME)">
            </div>
        </div>

        <div class="flex gap-4 mt-12">
            <button id="btnDelete" onclick="deleteCurrent()" class="hidden w-20 h-16 flex items-center justify-center bg-red-50 text-red-500 border border-red-100 rounded-2xl">
                <svg class="w-7 h-7" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
            </button>
            <button onclick="saveCustomer()" class="flex-1 bg-slate-900 text-white h-16 rounded-2xl font-bold text-xl shadow-lg active:scale-[0.98]">å„²å­˜</button>
        </div>
    </div>

    <div id="printModal" class="fixed bottom-0 left-0 right-0 glass-modal z-40 transform translate-y-full transition-transform duration-300 p-6 pb-10 max-w-2xl mx-auto">
        <div class="w-12 h-1.5 bg-slate-200 rounded-full mx-auto mb-8"></div>
        
        <div class="text-center mb-8">
            <h2 id="printName" class="text-4xl font-black text-slate-800 leading-tight px-1 break-all">å®¢æˆ¶åç¨±</h2>
        </div>

        <div class="flex items-center justify-center gap-6 mb-10">
            <button onclick="updateQty(-1)" class="w-16 h-16 rounded-full bg-slate-100 text-slate-400 text-4xl font-light flex items-center justify-center active:scale-95">-</button>
            <div class="flex flex-col items-center w-32">
                <input type="number" id="printQtyInput" value="1" min="1" onchange="syncQty(this.value)"
                       class="w-full bg-transparent text-center text-6xl font-black text-slate-800 outline-none p-0">
                <span class="text-xs font-bold text-slate-400 mt-2 uppercase">ä»½æ•¸</span>
            </div>
            <button onclick="updateQty(1)" class="w-16 h-16 rounded-full bg-slate-100 text-slate-400 text-4xl font-light flex items-center justify-center active:scale-95">+</button>
        </div>

        <button onclick="doPrint()" class="w-full bg-blue-600 text-white py-5 rounded-2xl font-bold text-2xl shadow-xl shadow-blue-200 active:scale-[0.98] transition-transform flex items-center justify-center gap-3">
            <span>ç¢ºèªåˆ—å°</span>
        </button>
    </div>

    <div id="toast" class="fixed top-24 left-1/2 -translate-x-1/2 bg-slate-800/90 backdrop-blur text-white px-6 py-3 rounded-full shadow-2xl opacity-0 transition-opacity pointer-events-none z-50 font-bold tracking-wide">
        <span id="toastMsg">æˆåŠŸ</span>
    </div>

    <script>
        let customers = [];
        let currentPrintName = "";
        let currentQty = 1;
        
        // â˜… å¿«å– DOM å…ƒç´ ï¼Œæå‡æœå°‹æ•ˆèƒ½
        let customerElements = []; 

        async function init() { await fetchCustomers(); }

        async function fetchCustomers() {
            try {
                const res = await fetch('/api/customers');
                customers = await res.json();
                renderAll(customers);
            } catch (e) { showToast('ç„¡æ³•é€£ç·š'); }
        }

        // â˜… ä¸€æ¬¡æ€§æ¸²æŸ“æ‰€æœ‰å¡ç‰‡ï¼Œæœå°‹æ™‚åªåˆ‡æ›é¡¯ç¤ºç‹€æ…‹ (Display Toggle)
        function renderAll(data) {
            const container = document.getElementById('listContainer');
            
            if(data.length === 0) {
                container.innerHTML = `<div class="text-center mt-20 text-slate-400 font-bold">ç„¡è³‡æ–™</div>`;
                return;
            }

            // ç”¢ç”Ÿ HTML
            container.innerHTML = data.map((c, index) => `
                <div id="card-${index}" class="glass-card p-4 flex items-center justify-between min-h-[90px] cursor-pointer" onclick="openPrintModal('${c.name}')">
                    <div class="flex items-center gap-3 shrink-0 pr-4 border-r border-slate-200/60">
                        <span class="text-3xl font-black text-gradient font-mono tracking-tighter w-[100px]">
                            ${c.code}
                        </span>
                    </div>
                    <div class="flex-1 flex items-center justify-between pl-4 overflow-hidden"> 
                        <h3 class="text-2xl font-bold text-slate-700 truncate">
                            ${c.name}
                        </h3>
                        <button onclick="event.stopPropagation(); openEditModal('${c.code}')" class="w-10 h-10 flex shrink-0 items-center justify-center rounded-full bg-slate-50 text-slate-300 hover:text-blue-500 active:scale-90 ml-1">
                            <svg class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                        </button>
                    </div>
                </div>
            `).join('');

            // å»ºç«‹å¿«å–ç´¢å¼•ï¼Œæœå°‹æ™‚ä¸ç”¨é‡æ–°è®€å– DOM
            customerElements = data.map((c, index) => ({
                el: document.getElementById(`card-${index}`),
                searchStr: (c.code + c.name).toLowerCase()
            }));
        }

        // â˜… æ¥µé€Ÿæœå°‹é‚è¼¯
        document.getElementById('searchInput').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            // ä¸é‡æ–°æ¸²æŸ“ HTMLï¼Œåªåˆ‡æ›é¡¯ç¤º/éš±è—ï¼Œé€Ÿåº¦æ¥µå¿«
            customerElements.forEach(item => {
                if (item.searchStr.includes(term)) {
                    item.el.style.display = '';
                } else {
                    item.el.style.display = 'none';
                }
            });
        });

        // ä»¥ä¸‹åŠŸèƒ½ä¿æŒä¸è®Š
        function openPrintModal(name) {
            currentPrintName = name;
            currentQty = 1; 
            document.getElementById('printName').innerText = name;
            updateInputDisplay();
            showModal('printModal');
        }
        function updateQty(delta) {
            let newQty = currentQty + delta;
            if(newQty < 1) newQty = 1;
            currentQty = newQty;
            updateInputDisplay();
        }
        function syncQty(val) {
            let parsed = parseInt(val);
            if(isNaN(parsed) || parsed < 1) parsed = 1;
            currentQty = parsed;
            updateInputDisplay();
        }
        function updateInputDisplay() {
            document.getElementById('printQtyInput').value = currentQty;
        }
        async function doPrint() {
            closeAllModals();
            showToast(`ğŸ–¨ï¸ åˆ—å° ${currentQty} å¼µ...`);
            try {
                await fetch('/api/print', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ customer_name: currentPrintName, copies: currentQty })
                });
            } catch(e) { showToast('å¤±æ•—'); }
        }
        function openEditModal(code) {
            const isEdit = !!code;
            document.getElementById('modalTitle').innerText = isEdit ? "ç·¨è¼¯" : "æ–°å¢";
            document.getElementById('btnDelete').classList.toggle('hidden', !isEdit);
            if(isEdit) {
                const c = customers.find(x => x.code === code);
                document.getElementById('inputCode').value = c.code;
                document.getElementById('inputName').value = c.name;
                document.getElementById('originalCode').value = c.code;
            } else {
                document.getElementById('inputCode').value = "";
                document.getElementById('inputName').value = "";
                document.getElementById('originalCode').value = "";
            }
            showModal('editModal');
            setTimeout(() => document.getElementById(isEdit ? 'inputName' : 'inputCode').focus(), 300);
        }
        async function saveCustomer() {
            const code = document.getElementById('inputCode').value.toUpperCase().trim();
            const name = document.getElementById('inputName').value.trim();
            const oldCode = document.getElementById('originalCode').value;
            if(!code || !name) return alert('è«‹è¼¸å…¥å…§å®¹');
            const isEdit = !!oldCode;
            const url = isEdit ? `/api/customers/${oldCode}` : '/api/customers';
            const method = isEdit ? 'PUT' : 'POST';
            try {
                const res = await fetch(url, {
                    method: method,
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ code, name })
                });
                if(res.ok) { closeAllModals(); fetchCustomers(); showToast('å·²å„²å­˜'); } 
                else { alert('ç·¨è™Ÿé‡è¤‡'); }
            } catch(e) { alert('éŒ¯èª¤'); }
        }
        async function deleteCurrent() {
            if(!confirm('åˆªé™¤?')) return;
            const code = document.getElementById('originalCode').value;
            await fetch(`/api/customers/${code}`, { method: 'DELETE' });
            closeAllModals(); fetchCustomers(); showToast('å·²åˆªé™¤');
        }
        function showModal(id) {
            document.getElementById('overlay').classList.remove('hidden');
            setTimeout(() => document.getElementById('overlay').classList.remove('opacity-0'), 10);
            document.getElementById(id).classList.remove('translate-y-full');
        }
        function closeAllModals() {
            document.getElementById('overlay').classList.add('opacity-0');
            setTimeout(() => document.getElementById('overlay').classList.add('hidden'), 300);
            ['printModal', 'editModal'].forEach(id => {
                document.getElementById(id).classList.add('translate-y-full');
            });
            document.activeElement.blur();
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            document.getElementById('toastMsg').innerText = msg;
            t.classList.remove('opacity-0');
            setTimeout(() => t.classList.add('opacity-0'), 2000);
        }
        init();
    </script>
</body>
</html>